<html><head><title>C4::Circulation::Fines</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../_whtpurk.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Sat May 27 06:07:03 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Getoverdues'>Getoverdues</a>
    <li class='indexItem indexItem2'><a href='#checkoverdues'>checkoverdues</a>
    <li class='indexItem indexItem2'><a href='#CalcFine'>CalcFine</a>
    <li class='indexItem indexItem2'><a href='#get_chargeable_units'>get_chargeable_units</a>
    <li class='indexItem indexItem2'><a href='#GetSpecialHolidays'>GetSpecialHolidays</a>
    <li class='indexItem indexItem2'><a href='#GetRepeatableHolidays'>GetRepeatableHolidays</a>
    <li class='indexItem indexItem2'><a href='#GetWayFromItemnumber'>GetWayFromItemnumber</a>
    <li class='indexItem indexItem2'><a href='#GetIssuesIteminfo'>GetIssuesIteminfo</a>
    <li class='indexItem indexItem2'><a href='#UpdateFine'>UpdateFine</a>
    <li class='indexItem indexItem2'><a href='#GetFine'>GetFine</a>
    <li class='indexItem indexItem2'><a href='#GetBranchcodesWithOverdueRules'>GetBranchcodesWithOverdueRules</a>
    <li class='indexItem indexItem2'><a href='#GetOverduesForBranch'>GetOverduesForBranch</a>
    <li class='indexItem indexItem2'><a href='#GetOverdueMessageTransportTypes'>GetOverdueMessageTransportTypes</a>
    <li class='indexItem indexItem2'><a href='#parse_overdues_letter'>parse_overdues_letter</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>C4::Circulation::Fines - Koha module dealing with fines</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>  use C4::Overdues;</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This module contains several functions for dealing with fines for overdue items. It is primarily used by the &#39;misc/fines2.pl&#39; script.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Getoverdues"
>Getoverdues</a></h2>

<pre>  $overdues = Getoverdues( { minimumdays =&#62; 1, maximumdays =&#62; 30 } );</pre>

<p>Returns the list of all overdue books, with their itemtype.</p>

<p><code>$overdues</code> is a reference-to-array. Each element is a reference-to-hash whose keys are the fields of the issues table in the Koha database.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="checkoverdues"
>checkoverdues</a></h2>

<pre>    ($count, $overdueitems) = checkoverdues($borrowernumber);</pre>

<p>Returns a count and a list of overdueitems for a given borrowernumber</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CalcFine"
>CalcFine</a></h2>

<pre>    ($amount, $units_minus_grace, $chargeable_units) = &#38;CalcFine($item,
                                  $categorycode, $branch,
                                  $start_dt, $end_dt );</pre>

<p>Calculates the fine for a book.</p>

<p>The issuingrules table in the Koha database is a fine matrix, listing the penalties for each type of patron for each type of item and each branch (e.g., the standard fine for books might be $0.50, but $1.50 for DVDs, or staff members might get a longer grace period between the first and second reminders that a book is overdue).</p>

<p><code>$item</code> is an item object (hashref).</p>

<p><code>$categorycode</code> is the category code (string) of the patron who currently has the book.</p>

<p><code>$branchcode</code> is the library (string) whose issuingrules govern this transaction.</p>

<p><code>$start_date</code> &#38; <code>$end_date</code> are DateTime objects defining the date range over which to determine the fine.</p>

<p>Fines scripts should just supply the date range over which to calculate the fine.</p>

<p><code>&#38;CalcFine</code> returns three values:</p>

<p><code>$amount</code> is the fine owed by the patron (see above).</p>

<p><code>$units_minus_grace</code> is the number of chargeable units minus the grace period</p>

<p><code>$chargeable_units</code> is the number of chargeable units (days between start and end dates, Calendar adjusted where needed, minus any applicable grace period, or hours)</p>

<p>FIXME: previously attempted to return <code>$message</code> as a text message, either &#34;First Notice&#34;, &#34;Second Notice&#34;, or &#34;Final Notice&#34;. But CalcFine never defined any value.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_chargeable_units"
>get_chargeable_units</a></h2>

<pre>    get_chargeable_units($unit, $start_date_ $end_date, $branchcode);</pre>

<p>return integer value of units between <code>$start_date</code> and <code>$end_date</code>, factoring in holidays for <code>$branchcode</code>.</p>

<p><code>$unit</code> is &#39;days&#39; or &#39;hours&#39; (default is &#39;days&#39;).</p>

<p><code>$start_date</code> and <code>$end_date</code> are the two DateTimes to get the number of units between.</p>

<p><code>$branchcode</code> is the branch whose calendar to use for finding holidays.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetSpecialHolidays"
>GetSpecialHolidays</a></h2>

<pre>    &#38;GetSpecialHolidays($date_dues,$itemnumber);</pre>

<p>return number of special days between date of the day and date due</p>

<p><code>$date_dues</code> is the envisaged date of book return.</p>

<p><code>$itemnumber</code> is the book&#39;s item number.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetRepeatableHolidays"
>GetRepeatableHolidays</a></h2>

<pre>    &#38;GetRepeatableHolidays($date_dues, $itemnumber, $difference,);</pre>

<p>return number of day closed between date of the day and date due</p>

<p><code>$date_dues</code> is the envisaged date of book return.</p>

<p><code>$itemnumber</code> is item number.</p>

<p><code>$difference</code> numbers of between day date of the day and date due</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetWayFromItemnumber"
>GetWayFromItemnumber</a></h2>

<pre>    &#38;Getwdayfromitemnumber($itemnumber);</pre>

<p>return the different week day from repeatable_holidays table</p>

<p><code>$itemnumber</code> is item number.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetIssuesIteminfo"
>GetIssuesIteminfo</a></h2>

<pre>    &#38;GetIssuesIteminfo($itemnumber);</pre>

<p>return all data from issues about item</p>

<p><code>$itemnumber</code> is item number.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="UpdateFine"
>UpdateFine</a></h2>

<pre>    &#38;UpdateFine(
        {
            issue_id       =&#62; $issue_id,
            itemnumber     =&#62; $itemnumber,
            borrowernumber =&#62; $borrowernumber,
            amount         =&#62; $amount,
            due            =&#62; $date_due
        }
    );</pre>

<p>(Note: the following is mostly conjecture and guesswork.)</p>

<p>Updates the fine owed on an overdue book.</p>

<p><code>$itemnumber</code> is the book&#39;s item number.</p>

<p><code>$borrowernumber</code> is the borrower number of the patron who currently has the book on loan.</p>

<p><code>$amount</code> is the current amount owed by the patron.</p>

<p><code>$due</code> is the date</p>

<p><code>&#38;UpdateFine</code> looks up the amount currently owed on the given item and sets it to <code>$amount</code>, creating, if necessary, a new entry in the accountlines table of the Koha database.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetFine"
>GetFine</a></h2>

<pre>    $data-&#62;{&#39;sum(amountoutstanding)&#39;} = &#38;GetFine($itemnum,$borrowernumber);</pre>

<p>return the total of fine</p>

<p><code>$itemnum</code> is item number</p>

<p><code>$borrowernumber</code> is the borrowernumber</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetBranchcodesWithOverdueRules"
>GetBranchcodesWithOverdueRules</a></h2>

<pre>    my @branchcodes = C4::Overdues::GetBranchcodesWithOverdueRules()</pre>

<p>returns a list of branch codes for branches with overdue rules defined.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetOverduesForBranch"
>GetOverduesForBranch</a></h2>

<p>Sql request for display all information for branchoverdues.pl 2 possibilities : with or without location . display is filtered by branch</p>

<p>FIXME: This function should be renamed.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetOverdueMessageTransportTypes"
>GetOverdueMessageTransportTypes</a></h2>

<pre>    my $message_transport_types = GetOverdueMessageTransportTypes( $branchcode, $categorycode, $letternumber);

    return a arrayref with all message_transport_type for given branchcode, categorycode and letternumber(1,2 or 3)</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="parse_overdues_letter"
>parse_overdues_letter</a></h2>

<p>parses the letter template, replacing the placeholders with data specific to this patron, biblio, or item for overdues</p>

<p>named parameters: letter - required hashref borrowernumber - required integer substitute - optional hashref of other key/value pairs that should be substituted in the letter content</p>

<p>returns the <code>letter</code> hashref, with the content updated to reflect the substituted keys and values.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Koha Development Team &#60;http://koha-community.org/&#62;</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
