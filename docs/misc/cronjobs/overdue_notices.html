<html><head><title>overdue_notices.pl</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../../_whtpurk.css" media="all" >

<script type="text/javascript" src="../../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Tue Dec 24 18:06:29 2024 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#OPTIONS'>OPTIONS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Configuration'>Configuration</a>
    <li class='indexItem indexItem2'><a href='#Outgoing_emails'>Outgoing emails</a>
    <li class='indexItem indexItem2'><a href='#Templates'>Templates</a>
    <li class='indexItem indexItem2'><a href='#CSV_output'>CSV output</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#USAGE_EXAMPLES'>USAGE EXAMPLES</a>
  <li class='indexItem indexItem1'><a href='#SEE_ALSO'>SEE ALSO</a>
  <li class='indexItem indexItem1'><a href='#INTERNAL_METHODS'>INTERNAL METHODS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#prepare_letter_for_printing'>prepare_letter_for_printing</a>
    <li class='indexItem indexItem2'><a href='#_get_html_start'>_get_html_start</a>
    <li class='indexItem indexItem2'><a href='#_get_html_end'>_get_html_end</a>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>overdue_notices.pl - prepare messages to be sent to patrons for overdue items</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p>overdue_notices.pl [ -n ][ --library &#60;branchcode&#62; ][ --library &#60;branchcode&#62; ...
] [ --max &#60;number of days&#62; ][ --csv [&#60;filename&#62;] ][ --itemscontent &#60;field list&#62; ] [ --email &#60;email_type&#62; ...
]</p>

<pre> Options:
   --help                          Brief help message.
   --man                           Full documentation.
   --verbose | -v                  Verbose mode. Can be repeated for increased output
   --nomail | -n                   No email will be sent.
   --max          &#60;days&#62;           Maximum days overdue to deal with.
   --library      &#60;branchcode&#62;     Only deal with overdues from this library.
                                   (repeatable : several libraries can be given)
   --csv          &#60;filename&#62;       Populate CSV file.
   --html         &#60;directory&#62;      Output html to a file in the given directory.
   --text         &#60;directory&#62;      Output plain text to a file in the given directory.
   --itemscontent &#60;list of fields&#62; Item information in templates.
   --borcat       &#60;categorycode&#62;   Category code that must be included.
   --borcatout    &#60;categorycode&#62;   Category code that must be excluded.
   --triggered | -t                Only include triggered overdues.
   --test                          Run in test mode. No changes will be made on the DB.
   --list-all                      List all overdues.
   --date         &#60;yyyy-mm-dd&#62;     Emulate overdues run for this date.
   --email        &#60;email_type&#62;     Type of email that will be used.
                                   Can be &#39;email&#39;, &#39;emailpro&#39; or &#39;B_email&#39;. Repeatable.
   --frombranch                    Organize and send overdue notices by home library (item-homebranch) or checkout library (item-issuebranch) or patron home library (patron-homebranch).
                                   This option is only used, if the OverdueNoticeFrom system preference is set to &#39;command-line option&#39;.
                                   Defaults to item-issuebranch.</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="OPTIONS"
>OPTIONS</a></h1>

<dl>
<dt><a name="--help"
><b>--help</b></a></dt>

<dd>
<p>Print a brief help message and exits.</p>

<dt><a name="--man"
><b>--man</b></a></dt>

<dd>
<p>Prints the manual page and exits.</p>

<dt><a name="-v_|_--verbose"
><b>-v</b> | <b>--verbose</b></a></dt>

<dd>
<p>Verbose. Without this flag set, only fatal errors are reported. A single &#39;v&#39; will report info on branches, letter codes, and patrons. A second &#39;v&#39; will report The SQL code used to search for triggered patrons.</p>

<dt><a name="-n_|_--nomail"
><b>-n</b> | <b>--nomail</b></a></dt>

<dd>
<p>Do not send any email. Overdue notices that would have been sent to the patrons or to the admin are printed to standard out. CSV data (if the --csv flag is set) is written to standard out or to any csv filename given.</p>

<dt><a name="--max"
><b>--max</b></a></dt>

<dd>
<p>Items older than max days are assumed to be handled somewhere else, probably the <em>longoverdues.pl</em> script. They are therefore ignored by this program. No notices are sent for them, and they are not added to any CSV files. Defaults to 90 to match <em>longoverdues.pl</em>.</p>

<dt><a name="--library"
><b>--library</b></a></dt>

<dd>
<p>select overdues for one specific library. Use the value in the branches.branchcode table. This option can be repeated in order to select overdues for a group of libraries.</p>

<dt><a name="--csv"
><b>--csv</b></a></dt>

<dd>
<p>Produces CSV data. if -n (no mail) flag is set, then this CSV data is sent to standard out or to a filename if provided. Otherwise, only overdues that could not be emailed are sent in CSV format to the admin.</p>

<dt><a name="--html"
><b>--html</b></a></dt>

<dd>
<p>Produces html data. If patron does not have an email address or -n (no mail) flag is set, an HTML file is generated in the specified directory. This can be downloaded or further processed by library staff. The file will be called notices-YYYY-MM-DD.html and placed in the directory specified.</p>

<dt><a name="--text"
><b>--text</b></a></dt>

<dd>
<p>Produces plain text data. If patron does not have an email address or -n (no mail) flag is set, a text file is generated in the specified directory. This can be downloaded or further processed by library staff. The file will be called notices-YYYY-MM-DD.txt and placed in the directory specified.</p>

<dt><a name="--itemscontent"
><b>--itemscontent</b></a></dt>

<dd>
<p>comma separated list of fields that get substituted into templates in places of the &#60;&#60;items.content&#62;&#62; placeholder. This defaults to due date,title,barcode,author</p>

<p>Other possible values come from fields in the biblios, items and issues tables.</p>

<dt><a name="--borcat"
><b>--borcat</b></a></dt>

<dd>
<p>Repeatable field, that permits to select only some patron categories.</p>

<dt><a name="--borcatout"
><b>--borcatout</b></a></dt>

<dd>
<p>Repeatable field, that permits to exclude some patron categories.</p>

<dt><a name="-t_|_--triggered"
><b>-t</b> | <b>--triggered</b></a></dt>

<dd>
<p>This option causes a notice to be generated if and only if an item is overdue by the number of days defined in a notice trigger.</p>

<p>By default, a notice is sent each time the script runs, which is suitable for less frequent run cron script, but requires syncing notice triggers with the cron schedule to ensure proper behavior. Add the --triggered option for daily cron, at the risk of no notice being generated if the cron fails to run on time.</p>

<dt><a name="--test"
><b>--test</b></a></dt>

<dd>
<p>This option makes the script run in test mode.</p>

<p>In test mode, the script won&#39;t make any changes on the DB. This is useful for debugging configuration.</p>

<dt><a name="--list-all"
><b>--list-all</b></a></dt>

<dd>
<p>Default items.content lists only those items that fall in the range of the currently processing notice. Choose --list-all to include all overdue items in the list (limited by <b>--max</b> setting).</p>

<dt><a name="--date"
><b>--date</b></a></dt>

<dd>
<p>use it in order to send overdues on a specific date and not Now. Format: YYYY-MM-DD.</p>

<dt><a name="--email"
><b>--email</b></a></dt>

<dd>
<p>Allows to specify which type of email will be used. Can be email, emailpro or B_email. Repeatable.</p>

<dt><a name="--frombranch"
><b>--frombranch</b></a></dt>

<dd>
<p>Organize overdue notices either by checkout library (item-issuebranch) or item home library (item-homebranch) or patron home library (patron-homebranch). This option is only used, if the OverdueNoticeFrom system preference is set to use &#39;command-line option&#39;. Defaults to checkout library (item-issuebranch).</p>
</dd>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This script is designed to alert patrons and administrators of overdue items.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Configuration"
>Configuration</a></h2>

<p>This script pays attention to the overdue notice configuration performed in the &#34;Overdue notice/status triggers&#34; section of the &#34;Tools&#34; area of the staff interface to Koha. There, you can choose which letter templates are sent out after a configurable number of days to patrons of each library. More information about the use of this section of Koha is available in the Koha manual.</p>

<p>The templates used to craft the emails are defined in the &#34;Tools: Notices&#34; section of the staff interface to Koha.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Outgoing_emails"
>Outgoing emails</a></h2>

<p>Typically, messages are prepared for each patron with overdue items. Messages for whom there is no email address on file are collected and sent as attachments in a single email to each library administrator, or if that is not set, then to the email address in the <code>KohaAdminEmailAddress</code> system preference.</p>

<p>These emails are staged in the outgoing message queue, as are messages produced by other features of Koha. This message queue must be processed regularly by the <em>misc/cronjobs/process_message_queue.pl</em> program.</p>

<p>In the event that the <code>-n</code> flag is passed to this program, no emails are sent. Instead, messages are sent on standard output from this program. They may be redirected to a file if desired.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Templates"
>Templates</a></h2>

<p>Templates can contain variables enclosed in double angle brackets like &#60;&#60;this&#62;&#62;. Those variables will be replaced with values specific to the overdue items or relevant patron. Available variables are:</p>

<dl>
<dt><a name="&#60;&#60;bib&#62;&#62;"
>&#60;&#60;bib&#62;&#62;</a></dt>

<dd>
<p>the name of the library</p>

<dt><a name="&#60;&#60;items.content&#62;&#62;"
>&#60;&#60;items.content&#62;&#62;</a></dt>

<dd>
<p>one line for each item, each line containing a tab separated list of title, author, barcode, issuedate</p>

<dt><a name="&#60;&#60;borrowers.*&#62;&#62;"
>&#60;&#60;borrowers.*&#62;&#62;</a></dt>

<dd>
<p>any field from the borrowers table</p>

<dt><a name="&#60;&#60;branches.*&#62;&#62;"
>&#60;&#60;branches.*&#62;&#62;</a></dt>

<dd>
<p>any field from the branches table</p>
</dd>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CSV_output"
>CSV output</a></h2>

<p>The <code>-csv</code> command line option lets you specify a file to which overdues data should be output in CSV format.</p>

<p>With the <code>-n</code> flag set, data about all overdues is written to the file. Without that flag, only information about overdues that were unable to be sent directly to the patrons will be written. In other words, this CSV file replaces the data that is typically sent to the administrator email address.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="USAGE_EXAMPLES"
>USAGE EXAMPLES</a></h1>

<p><code>overdue_notices.pl</code> - In this most basic usage, with no command line arguments, all libraries are processed individually, and notices are prepared for all patrons with overdue items for whom we have email addresses. Messages for those patrons for whom we have no email address are sent in a single attachment to the library administrator&#39;s email address, or to the address in the KohaAdminEmailAddress system preference.</p>

<p><code>overdue_notices.pl -n --csv /tmp/overdues.csv</code> - sends no email and populates <em>/tmp/overdues.csv</em> with information about all overdue items.</p>

<p><code>overdue_notices.pl --library MAIN max 14</code> - prepare notices of overdues in the last 2 weeks for the MAIN library.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SEE_ALSO"
>SEE ALSO</a></h1>

<p>The <em>misc/cronjobs/advance_notices.pl</em> program allows you to send messages to patrons in advance of their items becoming due, or to alert them of items that have just become due.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="INTERNAL_METHODS"
>INTERNAL METHODS</a></h1>

<p>These methods are internal to the operation of overdue_notices.pl.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="prepare_letter_for_printing"
>prepare_letter_for_printing</a></h2>

<p>returns a string of text appropriate for printing in the event that an overdue notice will not be sent to the patron&#39;s email address. Depending on the desired output format, this may be a CSV string, or a human-readable representation of the notice.</p>

<p>required parameters: letter borrowernumber</p>

<p>optional parameters: outputformat</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_get_html_start"
>_get_html_start</a></h2>

<p>Return the start of a HTML document, including html, head and the start body tags. This should be usable both in the HTML file written to disc, and in the attachment.html sent as email.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_get_html_end"
>_get_html_end</a></h2>

<p>Return the end of an HTML document, namely the closing body and html tags.</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
