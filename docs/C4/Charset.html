<html><head><title>C4::Charset</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Sun Jan 12 06:06:30 2025 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#IsStringUTF8ish'>IsStringUTF8ish</a>
    <li class='indexItem indexItem2'><a href='#SetUTF8Flag'>SetUTF8Flag</a>
    <li class='indexItem indexItem2'><a href='#NormalizeString'>NormalizeString</a>
    <li class='indexItem indexItem2'><a href='#MarcToUTF8Record'>MarcToUTF8Record</a>
    <li class='indexItem indexItem2'><a href='#SetMarcUnicodeFlag'>SetMarcUnicodeFlag</a>
    <li class='indexItem indexItem2'><a href='#StripNonXmlChars'>StripNonXmlChars</a>
    <li class='indexItem indexItem2'><a href='#nsb_clean'>nsb_clean</a>
    <li class='indexItem indexItem2'><a href='#SanitizeRecord'>SanitizeRecord</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#INTERNAL_FUNCTIONS'>INTERNAL FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#_default_marc21_charconv_to_utf8'>_default_marc21_charconv_to_utf8</a>
    <li class='indexItem indexItem2'><a href='#_default_unimarc_charconv_to_utf8'>_default_unimarc_charconv_to_utf8</a>
    <li class='indexItem indexItem2'><a href='#_marc_marc8_to_utf8'>_marc_marc8_to_utf8</a>
    <li class='indexItem indexItem2'><a href='#_marc_iso5426_to_utf8'>_marc_iso5426_to_utf8</a>
    <li class='indexItem indexItem2'><a href='#_marc_to_utf8_via_text_iconv'>_marc_to_utf8_via_text_iconv</a>
    <li class='indexItem indexItem2'><a href='#_marc_to_utf8_replacement_char'>_marc_to_utf8_replacement_char</a>
    <li class='indexItem indexItem2'><a href='#char_decode5426'>char_decode5426</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>C4::Charset - utilities for handling character set conversions.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>  use C4::Charset;</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This module contains routines for dealing with character set conversions, particularly for MARC records.</p>

<p>A variety of character encodings are in use by various MARC standards, and even more character encodings are used by non-standard MARC records. The various MARC formats generally do not do a good job of advertising a given record&#39;s character encoding, and even when a record does advertise its encoding, e.g., via the Leader/09, experience has shown that one cannot trust it.</p>

<p>Ultimately, all MARC records are stored in Koha in UTF-8 and must be converted from whatever the source character encoding is. The goal of this module is to ensure that these conversions take place accurately. When a character conversion cannot take place, or at least not accurately, the module was provide enough information to allow user-facing code to inform the user on how to deal with the situation.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="IsStringUTF8ish"
>IsStringUTF8ish</a></h2>

<pre>  my $is_utf8 = IsStringUTF8ish($str);</pre>

<p>Determines if <code>$str</code> is valid UTF-8. This can mean one of two things:</p>

<ul>
<li>The Perl UTF-8 flag is set and the string contains valid UTF-8.</li>

<li>The Perl UTF-8 flag is <b>not</b> set, but the octets contain valid UTF-8.</li>
</ul>

<p>The function is named <code>IsStringUTF8ish</code> instead of <code>IsStringUTF8</code> because in one could be presented with a MARC blob that is not actually in UTF-8 but whose sequence of octets appears to be valid UTF-8. The rest of the MARC character conversion functions will assume that this situation occur does not very often.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="SetUTF8Flag"
>SetUTF8Flag</a></h2>

<pre>  my $marc_record = SetUTF8Flag($marc_record, $nfd);</pre>

<p>This function sets the PERL UTF8 flag for data. It is required when using new_from_usmarc since MARC::File::USMARC does not handle PERL UTF8 setting. When editing unicode marc records fields and subfields, you would end up in double encoding without using this function.</p>

<p>If $nfd is set, string normalization will use NFD instead of NFC</p>

<p>FIXME In my opinion, this function belongs to MARC::Record and not to this package. But since it handles charset, and MARC::Record, it finds its way in that package</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="NormalizeString"
>NormalizeString</a></h2>

<pre>    my $normalized_string=NormalizeString($string,$nfd,$transform);</pre>

<p>Given a string nfd : If you want to set NFD and not NFC transform : If you expect all the signs to be removed</p>

<p>Sets the PERL UTF8 Flag on your initial data if need be and applies cleaning if required</p>

<p>Returns a utf8 NFC normalized string</p>

<p>Sample code : my $string=NormalizeString (&#34;l&#39;ornithopt&#232;re&#34;); #results into ornithopt&#232;re in NFC form and sets UTF8 Flag</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="MarcToUTF8Record"
>MarcToUTF8Record</a></h2>

<pre>  ($marc_record, $converted_from, $errors_arrayref) = MarcToUTF8Record($marc_blob, 
                                        $marc_flavour, [, $source_encoding]);</pre>

<p>Given a MARC blob or a <code>MARC::Record</code>, the MARC flavour, and an optional source encoding, return a <code>MARC::Record</code> that is converted to UTF-8.</p>

<p>The returned <code>$marc_record</code> is guaranteed to be in valid UTF-8, but is not guaranteed to have been converted correctly. Specifically, if <code>$converted_from</code> is &#39;failed&#39;, the MARC record returned failed character conversion and had each of its non-ASCII octets changed to the Unicode replacement character.</p>

<p>If the source encoding was not specified, this routine will try to guess it; the character encoding used for a successful conversion is returned in <code>$converted_from</code>.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="SetMarcUnicodeFlag"
>SetMarcUnicodeFlag</a></h2>

<pre>  SetMarcUnicodeFlag($marc_record, $marc_flavour);</pre>

<p>Set both the internal MARC::Record encoding flag and the appropriate Leader/09 (MARC21) or 100/26-29 (UNIMARC) to indicate that the record is in UTF-8. Note that this does <b>not</b> do any actual character conversion.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="StripNonXmlChars"
>StripNonXmlChars</a></h2>

<pre>  my $new_str = StripNonXmlChars($old_str);</pre>

<p>Given a string, return a copy with the characters that are illegal in XML removed.</p>

<p>This function exists to work around a problem that can occur with badly-encoded MARC records. Specifically, if a UTF-8 MARC record also has excape (\x1b) characters, MARC::File::XML will let the escape characters pass through when as_xml() or as_xml_record() is called. The problem is that the escape character is not legal in well-formed XML documents, so when MARC::File::XML attempts to parse such a record, the XML parser will fail.</p>

<p>Stripping such characters will allow a MARC::Record-&#62;new_from_xml() to work, at the possible risk of some data loss.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="nsb_clean"
>nsb_clean</a></h2>

<blockquote>
<p>nsb_clean($string);</p>
</blockquote>

<p>Removes Non Sorting Block characters</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="SanitizeRecord"
>SanitizeRecord</a></h2>

<p>SanitizeRecord($marcrecord);</p>

<p>Sanitize a record This routine is called in the maintenance script misc/maintenance/sanitize_records.pl. It cleans any string with &#39;&#38;amp;amp;...&#39;, replacing it by &#39;&#38;&#39;</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="INTERNAL_FUNCTIONS"
>INTERNAL FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_default_marc21_charconv_to_utf8"
>_default_marc21_charconv_to_utf8</a></h2>

<pre>  my ($new_marc_record, $guessed_charset) = _default_marc21_charconv_to_utf8($marc_record);</pre>

<p>Converts a <code>MARC::Record</code> of unknown character set to UTF-8, first by trying a MARC-8 to UTF-8 conversion, then ISO-8859-1 to UTF-8, then a default conversion that replaces each non-ASCII character with the replacement character.</p>

<p>The <code>$guessed_charset</code> return value contains the character set that resulted in a conversion to valid UTF-8; note that if the MARC-8 and ISO-8859-1 conversions failed, the value of this is &#39;failed&#39;.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_default_unimarc_charconv_to_utf8"
>_default_unimarc_charconv_to_utf8</a></h2>

<pre>  my ($new_marc_record, $guessed_charset) = _default_unimarc_charconv_to_utf8($marc_record);</pre>

<p>Converts a <code>MARC::Record</code> of unknown character set to UTF-8, first by trying a ISO-5426 to UTF-8 conversion, then ISO-8859-1 to UTF-8, then a default conversion that replaces each non-ASCII character with the replacement character.</p>

<p>The <code>$guessed_charset</code> return value contains the character set that resulted in a conversion to valid UTF-8; note that if the MARC-8 and ISO-8859-1 conversions failed, the value of this is &#39;failed&#39;.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_marc_marc8_to_utf8"
>_marc_marc8_to_utf8</a></h2>

<pre>  my @errors = _marc_marc8_to_utf8($marc_record, $marc_flavour, $source_encoding);</pre>

<p>Convert a <code>MARC::Record</code> to UTF-8 in-place from MARC-8. If the conversion fails for some reason, an appropriate messages will be placed in the returned <code>@errors</code> array.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_marc_iso5426_to_utf8"
>_marc_iso5426_to_utf8</a></h2>

<pre>  my @errors = _marc_iso5426_to_utf8($marc_record, $marc_flavour, $source_encoding);</pre>

<p>Convert a <code>MARC::Record</code> to UTF-8 in-place from ISO-5426. If the conversion fails for some reason, an appropriate messages will be placed in the returned <code>@errors</code> array.</p>

<p>FIXME - is ISO-5426 equivalent enough to MARC-8 that <code>MARC::Charset</code> can be used instead?</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_marc_to_utf8_via_text_iconv"
>_marc_to_utf8_via_text_iconv</a></h2>

<pre>  my @errors = _marc_to_utf8_via_text_iconv($marc_record, $marc_flavour, $source_encoding);</pre>

<p>Convert a <code>MARC::Record</code> to UTF-8 in-place using the <code>Text::Iconv</code> CPAN module. Any source encoding accepted by the user&#39;s iconv installation should work. If the source encoding is not recognized on the user&#39;s server or the conversion fails for some reason, appropriate messages will be placed in the returned <code>@errors</code> array.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_marc_to_utf8_replacement_char"
>_marc_to_utf8_replacement_char</a></h2>

<pre>  _marc_to_utf8_replacement_char($marc_record, $marc_flavour);</pre>

<p>Convert a <code>MARC::Record</code> to UTF-8 in-place, adopting the unsatisfactory method of replacing all non-ASCII (e.g., where the eight bit is set) octet with the Unicode replacement character. This is meant as a last-ditch method, and would be best used as part of a UI that lets a cataloguer pick various character conversions until they find the right one.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="char_decode5426"
>char_decode5426</a></h2>

<pre>  my $utf8string = char_decode5426($iso_5426_string);</pre>

<p>Converts a string from ISO-5426 to UTF-8.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Koha Development Team &#60;http://koha-community.org/&#62;</p>

<p>Galen Charlton &#60;galen.charlton@liblime.com&#62;</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
