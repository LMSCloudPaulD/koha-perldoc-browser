<html><head><title>C4::Items</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Sat Sep  2 18:11:54 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#HISTORICAL_NOTE'>HISTORICAL NOTE</a>
  <li class='indexItem indexItem1'><a href='#CORE_EXPORTED_FUNCTIONS'>CORE EXPORTED FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#CartToShelf'>CartToShelf</a>
    <li class='indexItem indexItem2'><a href='#AddItemFromMarc'>AddItemFromMarc</a>
    <li class='indexItem indexItem2'><a href='#AddItemBatchFromMarc'>AddItemBatchFromMarc</a>
    <li class='indexItem indexItem2'><a href='#ModItemFromMarc'>ModItemFromMarc</a>
    <li class='indexItem indexItem2'><a href='#ModItemTransfer'>ModItemTransfer</a>
    <li class='indexItem indexItem2'><a href='#ModDateLastSeen'>ModDateLastSeen</a>
    <li class='indexItem indexItem2'><a href='#CheckItemPreSave'>CheckItemPreSave</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#EXPORTED_SPECIAL_ACCESSOR_FUNCTIONS'>EXPORTED SPECIAL ACCESSOR FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#GetItemsForInventory'>GetItemsForInventory</a>
    <li class='indexItem indexItem2'><a href='#get_hostitemnumbers_of'>get_hostitemnumbers_of</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#LIMITED_USE_FUNCTIONS'>LIMITED USE FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#GetMarcItem'>GetMarcItem</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#PRIVATE_FUNCTIONS_AND_VARIABLES'>PRIVATE FUNCTIONS AND VARIABLES</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#_marc_from_item_hash'>_marc_from_item_hash</a>
    <li class='indexItem indexItem2'><a href='#_repack_item_errors'>_repack_item_errors</a>
    <li class='indexItem indexItem2'><a href='#_get_unlinked_item_subfields'>_get_unlinked_item_subfields</a>
    <li class='indexItem indexItem2'><a href='#_get_unlinked_subfields_xml'>_get_unlinked_subfields_xml</a>
    <li class='indexItem indexItem2'><a href='#_parse_unlinked_item_subfields_from_xml'>_parse_unlinked_item_subfields_from_xml</a>
    <li class='indexItem indexItem2'><a href='#GetAnalyticsCount'>GetAnalyticsCount</a>
    <li class='indexItem indexItem2'><a href='#SearchItems'>SearchItems</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#OTHER_FUNCTIONS'>OTHER FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#_find_value'>_find_value</a>
    <li class='indexItem indexItem2'><a href='#PrepareItemrecordDisplay'>PrepareItemrecordDisplay</a>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>C4::Items - item management functions</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This module contains an API for manipulating item records in Koha,
and is used by cataloguing,
circulation,
acquisitions,
and serials management.</p>

<p># FIXME This POD is not up-to-date A Koha item record is stored in two places: the items table and embedded in a MARC tag in the XML version of the associated bib record in <code>biblioitems.marcxml</code>.
This is done to allow the item information to be readily indexed (e.g.,
by Zebra),
but means that each item modification transaction must keep the items table and the MARC XML in sync at all times.</p>

<p>The items table will be considered authoritative.
In other words,
if there is ever a discrepancy between the items table and the MARC XML,
the items table should be considered accurate.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="HISTORICAL_NOTE"
>HISTORICAL NOTE</a></h1>

<p>Most of the functions in <code>C4::Items</code> were originally in the <code>C4::Biblio</code> module.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="CORE_EXPORTED_FUNCTIONS"
>CORE EXPORTED FUNCTIONS</a></h1>

<p>The following functions are meant for use by users of <code>C4::Items</code></p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CartToShelf"
>CartToShelf</a></h2>

<pre>  CartToShelf($itemnumber);</pre>

<p>Set the current shelving location of the item record to its stored permanent shelving location. This is primarily used to indicate when an item whose current location is a special processing (&#39;PROC&#39;) or shelving cart (&#39;CART&#39;) location is back in the stacks.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="AddItemFromMarc"
>AddItemFromMarc</a></h2>

<pre>  my ($biblionumber, $biblioitemnumber, $itemnumber) 
      = AddItemFromMarc($source_item_marc, $biblionumber[, $params]);</pre>

<p>Given a MARC::Record object containing an embedded item record and a biblionumber, create a new item record.</p>

<p>The final optional parameter, <code>$params</code>, may contain &#39;skip_record_index&#39; key, which relayed down to Koha::Item/store, there it prevents calling of index_records, which takes most of the time in batch adds/deletes: index_records to be called later in <code>additem.pl</code> after the whole loop.</p>

<p>You may also optionally pass biblioitemnumber in the params hash to boost performance of inserts by preventing a lookup in Koha::Item.</p>

<p>$params: skip_record_index =&#62; 1|0 biblioitemnumber =&#62; $biblioitemnumber</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="AddItemBatchFromMarc"
>AddItemBatchFromMarc</a></h2>

<pre>  ($itemnumber_ref, $error_ref) = AddItemBatchFromMarc($record, 
             $biblionumber, $biblioitemnumber, $frameworkcode);</pre>

<p>Efficiently create item records from a MARC biblio record with embedded item fields. This routine is suitable for batch jobs.</p>

<p>This API assumes that the bib record has already been saved to the <code>biblio</code> and <code>biblioitems</code> tables. It does not expect that <code>biblio_metadata.metadata</code> is populated, but it will do so via a call to ModBibiloMarc.</p>

<p>The goal of this API is to have a similar effect to using AddBiblio and AddItems in succession, but without inefficient repeated parsing of the MARC XML bib record.</p>

<p>This function returns an arrayref of new itemsnumbers and an arrayref of item errors encountered during the processing. Each entry in the errors list is a hashref containing the following keys:</p>

<dl>
<dt><a name="item_sequence"
>item_sequence</a></dt>

<dd>
<p>Sequence number of original item tag in the MARC record.</p>

<dt><a name="item_barcode"
>item_barcode</a></dt>

<dd>
<p>Item barcode, provide to assist in the construction of useful error messages.</p>

<dt><a name="error_code"
>error_code</a></dt>

<dd>
<p>Code representing the error condition. Can be &#39;duplicate_barcode&#39;, &#39;invalid_homebranch&#39;, or &#39;invalid_holdingbranch&#39;.</p>

<dt><a name="error_information"
>error_information</a></dt>

<dd>
<p>Additional information appropriate to the error condition.</p>
</dd>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ModItemFromMarc"
>ModItemFromMarc</a></h2>

<p>my $item = ModItemFromMarc($item_marc, $biblionumber, $itemnumber[, $params]);</p>

<p>The final optional parameter, <code>$params</code>, expected to contain &#39;skip_record_index&#39; key, which relayed down to Koha::Item/store, there it prevents calling of index_records, which takes most of the time in batch adds/deletes: index_records better to be called later in <code>additem.pl</code> after the whole loop.</p>

<p>$params: skip_record_index =&#62; 1|0</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ModItemTransfer"
>ModItemTransfer</a></h2>

<pre>  ModItemTransfer($itemnumber, $frombranch, $tobranch, $trigger, [$params]);</pre>

<p>Marks an item as being transferred from one branch to another and records the trigger.</p>

<p>The last optional parameter allows for passing skip_record_index through to the items store call.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ModDateLastSeen"
>ModDateLastSeen</a></h2>

<p>ModDateLastSeen( $itemnumber, $leave_item_lost, $params );</p>

<p>Mark item as seen. Is called when an item is issued, returned or manually marked during inventory/stocktaking. <code>$itemnumber</code> is the item number <code>$leave_item_lost</code> determines if a lost item will be found or remain lost</p>

<p>The last optional parameter allows for passing skip_record_index through to the items store call.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CheckItemPreSave"
>CheckItemPreSave</a></h2>

<pre>    my $item_ref = TransformMarcToKoha({ record =&#62; $marc, limit_table =&#62; &#39;items&#39; });
    # do stuff
    my %errors = CheckItemPreSave($item_ref);
    if (exists $errors{&#39;duplicate_barcode&#39;}) {
        print &#34;item has duplicate barcode: &#34;, $errors{&#39;duplicate_barcode&#39;}, &#34;\n&#34;;
    } elsif (exists $errors{&#39;invalid_homebranch&#39;}) {
        print &#34;item has invalid home branch: &#34;, $errors{&#39;invalid_homebranch&#39;}, &#34;\n&#34;;
    } elsif (exists $errors{&#39;invalid_holdingbranch&#39;}) {
        print &#34;item has invalid holding branch: &#34;, $errors{&#39;invalid_holdingbranch&#39;}, &#34;\n&#34;;
    } else {
        print &#34;item is OK&#34;;
    }</pre>

<p>Given a hashref containing item fields, determine if it can be inserted or updated in the database. Specifically, checks for database integrity issues, and returns a hash containing any of the following keys, if applicable.</p>

<dl>
<dt><a name="duplicate_barcode"
>duplicate_barcode</a></dt>

<dd>
<p>Barcode, if it duplicates one already found in the database.</p>

<dt><a name="invalid_homebranch"
>invalid_homebranch</a></dt>

<dd>
<p>Home branch, if not defined in branches table.</p>

<dt><a name="invalid_holdingbranch"
>invalid_holdingbranch</a></dt>

<dd>
<p>Holding branch, if not defined in branches table.</p>
</dd>
</dl>

<p>This function does NOT implement any policy-related checks, e.g., whether current operator is allowed to save an item that has a given branch code.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="EXPORTED_SPECIAL_ACCESSOR_FUNCTIONS"
>EXPORTED SPECIAL ACCESSOR FUNCTIONS</a></h1>

<p>The following functions provide various ways of getting an item record, a set of item records, or lists of authorized values for certain item fields.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetItemsForInventory"
>GetItemsForInventory</a></h2>

<p>($itemlist, $iTotalRecords) = GetItemsForInventory( { minlocation =&#62; $minlocation, maxlocation =&#62; $maxlocation, location =&#62; $location, ignoreissued =&#62; $ignoreissued, datelastseen =&#62; $datelastseen, branchcode =&#62; $branchcode, branch =&#62; $branch, offset =&#62; $offset, size =&#62; $size, statushash =&#62; $statushash, itemtypes =&#62; \@itemsarray, } );</p>

<p>Retrieve a list of title/authors/barcode/callnumber, for biblio inventory.</p>

<p>The sub returns a reference to a list of hashes, each containing itemnumber, author, title, barcode, item callnumber, and date last seen. It is ordered by callnumber then title.</p>

<p>The required minlocation &#38; maxlocation parameters are used to specify a range of item callnumbers the datelastseen can be used to specify that you want to see items not seen since a past date only. offset &#38; size can be used to retrieve only a part of the whole listing (defaut behaviour) $statushash requires a hashref that has the authorized values fieldname (intems.notforloan, etc...) as keys, and an arrayref of statuscodes we are searching for as values.</p>

<p>$iTotalRecords is the number of rows that would have been returned without the $offset, $size limit clause</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_hostitemnumbers_of"
>get_hostitemnumbers_of</a></h2>

<pre>  my @itemnumbers_of = get_hostitemnumbers_of($biblionumber);</pre>

<p>Given a biblionumber, return the list of corresponding itemnumbers that are linked to it via host fields</p>

<p>Return a reference on a hash where key is a biblionumber and values are references on array of itemnumbers.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="LIMITED_USE_FUNCTIONS"
>LIMITED USE FUNCTIONS</a></h1>

<p>The following functions, while part of the public API, are not exported. This is generally because they are meant to be used by only one script for a specific purpose, and should not be used in any other context without careful thought.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMarcItem"
>GetMarcItem</a></h2>

<pre>  my $item_marc = GetMarcItem($biblionumber, $itemnumber);</pre>

<p>Returns MARC::Record of the item passed in parameter. This function is meant for use only in <code>cataloguing/additem.pl</code>, where it is needed to support that script&#39;s MARC-like editor.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="PRIVATE_FUNCTIONS_AND_VARIABLES"
>PRIVATE FUNCTIONS AND VARIABLES</a></h1>

<p>The following functions are not meant to be called directly, but are documented in order to explain the inner workings of <code>C4::Items</code>.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_marc_from_item_hash"
>_marc_from_item_hash</a></h2>

<pre>  my $item_marc = _marc_from_item_hash($item, $frameworkcode[, $unlinked_item_subfields]);</pre>

<p>Given an item hash representing a complete item record, create a <code>MARC::Record</code> object containing an embedded tag representing that item.</p>

<p>The third, optional parameter <code>$unlinked_item_subfields</code> is an arrayref of subfields (not mapped to <code>items</code> fields per the framework) to be added to the MARC representation of the item.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_repack_item_errors"
>_repack_item_errors</a></h2>

<p>Add an error message hash generated by <code>CheckItemPreSave</code> to a list of errors.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_get_unlinked_item_subfields"
>_get_unlinked_item_subfields</a></h2>

<pre>  my $unlinked_item_subfields = _get_unlinked_item_subfields($original_item_marc, $frameworkcode);</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_get_unlinked_subfields_xml"
>_get_unlinked_subfields_xml</a></h2>

<pre>  my $unlinked_subfields_xml = _get_unlinked_subfields_xml($unlinked_item_subfields);</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_parse_unlinked_item_subfields_from_xml"
>_parse_unlinked_item_subfields_from_xml</a></h2>

<pre>  my $unlinked_item_subfields = _parse_unlinked_item_subfields_from_xml($whole_item-&#62;{&#39;more_subfields_xml&#39;}):</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetAnalyticsCount"
>GetAnalyticsCount</a></h2>

<pre>  $count= &#38;GetAnalyticsCount($itemnumber)</pre>

<p>counts Usage of itemnumber in Analytical bibliorecords.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="SearchItems"
>SearchItems</a></h2>

<pre>    my ($items, $total) = SearchItems($filter, $params);</pre>

<p>Perform a search among items</p>

<p>$filter is a reference to a hash which can be a filter, or a combination of filters.</p>

<p>A filter has the following keys:</p>

<ul>
<li>field: the name of a SQL column in table items</li>

<li>query: the value to search in this column</li>

<li>operator: comparison operator. Can be one of = != &#62; &#60; &#62;= &#60;= like &#39;not like&#39; is</li>
</ul>

<p>A combination of filters hash the following keys:</p>

<ul>
<li>conjunction: &#39;AND&#39; or &#39;OR&#39;</li>

<li>filters: array ref of filters</li>
</ul>

<p>$params is a reference to a hash that can contain the following parameters:</p>

<ul>
<li>rows: Number of items to return. 0 returns everything (default: 0)</li>

<li>page: Page to return (return items from (page-1)*rows to (page*rows)-1) (default: 1)</li>

<li>sortby: A SQL column name in items table to sort on</li>

<li>sortorder: &#39;ASC&#39; or &#39;DESC&#39;</li>
</ul>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="OTHER_FUNCTIONS"
>OTHER FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_find_value"
>_find_value</a></h2>

<pre>  ($indicators, $value) = _find_value($tag, $subfield, $record,$encoding);</pre>

<p>Find the given $subfield in the given $tag in the given MARC::Record $record. If the subfield is found, returns the (indicators, value) pair; otherwise, (undef, undef) is returned.</p>

<p>PROPOSITION : Such a function is used in addbiblio AND additem and serial-edit and maybe could be used in Authorities. I suggest we export it from this module.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="PrepareItemrecordDisplay"
>PrepareItemrecordDisplay</a></h2>

<pre>  PrepareItemrecordDisplay($bibnum,$itemumber,$defaultvalues,$frameworkcode);</pre>

<p>Returns a hash with all the fields for Display a given item data in a template</p>

<p>$defaultvalues should either contain a hashref of values for the new item, or be undefined.</p>

<p>The $frameworkcode returns the item for the given frameworkcode, ONLY if bibnum is not provided</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
