<html><head><title>InstallAuth</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Thu Aug 15 00:16:48 2024 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#get_template_and_user'>get_template_and_user</a>
    <li class='indexItem indexItem2'><a href='#checkauth'>checkauth</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#SEE_ALSO'>SEE ALSO</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>InstallAuth - Authenticates Koha users for Install process</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>  use CGI qw ( -utf8 );
  use InstallAuth;
  use C4::Output;

  my $query = new CGI;

    my ( $template, $borrowernumber, $cookie ) = get_template_and_user(
        {   template_name   =&#62; &#34;opac-main.tt&#34;,
            query           =&#62; $query,
            type            =&#62; &#34;opac&#34;,
            authnotrequired =&#62; 1,
            flagsrequired   =&#62; { acquisition =&#62; &#39;*&#39; },
        }
    );

  output_html_with_http_headers $query, $cookie, $template-&#62;output;</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>The main function of this module is to provide authentification. However the get_template_and_user function has been provided so that a users login information is passed along automatically. This gets loaded into the template. This package is different from C4::Auth in so far as C4::Auth uses many preferences which are supposed NOT to be obtainable when installing the database.</p>

<p>As in C4::Auth, Authentication is based on cookies.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_template_and_user"
>get_template_and_user</a></h2>

<pre>    my ( $template, $borrowernumber, $cookie ) = get_template_and_user(
        {   template_name   =&#62; &#34;opac-main.tt&#34;,
            query           =&#62; $query,
            type            =&#62; &#34;opac&#34;,
            authnotrequired =&#62; 1,
            flagsrequired   =&#62; { acquisition =&#62; &#39;*&#39; },
        }
    );</pre>

<p>This call passes the <code>query</code>, <code>flagsrequired</code> and <code>authnotrequired</code> to <code>&#38;checkauth</code> (in this module) to perform authentification. See <code>&#38;checkauth</code> for an explanation of these parameters.</p>

<p>The <code>template_name</code> is then used to find the correct template for the page. The authenticated users details are loaded onto the template in the logged_in_user variable (which is a Koha::Patron object). Also the <code>sessionID</code> is passed to the template. This can be used in templates if cookies are disabled. It needs to be put as and input to every authenticated page.</p>

<p>More information on the <code>gettemplate</code> sub can be found in the Templates.pm module.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="checkauth"
>checkauth</a></h2>

<pre>  ($userid, $cookie, $sessionID) = &#38;checkauth($query, $noauth, $flagsrequired, $type);</pre>

<p>Verifies that the user is authorized to run this script. If the user is authorized, a (userid, cookie, session-id, flags) quadruple is returned. If the user is not authorized but does not have the required privilege (see $flagsrequired below), it displays an error page and exits. Otherwise, it displays the login page and exits.</p>

<p>Note that <code>&#38;checkauth</code> will return if and only if the user is authorized, so it should be called early on, before any unfinished operations (e.g., if you&#39;ve opened a file, then <code>&#38;checkauth</code> won&#39;t close it for you).</p>

<p><code>$query</code> is the CGI object for the script calling <code>&#38;checkauth</code>.</p>

<p>The <code>$noauth</code> argument is optional. If it is set, then no authorization is required for the script.</p>

<p><code>&#38;checkauth</code> fetches user and session information from <code>$query</code> and ensures that the user is authorized to run scripts that require authorization.</p>

<p>The <code>$flagsrequired</code> argument specifies the required privileges the user must have if the username and password are correct. It should be specified as a reference-to-hash; keys in the hash should be the &#34;flags&#34; for the user, as specified in the Members intranet module. Any key specified must correspond to a &#34;flag&#34; in the userflags table. E.g., { circulate =&#62; 1 } would specify that the user must have the &#34;circulate&#34; privilege in order to proceed. To make sure that access control is correct, the <code>$flagsrequired</code> parameter must be specified correctly.</p>

<p>The <code>$type</code> argument specifies whether the template should be retrieved from the opac or intranet directory tree. &#34;opac&#34; is assumed if it is not specified; however, if <code>$type</code> is specified, &#34;intranet&#34; is assumed if it is not &#34;opac&#34;.</p>

<p>If <code>$query</code> does not have a valid session ID associated with it (i.e., the user has not logged in) or if the session has expired, <code>&#38;checkauth</code> presents the user with a login page (from the point of view of the original script, <code>&#38;checkauth</code> does not return). Once the user has authenticated, <code>&#38;checkauth</code> restarts the original script (this time, <code>&#38;checkauth</code> returns).</p>

<p>The login page is provided using a HTML::Template, which is set in the systempreferences table or at the top of this file. The variable <code>$type</code> selects which template to use, either the opac or the intranet authentification template.</p>

<p><code>&#38;checkauth</code> returns a user ID, a cookie, and a session ID. The cookie should be sent back to the browser; it verifies that the user has authenticated.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SEE_ALSO"
>SEE ALSO</a></h1>

<p>CGI(3)</p>

<p>C4::Output(3)</p>

<p>Digest::MD5(3)</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
