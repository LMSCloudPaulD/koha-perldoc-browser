<html><head><title>C4::Context</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Fri Mar 17 01:12:09 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#METHODS'>METHODS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#new'>new</a>
    <li class='indexItem indexItem2'><a href='#set_context'>set_context</a>
    <li class='indexItem indexItem2'><a href='#restore_context'>restore_context</a>
    <li class='indexItem indexItem2'><a href='#config'>config</a>
    <li class='indexItem indexItem2'><a href='#preference'>preference</a>
    <li class='indexItem indexItem2'><a href='#yaml_preference'>yaml_preference</a>
    <li class='indexItem indexItem2'><a href='#enable_syspref_cache'>enable_syspref_cache</a>
    <li class='indexItem indexItem2'><a href='#disable_syspref_cache'>disable_syspref_cache</a>
    <li class='indexItem indexItem2'><a href='#clear_syspref_cache'>clear_syspref_cache</a>
    <li class='indexItem indexItem2'><a href='#set_preference'>set_preference</a>
    <li class='indexItem indexItem2'><a href='#delete_preference'>delete_preference</a>
    <li class='indexItem indexItem2'><a href='#csv_delimiter'>csv_delimiter</a>
    <li class='indexItem indexItem2'><a href='#Zconn'>Zconn</a>
    <li class='indexItem indexItem2'><a href='#_new_Zconn'>_new_Zconn</a>
    <li class='indexItem indexItem2'><a href='#dbh'>dbh</a>
    <li class='indexItem indexItem2'><a href='#new_dbh'>new_dbh</a>
    <li class='indexItem indexItem2'><a href='#set_dbh'>set_dbh</a>
    <li class='indexItem indexItem2'><a href='#restore_dbh'>restore_dbh</a>
    <li class='indexItem indexItem2'><a href='#userenv'>userenv</a>
    <li class='indexItem indexItem2'><a href='#set_userenv'>set_userenv</a>
    <li class='indexItem indexItem2'><a href='#_new_userenv'>_new_userenv</a>
    <li class='indexItem indexItem2'><a href='#_unset_userenv'>_unset_userenv</a>
    <li class='indexItem indexItem2'><a href='#get_versions'>get_versions</a>
    <li class='indexItem indexItem2'><a href='#tz'>tz</a>
    <li class='indexItem indexItem2'><a href='#IsSuperLibrarian'>IsSuperLibrarian</a>
    <li class='indexItem indexItem2'><a href='#interface'>interface</a>
    <li class='indexItem indexItem2'><a href='#only_my_library'>only_my_library</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#temporary_directory'>temporary_directory</a>
      <li class='indexItem indexItem3'><a href='#set_remote_address'>set_remote_address</a>
      <li class='indexItem indexItem3'><a href='#https_enabled'>https_enabled</a>
      <li class='indexItem indexItem3'><a href='#needs_install'>needs_install</a>
      <li class='indexItem indexItem3'><a href='#psgi_env'>psgi_env</a>
      <li class='indexItem indexItem3'><a href='#is_internal_PSGI_request'>is_internal_PSGI_request</a>
    </ul>
  </ul>
  <li class='indexItem indexItem1'><a href='#ENVIRONMENT'>ENVIRONMENT</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#KOHA_CONF'>KOHA_CONF</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#AUTHORS'>AUTHORS</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>C4::Context - Maintain and manipulate the context of a Koha script</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>  use C4::Context;

  use C4::Context(&#34;/path/to/koha-conf.xml&#34;);

  $config_value = C4::Context-&#62;config(&#34;config_variable&#34;);

  $koha_preference = C4::Context-&#62;preference(&#34;preference&#34;);

  $db_handle = C4::Context-&#62;dbh;

  $Zconn = C4::Context-&#62;Zconn;</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>When a Koha script runs, it makes use of a certain number of things: configuration settings in <em>/etc/koha/koha-conf.xml</em>, a connection to the Koha databases, and so forth. These things make up the <i>context</i> in which the script runs.</p>

<p>This module takes care of setting up the context for a script: figuring out which configuration file to load, and loading it, opening a connection to the right database, and so forth.</p>

<p>Most scripts will only use one context. They can simply have</p>

<pre>  use C4::Context;</pre>

<p>at the top.</p>

<p>Other scripts may need to use several contexts. For instance, if a library has two databases, one for a certain collection, and the other for everything else, it might be necessary for a script to use two different contexts to search both databases. Such scripts should use the <code>&#38;set_context</code> and <code>&#38;restore_context</code> functions, below.</p>

<p>By default, C4::Context reads the configuration from <em>/etc/koha/koha-conf.xml</em>. This may be overridden by setting the <code>$KOHA_CONF</code> environment variable to the pathname of a configuration file to use.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="METHODS"
>METHODS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="new"
>new</a></h2>

<pre>  $context = C4::Context-&#62;new;
  $context = C4::Context-&#62;new(&#34;/path/to/koha-conf.xml&#34;);</pre>

<p>Allocates a new context. Initializes the context from the specified file, which defaults to either the file given by the <code>$KOHA_CONF</code> environment variable, or <em>/etc/koha/koha-conf.xml</em>.</p>

<p>It saves the koha-conf.xml values in the declared memcached server(s) if currently available and uses those values until them expire and re-reads them.</p>

<p><code>&#38;new</code> does not set this context as the new default context; for that, use <code>&#38;set_context</code>.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="set_context"
>set_context</a></h2>

<pre>  $context = new C4::Context;
  $context-&#62;set_context();
or
  set_context C4::Context $context;

  ...
  restore_context C4::Context;</pre>

<p>In some cases, it might be necessary for a script to use multiple contexts. <code>&#38;set_context</code> saves the current context on a stack, then sets the context to <code>$context</code>, which will be used in future operations. To restore the previous context, use <code>&#38;restore_context</code>.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="restore_context"
>restore_context</a></h2>

<pre>  &#38;restore_context;</pre>

<p>Restores the context set by <code>&#38;set_context</code>.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="config"
>config</a></h2>

<pre>  $value = C4::Context-&#62;config(&#34;config_variable&#34;);</pre>

<p>Returns the value of a variable specified in the configuration file from which the current context was created.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="preference"
>preference</a></h2>

<pre>  $sys_preference = C4::Context-&#62;preference(&#39;some_variable&#39;);</pre>

<p>Looks up the value of the given system preference in the systempreferences table of the Koha database, and returns it. If the variable is not set or does not exist, undef is returned.</p>

<p>In case of an error, this may return 0.</p>

<p>Note: It is impossible to tell the difference between system preferences which do not exist, and those whose values are set to NULL with this method.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="yaml_preference"
>yaml_preference</a></h2>

<p>Retrieves the required system preference value, and converts it from YAML into a Perl data structure. It throws an exception if the value cannot be properly decoded as YAML.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="enable_syspref_cache"
>enable_syspref_cache</a></h2>

<pre>  C4::Context-&#62;enable_syspref_cache();</pre>

<p>Enable the in-memory syspref cache used by C4::Context. This is the default behavior.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="disable_syspref_cache"
>disable_syspref_cache</a></h2>

<pre>  C4::Context-&#62;disable_syspref_cache();</pre>

<p>Disable the in-memory syspref cache used by C4::Context. This should be used with Plack and other persistent environments.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="clear_syspref_cache"
>clear_syspref_cache</a></h2>

<pre>  C4::Context-&#62;clear_syspref_cache();</pre>

<p>cleans the internal cache of sysprefs. Please call this method if you update the systempreferences table. Otherwise, your new changes will not be seen by this process.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="set_preference"
>set_preference</a></h2>

<pre>  C4::Context-&#62;set_preference( $variable, $value, [ $explanation, $type, $options ] );</pre>

<p>This updates a preference&#39;s value both in the systempreferences table and in the sysprefs cache. If the optional parameters are provided, then the query becomes a create. It won&#39;t update the parameters (except value) for an existing preference.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="delete_preference"
>delete_preference</a></h2>

<pre>    C4::Context-&#62;delete_preference( $variable );</pre>

<p>This deletes a system preference from the database. Returns a true value on success. Failure means there was an issue with the database, not that there was no syspref of the name.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="csv_delimiter"
>csv_delimiter</a></h2>

<pre>    $delimiter = C4::Context-&#62;csv_delimiter;

    Returns preferred CSV delimiter, using system preference &#39;CSVDelimiter&#39;.
    If this preference is missing or empty, comma will be returned.
    This method is needed because of special behavior for tabulation.

    You can, optionally, pass a value parameter to this routine
    in the case of existing delimiter.</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Zconn"
>Zconn</a></h2>

<pre>  $Zconn = C4::Context-&#62;Zconn</pre>

<p>Returns a connection to the Zebra database</p>

<p><code>$self</code></p>

<p><code>$server</code> one of the servers defined in the koha-conf.xml file</p>

<p><code>$async</code> whether this is a asynchronous connection</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_new_Zconn"
>_new_Zconn</a></h2>

<p>$context-&#62;{&#34;Zconn&#34;} = &#38;_new_Zconn($server,$async);</p>

<p>Internal function. Creates a new database connection from the data given in the current context and returns it.</p>

<p><code>$server</code> one of the servers defined in the koha-conf.xml file</p>

<p><code>$async</code> whether this is a asynchronous connection</p>

<p><code>$auth</code> whether this connection has rw access (1) or just r access (0 or NULL)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="dbh"
>dbh</a></h2>

<pre>  $dbh = C4::Context-&#62;dbh;</pre>

<p>Returns a database handle connected to the Koha database for the current context. If no connection has yet been made, this method creates one, and connects to the database.</p>

<p>This database handle is cached for future use: if you call <code>C4::Context-&#62;dbh</code> twice, you will get the same handle both times. If you need a second database handle, use <code>&#38;new_dbh</code> and possibly <code>&#38;set_dbh</code>.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="new_dbh"
>new_dbh</a></h2>

<pre>  $dbh = C4::Context-&#62;new_dbh;</pre>

<p>Creates a new connection to the Koha database for the current context, and returns the database handle (a <code>DBI::db</code> object).</p>

<p>The handle is not saved anywhere: this method is strictly a convenience function; the point is that it knows which database to connect to so that the caller doesn&#39;t have to know.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="set_dbh"
>set_dbh</a></h2>

<pre>  $my_dbh = C4::Connect-&#62;new_dbh;
  C4::Connect-&#62;set_dbh($my_dbh);
  ...
  C4::Connect-&#62;restore_dbh;</pre>

<p><code>&#38;set_dbh</code> and <code>&#38;restore_dbh</code> work in a manner analogous to <code>&#38;set_context</code> and <code>&#38;restore_context</code>.</p>

<p><code>&#38;set_dbh</code> saves the current database handle on a stack, then sets the current database handle to <code>$my_dbh</code>.</p>

<p><code>$my_dbh</code> is assumed to be a good database handle.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="restore_dbh"
>restore_dbh</a></h2>

<pre>  C4::Context-&#62;restore_dbh;</pre>

<p>Restores the database handle saved by an earlier call to <code>C4::Context-&#62;set_dbh</code>.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="userenv"
>userenv</a></h2>

<pre>  C4::Context-&#62;userenv;</pre>

<p>Retrieves a hash for user environment variables.</p>

<p>This hash shall be cached for future use: if you call <code>C4::Context-&#62;userenv</code> twice, you will get the same hash without real DB access</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="set_userenv"
>set_userenv</a></h2>

<pre>  C4::Context-&#62;set_userenv($usernum, $userid, $usercnum,
                           $userfirstname, $usersurname,
                           $userbranch, $branchname, $userflags,
                           $emailaddress, $shibboleth
                           $desk_id, $desk_name,
                           $register_id, $register_name);</pre>

<p>Establish a hash of user environment variables.</p>

<p>set_userenv is called in Auth.pm</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_new_userenv"
>_new_userenv</a></h2>

<pre>  C4::Context-&#62;_new_userenv($session);  # FIXME: This calling style is wrong for what looks like an _internal function</pre>

<p>Builds a hash for user environment variables.</p>

<p>This hash shall be cached for future use: if you call <code>C4::Context-&#62;userenv</code> twice, you will get the same hash without real DB access</p>

<p>_new_userenv is called in Auth.pm</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_unset_userenv"
>_unset_userenv</a></h2>

<pre>  C4::Context-&#62;_unset_userenv;</pre>

<p>Destroys the hash for activeuser user environment variables.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_versions"
>get_versions</a></h2>

<pre>  C4::Context-&#62;get_versions</pre>

<p>Gets various version info, for core Koha packages, Currently called from carp handle_errors() sub, to send to browser if &#39;DebugLevel&#39; syspref is set to &#39;2&#39;.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="tz"
>tz</a></h2>

<pre>  C4::Context-&#62;tz

  Returns a DateTime::TimeZone object for the system timezone</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="IsSuperLibrarian"
>IsSuperLibrarian</a></h2>

<pre>    C4::Context-&#62;IsSuperLibrarian();</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="interface"
>interface</a></h2>

<p>Sets the current interface for later retrieval in any Perl module</p>

<pre>    C4::Context-&#62;interface(&#39;opac&#39;);
    C4::Context-&#62;interface(&#39;intranet&#39;);
    my $interface = C4::Context-&#62;interface;</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="only_my_library"
>only_my_library</a></h2>

<pre>    my $test = C4::Context-&#62;only_my_library;

    Returns true if you enabled IndependentBranches and the current user
    does not have superlibrarian permissions.</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="temporary_directory"
>temporary_directory</a></h3>

<p>Returns root directory for temporary storage</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="set_remote_address"
>set_remote_address</a></h3>

<p>set_remote_address should be called at the beginning of every script that is *not* running under plack in order to the REMOTE_ADDR environment variable to be set correctly.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="https_enabled"
>https_enabled</a></h3>

<p>https_enabled should be called when checking if a HTTPS connection is used.</p>

<p>Note that this depends on a HTTPS environmental variable being defined by the web server. This function may not return the expected result, if your web server or reverse proxies are not setting the correct X-Forwarded-Proto headers and HTTPS environmental variable.</p>

<p>Note too that the HTTPS value can vary from web server to web server. We are relying on the convention of the value being &#34;on&#34; or &#34;ON&#34; here.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="needs_install"
>needs_install</a></h3>

<pre>    if ( $context-&#62;needs_install ) { ... }</pre>

<p>This method returns a boolean representing the install status of the Koha instance.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="psgi_env"
>psgi_env</a></h3>

<p>psgi_env returns true if there is an environmental variable prefixed with &#34;psgi&#34; or &#34;plack&#34;. This is useful for detecting whether this is a PSGI app or a CGI app, and implementing code as appropriate.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="is_internal_PSGI_request"
>is_internal_PSGI_request</a></h3>

<p>is_internal_PSGI_request is used to detect if this request was made from within the individual PSGI app or externally from the mounted PSGI app</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="ENVIRONMENT"
>ENVIRONMENT</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="KOHA_CONF"
><code>KOHA_CONF</code></a></h2>

<p>Specifies the configuration file to read.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHORS"
>AUTHORS</a></h1>

<p>Andrew Arensburger &#60;arensb at ooblick dot com&#62;</p>

<p>Joshua Ferraro &#60;jmf at liblime dot com&#62;</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
