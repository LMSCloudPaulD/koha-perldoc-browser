<html><head><title>C4::Message</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Thu Apr 20 06:19:05 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Class_Methods'>Class Methods</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#C4%3A%3AMessage-%3Enew(%5C%25attributes)'>C4::Message-&#62;new(\%attributes)</a>
      <li class='indexItem indexItem3'><a href='#C4%3A%3AMessage-%3Efind(%24id)'>C4::Message-&#62;find($id)</a>
      <li class='indexItem indexItem3'><a href='#C4%3A%3AMessage-%3Efind_last_message(%24borrower%2C_%24letter_code%2C_%24transport)'>C4::Message-&#62;find_last_message($borrower, $letter_code, $transport)</a>
      <li class='indexItem indexItem3'><a href='#C4%3A%3AMessage-%3Eenqueue(%24letter%2C_%24patron%2C_%24transport)'>C4::Message-&#62;enqueue($letter, $patron, $transport)</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#Instance_Methods'>Instance Methods</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#%24message-%3Eupdate()'>$message-&#62;update()</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Emetadata(%5C%25new_metadata)'>$message-&#62;metadata(\%new_metadata)</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Eappend(%5C%25letter)'>$message-&#62;append(\%letter)</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Eappend(%24string)'>$message-&#62;append($string)</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#Attributes_Accessors'>Attributes Accessors</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#%24message-%3Emessage_id'>$message-&#62;message_id</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Eborrowernumber'>$message-&#62;borrowernumber</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Esubject'>$message-&#62;subject</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Econtent'>$message-&#62;content</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Emetadata'>$message-&#62;metadata</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Eletter_code'>$message-&#62;letter_code</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Emessage_transport_type'>$message-&#62;message_transport_type</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Estatus'>$message-&#62;status</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Etime_queued'>$message-&#62;time_queued</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Eto_address'>$message-&#62;to_address</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Efrom_address'>$message-&#62;from_address</a>
      <li class='indexItem indexItem3'><a href='#%24message-%3Econtent_type'>$message-&#62;content_type</a>
    </ul>
  </ul>
  <li class='indexItem indexItem1'><a href='#SEE_ALSO'>SEE ALSO</a>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>C4::Message - object for messages in the message_queue table</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p>How to add a new message to the queue:</p>

<pre>  use C4::Message;
  use C4::Items;
  my $patron = Koha::Patron-&#62;find({ borrowernumber =&#62; 1 });
  my $item   = Koha::Items-&#62;find($itemnumber)-&#62;unblessed;
  my $letter =  C4::Letters::GetPreparedLetter (
      module =&#62; &#39;circulation&#39;,
      letter_code =&#62; &#39;CHECKOUT&#39;,
      branchcode =&#62; $branch,
      tables =&#62; {
          &#39;biblio&#39;, $item-&#62;{biblionumber},
          &#39;biblioitems&#39;, $item-&#62;{biblionumber},
      },
  );
  C4::Message-&#62;enqueue($letter, $patron, &#39;email&#39;);</pre>

<p>How to update a borrower&#39;s last checkout message:</p>

<pre>  use C4::Message;
  my $borrower = { borrowernumber =&#62; 1 };
  my $message  = C4::Message-&#62;find_last_message($borrower, &#39;CHECKOUT&#39;, &#39;email&#39;);
  $message-&#62;append(&#34;you also checked out some other book....&#34;);
  $message-&#62;update;</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This module presents an OO interface to the message_queue. Previously, you could only add messages to the message_queue via <code>C4::Letters::EnqueueMessage()</code>. With this module, you can also get previously inserted messages, manipulate them, and save them back to the database.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Class_Methods"
>Class Methods</a></h2>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="C4::Message-&#62;new(\%attributes)"
>C4::Message-&#62;new(\%attributes)</a></h3>

<p>This method creates an in-memory version of a message object.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="C4::Message-&#62;find($id)"
>C4::Message-&#62;find($id)</a></h3>

<p>This method searches the message_queue table for a row with the given <code>message_id</code> and it&#39;ll return a C4::Message object if it finds one.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="C4::Message-&#62;find_last_message($borrower,_$letter_code,_$transport)"
>C4::Message-&#62;find_last_message($borrower, $letter_code, $transport)</a></h3>

<p>This method is used to get the borrower&#39;s most recent, pending, check-in or checkout message. (This makes it possible to add more information to the message before it gets sent out.)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="C4::Message-&#62;enqueue($letter,_$patron,_$transport)"
>C4::Message-&#62;enqueue($letter, $patron, $transport)</a></h3>

<p>This is a front-end for <code>C4::Letters::EnqueueLetter()</code> that adds metadata to the message.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Instance_Methods"
>Instance Methods</a></h2>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;update()"
>$message-&#62;update()</a></h3>

<p>This saves the $message object back to the database. It needs to have already been created via <code>enqueue</code> for this to work.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;metadata(\%new_metadata)"
>$message-&#62;metadata(\%new_metadata)</a></h3>

<p>This method automatically serializes and deserializes the metadata attribute. (It is stored in YAML format.)</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;append(\%letter)"
>$message-&#62;append(\%letter)</a></h3>

<p>If passed a hashref, this method will assume that the hashref is in the form that <code>C4::Letters::getletter()</code> returns. It will append the body of the letter to the message.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;append($string)"
>$message-&#62;append($string)</a></h3>

<p>If passed a string, it&#39;ll append the string to the message.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Attributes_Accessors"
>Attributes Accessors</a></h2>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;message_id"
>$message-&#62;message_id</a></h3>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;borrowernumber"
>$message-&#62;borrowernumber</a></h3>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;subject"
>$message-&#62;subject</a></h3>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;content"
>$message-&#62;content</a></h3>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;metadata"
>$message-&#62;metadata</a></h3>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;letter_code"
>$message-&#62;letter_code</a></h3>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;message_transport_type"
>$message-&#62;message_transport_type</a></h3>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;status"
>$message-&#62;status</a></h3>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;time_queued"
>$message-&#62;time_queued</a></h3>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;to_address"
>$message-&#62;to_address</a></h3>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;from_address"
>$message-&#62;from_address</a></h3>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="$message-&#62;content_type"
>$message-&#62;content_type</a></h3>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SEE_ALSO"
>SEE ALSO</a></h1>

<p><a href="../C4/Circulation.html" class="podlinkpod"
>C4::Circulation</a>, <a href="../C4/Letters.html" class="podlinkpod"
>C4::Letters</a>, <a href="../C4/Members/Messaging.html" class="podlinkpod"
>C4::Members::Messaging</a></p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>John Beppu &#60;john.beppu@liblime.com&#62;</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
