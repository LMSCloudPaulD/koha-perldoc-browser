<html><head><title>C4::Reserves</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Mon Feb 20 01:16:32 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#AddReserve'>AddReserve</a>
    <li class='indexItem indexItem2'><a href='#CanBookBeReserved'>CanBookBeReserved</a>
    <li class='indexItem indexItem2'><a href='#CanItemBeReserved'>CanItemBeReserved</a>
    <li class='indexItem indexItem2'><a href='#CanReserveBeCanceledFromOpac'>CanReserveBeCanceledFromOpac</a>
    <li class='indexItem indexItem2'><a href='#GetOtherReserves'>GetOtherReserves</a>
    <li class='indexItem indexItem2'><a href='#ChargeReserveFee'>ChargeReserveFee</a>
    <li class='indexItem indexItem2'><a href='#GetReserveFee'>GetReserveFee</a>
    <li class='indexItem indexItem2'><a href='#GetReserveStatus'>GetReserveStatus</a>
    <li class='indexItem indexItem2'><a href='#CheckReserves'>CheckReserves</a>
    <li class='indexItem indexItem2'><a href='#CancelExpiredReserves'>CancelExpiredReserves</a>
    <li class='indexItem indexItem2'><a href='#AutoUnsuspendReserves'>AutoUnsuspendReserves</a>
    <li class='indexItem indexItem2'><a href='#ModReserve'>ModReserve</a>
    <li class='indexItem indexItem2'><a href='#ModReserveStatus'>ModReserveStatus</a>
    <li class='indexItem indexItem2'><a href='#ModReserveAffect'>ModReserveAffect</a>
    <li class='indexItem indexItem2'><a href='#ModReserveCancelAll'>ModReserveCancelAll</a>
    <li class='indexItem indexItem2'><a href='#ModReserveMinusPriority'>ModReserveMinusPriority</a>
    <li class='indexItem indexItem2'><a href='#IsAvailableForItemLevelRequest'>IsAvailableForItemLevelRequest</a>
    <li class='indexItem indexItem2'><a href='#ItemsAnyAvailableAndNotRestricted'>ItemsAnyAvailableAndNotRestricted</a>
    <li class='indexItem indexItem2'><a href='#AlterPriority'>AlterPriority</a>
    <li class='indexItem indexItem2'><a href='#ToggleLowestPriority'>ToggleLowestPriority</a>
    <li class='indexItem indexItem2'><a href='#ToggleSuspend'>ToggleSuspend</a>
    <li class='indexItem indexItem2'><a href='#SuspendAll'>SuspendAll</a>
    <li class='indexItem indexItem2'><a href='#_FixPriority'>_FixPriority</a>
    <li class='indexItem indexItem2'><a href='#_Findgroupreserve'>_Findgroupreserve</a>
    <li class='indexItem indexItem2'><a href='#_koha_notify_reserve'>_koha_notify_reserve</a>
    <li class='indexItem indexItem2'><a href='#_koha_notify_hold_changed'>_koha_notify_hold_changed</a>
    <li class='indexItem indexItem2'><a href='#_ShiftPriority'>_ShiftPriority</a>
    <li class='indexItem indexItem2'><a href='#MoveReserve'>MoveReserve</a>
    <li class='indexItem indexItem2'><a href='#MergeHolds'>MergeHolds</a>
    <li class='indexItem indexItem2'><a href='#RevertWaitingStatus'>RevertWaitingStatus</a>
    <li class='indexItem indexItem2'><a href='#ReserveSlip'>ReserveSlip</a>
    <li class='indexItem indexItem2'><a href='#GetReservesControlBranch'>GetReservesControlBranch</a>
    <li class='indexItem indexItem2'><a href='#CalculatePriority'>CalculatePriority</a>
    <li class='indexItem indexItem2'><a href='#IsItemOnHoldAndFound'>IsItemOnHoldAndFound</a>
    <li class='indexItem indexItem2'><a href='#GetMaxPatronHoldsForRecord'>GetMaxPatronHoldsForRecord</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>C4::Reserves - Koha functions for dealing with reservation.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>  use C4::Reserves;</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This modules provides somes functions to deal with reservations.</p>

<pre>  Reserves are stored in reserves table.
  The following columns contains important values :
  - priority &#62;0      : then the reserve is at 1st stage, and not yet affected to any item.
             =0      : then the reserve is being dealed
  - found : NULL         : means the patron requested the 1st available, and we haven&#39;t chosen the item
            T(ransit)    : the reserve is linked to an item but is in transit to the pickup branch
            W(aiting)    : the reserve is linked to an item, is at the pickup branch, and is waiting on the hold shelf
            F(inished)   : the reserve has been completed, and is done
            P(rocessing) : reserved item has been returned using self-check machine and reserve needs to be confirmed
                           by librarian before notice is send and status changed to waiting.
                           Applicable only if HoldsNeedProcessingSIP system preference is set.
  - itemnumber : empty : the reserve is still unaffected to an item
                 filled: the reserve is attached to an item
  The complete workflow is :
  ==== 1st use case ====
  patron request a document, 1st available :                      P &#62;0, F=NULL, I=NULL
  a library having it run &#34;transfertodo&#34;, and clic on the list
         if there is no transfer to do, the reserve waiting
         patron can pick it up                                    P =0, F=W,    I=filled
         if there is a transfer to do, write in branchtransfer    P =0, F=T,    I=filled
           The pickup library receive the book, it check in       P =0, F=W,    I=filled
  The patron borrow the book                                      P =0, F=F,    I=filled

  ==== 2nd use case ====
  patron requests a document, a given item,
    If pickup is holding branch                                   P =0, F=W,   I=filled
    If transfer needed, write in branchtransfer                   P =0, F=T,    I=filled
        The pickup library receive the book, it checks it in      P =0, F=W,    I=filled
  The patron borrow the book                                      P =0, F=F,    I=filled</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="AddReserve"
>AddReserve</a></h2>

<pre>    AddReserve(
        {
            branchcode       =&#62; $branchcode,
            borrowernumber   =&#62; $borrowernumber,
            biblionumber     =&#62; $biblionumber,
            priority         =&#62; $priority,
            reservation_date =&#62; $reservation_date,
            expiration_date  =&#62; $expiration_date,
            notes            =&#62; $notes,
            title            =&#62; $title,
            itemnumber       =&#62; $itemnumber,
            found            =&#62; $found,
            itemtype         =&#62; $itemtype,
            item_group_id    =&#62; $item_group_id
        }
    );</pre>

<p>Adds reserve and generates HOLDPLACED message.</p>

<p>The following tables are available witin the HOLDPLACED message:</p>

<pre>    branches
    borrowers
    biblio
    biblioitems
    items
    reserves</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CanBookBeReserved"
>CanBookBeReserved</a></h2>

<pre>  $canReserve = &#38;CanBookBeReserved($borrowernumber, $biblionumber, $branchcode, $params)
  if ($canReserve eq &#39;OK&#39;) { #We can reserve this Item! }

  $params are passed directly through to CanItemBeReserved</pre>

<p>See CanItemBeReserved() for possible return values.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CanItemBeReserved"
>CanItemBeReserved</a></h2>

<pre>  $canReserve = &#38;CanItemBeReserved($patron, $item, $branchcode, $params)
  if ($canReserve-&#62;{status} eq &#39;OK&#39;) { #We can reserve this Item! }

  current params are:
  &#39;ignore_hold_counts&#39; - we use this routine to check if an item can fill a hold - on this case we
  should not check if there are too many holds as we only care about reservability</pre>

<p>@RETURNS { status =&#62; OK }, if the Item can be reserved. { status =&#62; ageRestricted }, if the Item is age restricted for this borrower. { status =&#62; damaged }, if the Item is damaged. { status =&#62; cannotReserveFromOtherBranches }, if syspref &#39;canreservefromotherbranches&#39; is OK. { status =&#62; branchNotInHoldGroup }, if borrower home library is not in hold group, and holds are only allowed from hold groups. { status =&#62; tooManyReserves, limit =&#62; $limit }, if the borrower has exceeded their maximum reserve amount. { status =&#62; notReservable }, if holds on this item are not allowed { status =&#62; libraryNotFound }, if given branchcode is not an existing library { status =&#62; libraryNotPickupLocation }, if given branchcode is not configured to be a pickup location { status =&#62; cannotBeTransferred }, if branch transfer limit applies on given item and branchcode { status =&#62; pickupNotInHoldGroup }, pickup location is not in hold group, and pickup locations are only allowed from hold groups. { status =&#62; recall }, if the borrower has already placed a recall on this item</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CanReserveBeCanceledFromOpac"
>CanReserveBeCanceledFromOpac</a></h2>

<pre>    $number = CanReserveBeCanceledFromOpac($reserve_id, $borrowernumber);

    returns 1 if reserve can be cancelled by user from OPAC.
    First check if reserve belongs to user, next checks if reserve is not in
    transfer or waiting status</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetOtherReserves"
>GetOtherReserves</a></h2>

<pre>  ($messages,$nextreservinfo)=$GetOtherReserves(itemnumber);</pre>

<p>Check queued list of this document and check if this document must be transferred</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ChargeReserveFee"
>ChargeReserveFee</a></h2>

<pre>    $fee = ChargeReserveFee( $borrowernumber, $fee, $title );

    Charge the fee for a reserve (if $fee &#62; 0)</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetReserveFee"
>GetReserveFee</a></h2>

<pre>    $fee = GetReserveFee( $borrowernumber, $biblionumber );

    Calculate the fee for a reserve (if applicable).</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetReserveStatus"
>GetReserveStatus</a></h2>

<pre>  $reservestatus = GetReserveStatus($itemnumber);</pre>

<p>Takes an itemnumber and returns the status of the reserve placed on it. If several reserves exist, the reserve with the lower priority is given.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CheckReserves"
>CheckReserves</a></h2>

<pre>  ($status, $matched_reserve, $possible_reserves) = &#38;CheckReserves($itemnumber);
  ($status, $matched_reserve, $possible_reserves) = &#38;CheckReserves(undef, $barcode);
  ($status, $matched_reserve, $possible_reserves) = &#38;CheckReserves($itemnumber,undef,$lookahead);</pre>

<p>Find a book in the reserves.</p>

<p><code>$itemnumber</code> is the book&#39;s item number. <code>$lookahead</code> is the number of days to look in advance for future reserves.</p>

<p>As I understand it, <code>&#38;CheckReserves</code> looks for the given item in the reserves. If it is found, that&#39;s a match, and <code>$status</code> is set to <code>Waiting</code>.</p>

<p>Otherwise, it finds the most important item in the reserves with the same biblio number as this book (I&#39;m not clear on this) and returns it with <code>$status</code> set to <code>Reserved</code>.</p>

<p><code>&#38;CheckReserves</code> returns a two-element list:</p>

<p><code>$status</code> is either <code>Waiting</code>, <code>Reserved</code> (see above), or 0.</p>

<p><code>$reserve</code> is the reserve item that matched. It is a reference-to-hash whose keys are mostly the fields of the reserves table in the Koha database.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CancelExpiredReserves"
>CancelExpiredReserves</a></h2>

<pre>  CancelExpiredReserves();</pre>

<p>Cancels all reserves with an expiration date from before today.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="AutoUnsuspendReserves"
>AutoUnsuspendReserves</a></h2>

<pre>  AutoUnsuspendReserves();</pre>

<p>Unsuspends all suspended reserves with a suspend_until date from before today.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ModReserve"
>ModReserve</a></h2>

<pre>  ModReserve({ rank =&#62; $rank,
               reserve_id =&#62; $reserve_id,
               branchcode =&#62; $branchcode
               [, itemnumber =&#62; $itemnumber ]
               [, biblionumber =&#62; $biblionumber, $borrowernumber =&#62; $borrowernumber ]
              });</pre>

<p>Change a hold request&#39;s priority or cancel it.</p>

<p><code>$rank</code> specifies the effect of the change. If <code>$rank</code> is &#39;n&#39;, nothing happens. This corresponds to leaving a request alone when changing its priority in the holds queue for a bib.</p>

<p>If <code>$rank</code> is &#39;del&#39;, the hold request is cancelled.</p>

<p>If <code>$rank</code> is an integer greater than zero, the priority of the request is set to that value. Since priority != 0 means that the item is not waiting on the hold shelf, setting the priority to a non-zero value also sets the request&#39;s found status and waiting date to NULL.</p>

<p>If the hold is &#39;found&#39; (waiting, in-transit, processing) the only field that can be updated is the expiration date.</p>

<p>The optional <code>$itemnumber</code> parameter is used only when <code>$rank</code> is a non-zero integer; if supplied, the itemnumber of the hold request is set accordingly; if omitted, the itemnumber is cleared.</p>

<p><b>FIXME:</b> Note that the forgoing can have the effect of causing item-level hold requests to turn into title-level requests. This will be fixed once reserves has separate columns for requested itemnumber and supplying itemnumber.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ModReserveStatus"
>ModReserveStatus</a></h2>

<pre>  &#38;ModReserveStatus($itemnumber, $newstatus);</pre>

<p>Update the reserve status for the active (priority=0) reserve.</p>

<p>$itemnumber is the itemnumber the reserve is on</p>

<p>$newstatus is the new status.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ModReserveAffect"
>ModReserveAffect</a></h2>

<pre>  &#38;ModReserveAffect($itemnumber,$borrowernumber,$diffBranchSend,$reserve_id, $desk_id, $notify_library);</pre>

<p>This function affect an item and a status for a given reserve, either fetched directly by record_id, or by borrowernumber and itemnumber or biblionumber. If only biblionumber is given, only first reserve returned is affected, which is ok for anything but multi-item holds.</p>

<p>if $transferToDo is not set, then the status is set to &#34;Waiting&#34; as well. otherwise, a transfer is on the way, and the end of the transfer will take care of the waiting status</p>

<p>This function also removes any entry of the hold in holds queue table.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ModReserveCancelAll"
>ModReserveCancelAll</a></h2>

<pre>  ($messages,$nextreservinfo) = &#38;ModReserveCancelAll($itemnumber,$borrowernumber,$reason);</pre>

<p>function to cancel reserv,check other reserves, and transfer document if it&#39;s necessary</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ModReserveMinusPriority"
>ModReserveMinusPriority</a></h2>

<pre>  &#38;ModReserveMinusPriority($itemnumber,$borrowernumber,$biblionumber)</pre>

<p>Reduce the values of queued list</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="IsAvailableForItemLevelRequest"
>IsAvailableForItemLevelRequest</a></h2>

<pre>  my $is_available = IsAvailableForItemLevelRequest( $item_record, $borrower_record, $pickup_branchcode );</pre>

<p>Checks whether a given item record is available for an item-level hold request. An item is available if</p>

<p>* it is not lost AND * it is not damaged AND * it is not withdrawn AND * a waiting or in transit reserve is placed on * does not have a not for loan value &#62; 0</p>

<p>Need to check the issuingrules onshelfholds column, if this is set items on the shelf can be placed on hold</p>

<p>Note that IsAvailableForItemLevelRequest() does not check if the staff operator is authorized to place a request on the item - in particular, this routine does not check IndependentBranches and canreservefromotherbranches.</p>

<p>Note also that this subroutine does not checks smart rules limits for item by reservesallowed/holds_per_record values, this complemented in calling code with calls and checks with CanItemBeReserved or CanBookBeReserved.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ItemsAnyAvailableAndNotRestricted"
>ItemsAnyAvailableAndNotRestricted</a></h2>

<pre>  ItemsAnyAvailableAndNotRestricted( { biblionumber =&#62; $biblionumber, patron =&#62; $patron });</pre>

<p>This function checks all items for specified biblionumber (numeric) against patron (object) and returns true (1) if at least one item available for loan/check out/present/not held and also checks other parameters logic which not restricts item for hold at all (for ex. AllowHoldsOnDamagedItems or &#39;holdallowed&#39; own/sibling library)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="AlterPriority"
>AlterPriority</a></h2>

<pre>  AlterPriority( $where, $reserve_id, $prev_priority, $next_priority, $first_priority, $last_priority );</pre>

<p>This function changes a reserve&#39;s priority up, down, to the top, or to the bottom. Input: $where is &#39;up&#39;, &#39;down&#39;, &#39;top&#39; or &#39;bottom&#39;. Biblionumber, Date reserve was placed</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ToggleLowestPriority"
>ToggleLowestPriority</a></h2>

<pre>  ToggleLowestPriority( $borrowernumber, $biblionumber );</pre>

<p>This function sets the lowestPriority field to true if is false, and false if it is true.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ToggleSuspend"
>ToggleSuspend</a></h2>

<pre>  ToggleSuspend( $reserve_id );</pre>

<p>This function sets the suspend field to true if is false, and false if it is true. If the reserve is currently suspended with a suspend_until date, that date will be cleared when it is unsuspended.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="SuspendAll"
>SuspendAll</a></h2>

<pre>  SuspendAll(
      borrowernumber   =&#62; $borrowernumber,
      [ biblionumber   =&#62; $biblionumber, ]
      [ suspend_until  =&#62; $suspend_until, ]
      [ suspend        =&#62; $suspend ]
  );

  This function accepts a set of hash keys as its parameters.
  It requires either borrowernumber or biblionumber, or both.

  suspend_until is wholly optional.</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_FixPriority"
>_FixPriority</a></h2>

<pre>  _FixPriority({
    reserve_id =&#62; $reserve_id,
    [rank =&#62; $rank,]
    [ignoreSetLowestRank =&#62; $ignoreSetLowestRank]
  });

  or

  _FixPriority({ biblionumber =&#62; $biblionumber});</pre>

<p>This routine adjusts the priority of a hold request and holds on the same bib.</p>

<p>In the first form, where a reserve_id is passed, the priority of the hold is set to supplied rank, and other holds for that bib are adjusted accordingly. If the rank is &#34;del&#34;, the hold is cancelled. If no rank is supplied, all of the holds on that bib have their priority adjusted as if the second form had been used.</p>

<p>In the second form, where a biblionumber is passed, the holds on that bib (that are not captured) are sorted in order of increasing priority, then have reserves.priority set so that the first non-captured hold has its priority set to 1, the second non-captured hold has its priority set to 2, and so forth.</p>

<p>In both cases, holds that have the lowestPriority flag on are have their priority adjusted to ensure that they remain at the end of the line.</p>

<p>Note that the ignoreSetLowestRank parameter is meant to be used only when _FixPriority calls itself.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_Findgroupreserve"
>_Findgroupreserve</a></h2>

<pre>  @results = &#38;_Findgroupreserve($biblioitemnumber, $biblionumber, $itemnumber, $lookahead, $ignore_borrowers);</pre>

<p>Looks for a holds-queue based item-specific match first, then for a holds-queue title-level match, returning the first match found. If neither, then we look for non-holds-queue based holds. Lookahead is the number of days to look in advance.</p>

<p><code>&#38;_Findgroupreserve</code> returns : <code>@results</code> is an array of references-to-hash whose keys are mostly fields from the reserves table of the Koha database, plus <code>biblioitemnumber</code>.</p>

<p>This routine with either return: 1 - Item specific holds from the holds queue 2 - Title level holds from the holds queue 3 - All holds for this biblionumber</p>

<p>All return values will respect any borrowernumbers passed as arrayref in $ignore_borrowers</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_koha_notify_reserve"
>_koha_notify_reserve</a></h2>

<pre>  _koha_notify_reserve( $hold-&#62;reserve_id );</pre>

<p>Sends a notification to the patron that their hold has been filled (through ModReserveAffect)</p>

<p>The letter code for this notice may be found using the following query:</p>

<pre>    select distinct letter_code
    from message_transports
    inner join message_attributes using (message_attribute_id)
    where message_name = &#39;Hold_Filled&#39;</pre>

<p>This will probably sipmly be &#39;HOLD&#39;, but because it is defined in the database, it is subject to addition or change.</p>

<p>The following tables are availalbe witin the notice:</p>

<pre>    branches
    borrowers
    biblio
    biblioitems
    reserves
    items</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_koha_notify_hold_changed"
>_koha_notify_hold_changed</a></h2>

<pre>  _koha_notify_hold_changed( $hold_object );</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_ShiftPriority"
>_ShiftPriority</a></h2>

<pre>  $new_priority = _ShiftPriority( $biblionumber, $priority );</pre>

<p>This increments the priority of all reserves after the one with either the lowest date after <code>$reservedate</code> or the lowest priority after <code>$priority</code>.</p>

<p>It effectively makes room for a new reserve to be inserted with a certain priority, which is returned.</p>

<p>This is most useful when the reservedate can be set by the user. It allows the new reserve to be placed before other reserves that have a later reservedate. Since priority also is set by the form in reserves/request.pl the sub accounts for that too.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="MoveReserve"
>MoveReserve</a></h2>

<pre>  MoveReserve( $itemnumber, $borrowernumber, $cancelreserve )</pre>

<p>Use when checking out an item to handle reserves If $cancelreserve boolean is set to true, it will remove existing reserve</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="MergeHolds"
>MergeHolds</a></h2>

<pre>  MergeHolds($dbh,$to_biblio, $from_biblio);</pre>

<p>This shifts the holds from <code>$from_biblio</code> to <code>$to_biblio</code> and reorders them by the date they were placed</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="RevertWaitingStatus"
>RevertWaitingStatus</a></h2>

<pre>  RevertWaitingStatus({ itemnumber =&#62; $itemnumber });

  Reverts a &#39;waiting&#39; hold back to a regular hold with a priority of 1.

  Caveat: Any waiting hold fixed with RevertWaitingStatus will be an
          item level hold, even if it was only a bibliolevel hold to
          begin with. This is because we can no longer know if a hold
          was item-level or bib-level after a hold has been set to
          waiting status.</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ReserveSlip"
>ReserveSlip</a></h2>

<p>ReserveSlip( { branchcode =&#62; $branchcode, borrowernumber =&#62; $borrowernumber, biblionumber =&#62; $biblionumber, [ itemnumber =&#62; $itemnumber, ] [ barcode =&#62; $barcode, ] } )</p>

<p>Returns letter hash ( see C4::Letters::GetPreparedLetter ) or undef</p>

<p>The letter code will be HOLD_SLIP, and the following tables are available within the slip:</p>

<pre>    reserves
    branches
    borrowers
    biblio
    biblioitems
    items</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetReservesControlBranch"
>GetReservesControlBranch</a></h2>

<pre>  my $reserves_control_branch = GetReservesControlBranch($item, $borrower);

  Return the branchcode to be used to determine which reserves
  policy applies to a transaction.

  C&#60;$item&#62; is a hashref for an item. Only &#39;homebranch&#39; is used.

  C&#60;$borrower&#62; is a hashref to borrower. Only &#39;branchcode&#39; is used.</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CalculatePriority"
>CalculatePriority</a></h2>

<pre>    my $p = CalculatePriority($biblionumber, $resdate);</pre>

<p>Calculate priority for a new reserve on biblionumber, placing it at the end of the line of all holds whose start date falls before the current system time and that are neither on the hold shelf or in transit.</p>

<p>The reserve date parameter is optional; if it is supplied, the priority is based on the set of holds whose start date falls before the parameter value.</p>

<p>After calculation of this priority, it is recommended to call _ShiftPriority. Note that this is currently done in AddReserves.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="IsItemOnHoldAndFound"
>IsItemOnHoldAndFound</a></h2>

<pre>    my $bool = IsItemFoundHold( $itemnumber );

    Returns true if the item is currently on hold
    and that hold has a non-null found status ( W, T, etc. )</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMaxPatronHoldsForRecord"
>GetMaxPatronHoldsForRecord</a></h2>

<p>my $holds_per_record = ReservesControlBranch( $borrowernumber, $biblionumber );</p>

<p>For multiple holds on a given record for a given patron, the max number of record level holds that a patron can be placed is the highest value of the holds_per_record rule for each item if the record for that patron. This subroutine finds and returns the highest holds_per_record rule value for a given patron id and record id.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Koha Development Team &#60;http://koha-community.org/&#62;</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
