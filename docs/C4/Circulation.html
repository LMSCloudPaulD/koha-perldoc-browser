<html><head><title>C4::Circulation</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../_whtpurk.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Sat Jan  6 06:10:04 2024 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#barcodedecode'>barcodedecode</a>
    <li class='indexItem indexItem2'><a href='#_decode'>_decode</a>
    <li class='indexItem indexItem2'><a href='#transferbook'>transferbook</a>
    <li class='indexItem indexItem2'><a href='#CanBookBeIssued'>CanBookBeIssued</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#INVALID_DATE'>INVALID_DATE</a>
      <li class='indexItem indexItem3'><a href='#GNA'>GNA</a>
      <li class='indexItem indexItem3'><a href='#CARD_LOST'>CARD_LOST</a>
      <li class='indexItem indexItem3'><a href='#DEBARRED'>DEBARRED</a>
      <li class='indexItem indexItem3'><a href='#UNKNOWN_BARCODE'>UNKNOWN_BARCODE</a>
      <li class='indexItem indexItem3'><a href='#NOT_FOR_LOAN'>NOT_FOR_LOAN</a>
      <li class='indexItem indexItem3'><a href='#WTHDRAWN'>WTHDRAWN</a>
      <li class='indexItem indexItem3'><a href='#RESTRICTED'>RESTRICTED</a>
      <li class='indexItem indexItem3'><a href='#DEBT'>DEBT</a>
      <li class='indexItem indexItem3'><a href='#RENEW_ISSUE'>RENEW_ISSUE</a>
      <li class='indexItem indexItem3'><a href='#ISSUED_TO_ANOTHER'>ISSUED_TO_ANOTHER</a>
      <li class='indexItem indexItem3'><a href='#RESERVED'>RESERVED</a>
      <li class='indexItem indexItem3'><a href='#TRANSFERRED'>TRANSFERRED</a>
      <li class='indexItem indexItem3'><a href='#INVALID_DATE'>INVALID_DATE</a>
      <li class='indexItem indexItem3'><a href='#TOO_MANY'>TOO_MANY</a>
      <li class='indexItem indexItem3'><a href='#RECALLED'>RECALLED</a>
    </ul>
    <li class='indexItem indexItem2'><a href='#CanBookBeReturned'>CanBookBeReturned</a>
    <li class='indexItem indexItem2'><a href='#CheckHighHolds'>CheckHighHolds</a>
    <li class='indexItem indexItem2'><a href='#AddIssue'>AddIssue</a>
    <li class='indexItem indexItem2'><a href='#GetLoanLength'>GetLoanLength</a>
    <li class='indexItem indexItem2'><a href='#GetHardDueDate'>GetHardDueDate</a>
    <li class='indexItem indexItem2'><a href='#GetBranchBorrowerCircRule'>GetBranchBorrowerCircRule</a>
    <li class='indexItem indexItem2'><a href='#GetBranchItemRule'>GetBranchItemRule</a>
    <li class='indexItem indexItem2'><a href='#AddReturn'>AddReturn</a>
    <li class='indexItem indexItem2'><a href='#MarkIssueReturned'>MarkIssueReturned</a>
    <li class='indexItem indexItem2'><a href='#_debar_user_on_return'>_debar_user_on_return</a>
    <li class='indexItem indexItem2'><a href='#_FixOverduesOnReturn'>_FixOverduesOnReturn</a>
    <li class='indexItem indexItem2'><a href='#_GetCircControlBranch'>_GetCircControlBranch</a>
    <li class='indexItem indexItem2'><a href='#GetUpcomingDueIssues'>GetUpcomingDueIssues</a>
    <li class='indexItem indexItem2'><a href='#CanBookBeRenewed'>CanBookBeRenewed</a>
    <li class='indexItem indexItem2'><a href='#AddRenewal'>AddRenewal</a>
    <li class='indexItem indexItem2'><a href='#GetSoonestRenewDate'>GetSoonestRenewDate</a>
    <li class='indexItem indexItem2'><a href='#GetLatestAutoRenewDate'>GetLatestAutoRenewDate</a>
    <li class='indexItem indexItem2'><a href='#GetIssuingCharges'>GetIssuingCharges</a>
    <li class='indexItem indexItem2'><a href='#AddIssuingCharge'>AddIssuingCharge</a>
    <li class='indexItem indexItem2'><a href='#GetTransfersFromTo'>GetTransfersFromTo</a>
    <li class='indexItem indexItem2'><a href='#SendCirculationAlert'>SendCirculationAlert</a>
    <li class='indexItem indexItem2'><a href='#updateWrongTransfer'>updateWrongTransfer</a>
    <li class='indexItem indexItem2'><a href='#CalcDateDue'>CalcDateDue</a>
    <li class='indexItem indexItem2'><a href='#IsBranchTransferAllowed'>IsBranchTransferAllowed</a>
    <li class='indexItem indexItem2'><a href='#CreateBranchTransferLimit'>CreateBranchTransferLimit</a>
    <li class='indexItem indexItem2'><a href='#DeleteBranchTransferLimits'>DeleteBranchTransferLimits</a>
    <li class='indexItem indexItem2'><a href='#LostItem'>LostItem</a>
    <li class='indexItem indexItem2'><a href='#TransferSlip'>TransferSlip</a>
    <li class='indexItem indexItem2'><a href='#CheckIfIssuedToPatron'>CheckIfIssuedToPatron</a>
    <li class='indexItem indexItem2'><a href='#IsItemIssued'>IsItemIssued</a>
    <li class='indexItem indexItem2'><a href='#GetAgeRestriction'>GetAgeRestriction</a>
    <li class='indexItem indexItem2'><a href='#GetPendingOnSiteCheckouts'>GetPendingOnSiteCheckouts</a>
    <li class='indexItem indexItem2'><a href='#Internal_methods'>Internal methods</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>C4::Circulation - Koha circulation module</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p>use C4::Circulation;</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>The functions in this module deal with circulation,
issues,
and returns,
as well as general information about the library.
Also deals with inventory.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="barcodedecode"
>barcodedecode</a></h2>

<pre>  $str = &#38;barcodedecode($barcode, [$filter]);</pre>

<p>Generic filter function for barcode string. Called on every circ if the System Pref itemBarcodeInputFilter is set. Will do some manipulation of the barcode for systems that deliver a barcode to circulation.pl that differs from the barcode stored for the item. For proper functioning of this filter, calling the function on the correct barcode string (items.barcode) should return an unaltered barcode. Barcode is going to be automatically trimmed of leading/trailing whitespaces.</p>

<p>The optional $filter argument is to allow for testing or explicit behavior that ignores the System Pref. Valid values are the same as the System Pref options.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_decode"
>_decode</a></h2>

<pre>  $str = &#38;_decode($chunk);</pre>

<p>Decodes a segment of a string emitted by a CueCat barcode scanner and returns it.</p>

<p>FIXME: Should be replaced with Barcode::Cuecat from CPAN or Javascript based decoding on the client side.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="transferbook"
>transferbook</a></h2>

<pre>  ($dotransfer, $messages, $iteminformation) = &#38;transferbook({
                                                   from_branch =&#62; $frombranch
                                                   to_branch =&#62; $tobranch,
                                                   barcode =&#62; $barcode,
                                                   ignore_reserves =&#62; $ignore_reserves,
                                                   trigger =&#62; $trigger
                                                });</pre>

<p>Transfers an item to a new branch. If the item is currently on loan, it is automatically returned before the actual transfer.</p>

<p><code>$fbr</code> is the code for the branch initiating the transfer. <code>$tbr</code> is the code for the branch to which the item should be transferred.</p>

<p><code>$barcode</code> is the barcode of the item to be transferred.</p>

<p>If <code>$ignore_reserves</code> is true, <code>&#38;transferbook</code> ignores reserves. Otherwise, if an item is reserved, the transfer fails.</p>

<p><code>$trigger</code> is the enum value for what triggered the transfer.</p>

<p>Returns three values:</p>

<dl>
<dt><a name="$dotransfer"
>$dotransfer</a></dt>

<dd>
<p>is true if the transfer was successful.</p>

<dt><a name="$messages"
>$messages</a></dt>

<dd>
<p>is a reference-to-hash which may have any of the following keys:</p>

<dl>
<dt><a name="BadBarcode"
><code>BadBarcode</code></a></dt>

<dd>
<p>There is no item in the catalog with the given barcode. The value is <code>$barcode</code>.</p>

<dt><a name="DestinationEqualsHolding"
><code>DestinationEqualsHolding</code></a></dt>

<dd>
<p>The item is already at the branch to which it is being transferred. The transfer is nonetheless considered to have failed. The value should be ignored.</p>

<dt><a name="WasReturned"
><code>WasReturned</code></a></dt>

<dd>
<p>The item was on loan, and <code>&#38;transferbook</code> automatically returned it before transferring it. The value is the borrower number of the patron who had the item.</p>

<dt><a name="ResFound"
><code>ResFound</code></a></dt>

<dd>
<p>The item was reserved. The value is a reference-to-hash whose keys are fields from the reserves table of the Koha database, and <code>biblioitemnumber</code>. It also has the key <code>ResFound</code>, whose value is either <code>Waiting</code> or <code>Reserved</code>.</p>

<dt><a name="WasTransferred"
><code>WasTransferred</code></a></dt>

<dd>
<p>The item was eligible to be transferred. Barring problems communicating with the database, the transfer should indeed have succeeded. The value should be ignored.</p>

<dt><a name="RecallPlacedAtHoldingBranch"
><code>RecallPlacedAtHoldingBranch</code></a></dt>

<dd>
<p>A recall for this item was found, and the transfer has already been completed as the item&#39;s branch matches the recall&#39;s pickup branch.</p>

<dt><a name="RecallFound"
><code>RecallFound</code></a></dt>

<dd>
<p>A recall for this item was found, and the item needs to be transferred to the recall&#39;s pickup branch.</p>
</dd>
</dl>
</dd>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CanBookBeIssued"
>CanBookBeIssued</a></h2>

<pre>  ( $issuingimpossible, $needsconfirmation, [ $alerts ] ) =  CanBookBeIssued( $patron,
                      $barcode, $duedate, $inprocess, $ignore_reserves, $params );</pre>

<p>Check if a book can be issued.</p>

<p><code>$issuingimpossible</code> and <code>$needsconfirmation</code> are hashrefs.</p>

<p>IMPORTANT: The assumption by users of this routine is that causes blocking the issue are keyed by uppercase labels and other returned data is keyed in lower case!</p>

<dl>
<dt><a name="$patron_is_a_Koha::Patron"
><code>$patron</code> is a Koha::Patron</a></dt>

<dd>
<dt><a name="$barcode_is_the_bar_code_of_the_book_being_issued."
><code>$barcode</code> is the bar code of the book being issued.</a></dt>

<dd>
<dt><a name="$duedates_is_a_DateTime_object."
><code>$duedates</code> is a DateTime object.</a></dt>

<dd>
<dt><a name="$inprocess_boolean_switch"
><code>$inprocess</code> boolean switch</a></dt>

<dd>
<dt><a name="$ignore_reserves_boolean_switch"
><code>$ignore_reserves</code> boolean switch</a></dt>

<dd>
<dt><a name="$params_Hashref_of_additional_parameters"
><code>$params</code> Hashref of additional parameters</a></dt>

<dd>
<p>Available keys: override_high_holds - Ignore high holds onsite_checkout - Checkout is an onsite checkout that will not leave the library item - Optionally pass the object for the item we are checking out to save a lookup</p>
</dd>
</dl>

<p>Returns :</p>

<dl>
<dt><a name="$issuingimpossible_a_reference_to_a_hash._It_contains_reasons_why_issuing_is_impossible._Possible_values_are_:"
><code>$issuingimpossible</code> a reference to a hash. It contains reasons why issuing is impossible. Possible values are :</a></dt>
</dl>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="INVALID_DATE"
>INVALID_DATE</a></h3>

<p>sticky due date is invalid</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="GNA"
>GNA</a></h3>

<p>borrower gone with no address</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="CARD_LOST"
>CARD_LOST</a></h3>

<p>borrower declared it&#39;s card lost</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="DEBARRED"
>DEBARRED</a></h3>

<p>borrower debarred</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="UNKNOWN_BARCODE"
>UNKNOWN_BARCODE</a></h3>

<p>barcode unknown</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="NOT_FOR_LOAN"
>NOT_FOR_LOAN</a></h3>

<p>item is not for loan</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="WTHDRAWN"
>WTHDRAWN</a></h3>

<p>item withdrawn.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="RESTRICTED"
>RESTRICTED</a></h3>

<p>item is restricted (set by ??)</p>

<p><code>$needsconfirmation</code> a reference to a hash. It contains reasons why the loan could be prevented, but ones that can be overriden by the operator.</p>

<p>Possible values are :</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="DEBT"
>DEBT</a></h3>

<p>borrower has debts.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="RENEW_ISSUE"
>RENEW_ISSUE</a></h3>

<p>renewing, not issuing</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="ISSUED_TO_ANOTHER"
>ISSUED_TO_ANOTHER</a></h3>

<p>issued to someone else.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="RESERVED"
>RESERVED</a></h3>

<p>reserved for someone else.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="TRANSFERRED"
>TRANSFERRED</a></h3>

<p>reserved and being transferred for someone else.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="INVALID_DATE"
>INVALID_DATE</a></h3>

<p>sticky due date is invalid or due date in the past</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="TOO_MANY"
>TOO_MANY</a></h3>

<p>if the borrower borrows to much things</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="RECALLED"
>RECALLED</a></h3>

<p>recalled by someone else</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CanBookBeReturned"
>CanBookBeReturned</a></h2>

<pre>  ($returnallowed, $message) = CanBookBeReturned($item, $branch)</pre>

<p>Check whether the item can be returned to the provided branch</p>

<dl>
<dt><a name="$item_is_a_hash_of_item_information_as_returned_Koha::Items-&#62;find-&#62;unblessed_(Temporary,_should_be_a_Koha::Item_instead)"
><code>$item</code> is a hash of item information as returned Koha::Items-&#62;find-&#62;unblessed (Temporary, should be a Koha::Item instead)</a></dt>

<dd>
<dt><a name="$branch_is_the_branchcode_where_the_return_is_taking_place"
><code>$branch</code> is the branchcode where the return is taking place</a></dt>
</dl>

<p>Returns:</p>

<dl>
<dt><a name="$returnallowed_is_0_or_1,_corresponding_to_whether_the_return_is_allowed_(1)_or_not_(0)"
><code>$returnallowed</code> is 0 or 1, corresponding to whether the return is allowed (1) or not (0)</a></dt>

<dd>
<dt><a name="$message_is_the_branchcode_where_the_item_SHOULD_be_returned,_if_the_return_is_not_allowed"
><code>$message</code> is the branchcode where the item SHOULD be returned, if the return is not allowed</a></dt>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CheckHighHolds"
>CheckHighHolds</a></h2>

<pre>    used when syspref decreaseLoanHighHolds is active. Returns 1 or 0 to define whether the minimum value held in
    decreaseLoanHighHoldsValue is exceeded, the total number of outstanding holds, the number of days the loan
    has been decreased to (held in syspref decreaseLoanHighHoldsValue), and the new due date</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="AddIssue"
>AddIssue</a></h2>

<pre>  &#38;AddIssue($patron, $barcode, [$datedue], [$cancelreserve], [$issuedate])</pre>

<p>Issue a book. Does no check, they are done in CanBookBeIssued. If we reach this sub, it means the user confirmed if needed.</p>

<dl>
<dt><a name="$patron_is_a_patron_object."
><code>$patron</code> is a patron object.</a></dt>

<dd>
<dt><a name="$barcode_is_the_barcode_of_the_item_being_issued."
><code>$barcode</code> is the barcode of the item being issued.</a></dt>

<dd>
<dt><a name="$datedue_is_a_DateTime_object_for_the_max_date_of_return,_i.e._the_date_due_(optional)._Calculated_if_empty."
><code>$datedue</code> is a DateTime object for the max date of return, i.e. the date due (optional). Calculated if empty.</a></dt>

<dd>
<dt><a name="$cancelreserve_is_1_to_override_and_cancel_any_pending_reserves_for_the_item_(optional)."
><code>$cancelreserve</code> is 1 to override and cancel any pending reserves for the item (optional).</a></dt>

<dd>
<dt><a name="$issuedate_is_a_DateTime_object_for_the_date_to_issue_the_item_(optional)._Defaults_to_today."
><code>$issuedate</code> is a DateTime object for the date to issue the item (optional). Defaults to today.</a></dt>

<dd>
<p>AddIssue does the following things :</p>

<pre>  - step 01: check that there is a borrowernumber &#38; a barcode provided
  - check for RENEWAL (book issued &#38; being issued to the same patron)
      - renewal YES = Calculate Charge &#38; renew
      - renewal NO  =
          * BOOK ACTUALLY ISSUED ? do a return if book is actually issued (but to someone else)
          * RESERVE PLACED ?
              - fill reserve if reserve to this patron
              - cancel reserve or not, otherwise
          * RECALL PLACED ?
              - fill recall if recall to this patron
              - cancel recall or not
              - revert recall&#39;s waiting status or not
          * TRANSFERT PENDING ?
              - complete the transfert
          * ISSUE THE BOOK</pre>
</dd>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetLoanLength"
>GetLoanLength</a></h2>

<pre>  my $loanlength = &#38;GetLoanLength($borrowertype,$itemtype,branchcode)</pre>

<p>Get loan length for an itemtype, a borrower type and a branch</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetHardDueDate"
>GetHardDueDate</a></h2>

<pre>  my ($hardduedate,$hardduedatecompare) = &#38;GetHardDueDate($borrowertype,$itemtype,branchcode)</pre>

<p>Get the Hard Due Date and it&#39;s comparison for an itemtype, a borrower type and a branch</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetBranchBorrowerCircRule"
>GetBranchBorrowerCircRule</a></h2>

<pre>  my $branch_cat_rule = GetBranchBorrowerCircRule($branchcode, $categorycode);</pre>

<p>Retrieves circulation rule attributes that apply to the given branch and patron category, regardless of item type. The return value is a hashref containing the following key:</p>

<p>patron_maxissueqty - maximum number of loans that a patron of the given category can have at the given branch. If the value is undef, no limit.</p>

<p>patron_maxonsiteissueqty - maximum of on-site checkouts that a patron of the given category can have at the given branch. If the value is undef, no limit.</p>

<p>This will check for different branch/category combinations in the following order: branch and category branch only category only default branch and category</p>

<p>If no rule has been found in the database, it will default to the buillt in rule:</p>

<p>patron_maxissueqty - undef patron_maxonsiteissueqty - undef</p>

<p><code>$branchcode</code> and <code>$categorycode</code> should contain the literal branch code and patron category code, respectively - no wildcards.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetBranchItemRule"
>GetBranchItemRule</a></h2>

<pre>  my $branch_item_rule = GetBranchItemRule($branchcode, $itemtype);</pre>

<p>Retrieves circulation rule attributes that apply to the given branch and item type, regardless of patron category.</p>

<p>The return value is a hashref containing the following keys:</p>

<p>holdallowed =&#62; Hold policy for this branch and itemtype. Possible values: not_allowed: No holds allowed. from_home_library: Holds allowed only by patrons that have the same homebranch as the item. from_any_library: Holds allowed from any patron. from_local_hold_group: Holds allowed from libraries in hold group</p>

<p>This searches branchitemrules in the following order:</p>

<pre>  * Same branchcode and itemtype
  * Same branchcode, itemtype &#39;*&#39;
  * branchcode &#39;*&#39;, same itemtype
  * branchcode and itemtype &#39;*&#39;</pre>

<p>Neither <code>$branchcode</code> nor <code>$itemtype</code> should be &#39;*&#39;.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="AddReturn"
>AddReturn</a></h2>

<pre>  ($doreturn, $messages, $iteminformation, $borrower) =
      &#38;AddReturn( $barcode, $branch [,$exemptfine] [,$returndate] );</pre>

<p>Returns a book.</p>

<dl>
<dt><a name="$barcode_is_the_bar_code_of_the_book_being_returned."
><code>$barcode</code> is the bar code of the book being returned.</a></dt>

<dd>
<dt><a name="$branch_is_the_code_of_the_branch_where_the_book_is_being_returned."
><code>$branch</code> is the code of the branch where the book is being returned.</a></dt>

<dd>
<dt><a name="$exemptfine_indicates_that_overdue_charges_for_the_item_will_be_removed._Optional."
><code>$exemptfine</code> indicates that overdue charges for the item will be removed. Optional.</a></dt>

<dd>
<dt><a name="$return_date_allows_the_default_return_date_to_be_overridden_by_the_given_return_date._Optional."
><code>$return_date</code> allows the default return date to be overridden by the given return date. Optional.</a></dt>
</dl>

<p><code>&#38;AddReturn</code> returns a list of four items:</p>

<p><code>$doreturn</code> is true iff the return succeeded.</p>

<p><code>$messages</code> is a reference-to-hash giving feedback on the operation. The keys of the hash are:</p>

<dl>
<dt><a name="BadBarcode"
><code>BadBarcode</code></a></dt>

<dd>
<p>No item with this barcode exists. The value is <code>$barcode</code>.</p>

<dt><a name="NotIssued"
><code>NotIssued</code></a></dt>

<dd>
<p>The book is not currently on loan. The value is <code>$barcode</code>.</p>

<dt><a name="withdrawn"
><code>withdrawn</code></a></dt>

<dd>
<p>This book has been withdrawn/cancelled. The value should be ignored.</p>

<dt><a name="Wrongbranch"
><code>Wrongbranch</code></a></dt>

<dd>
<p>This book has was returned to the wrong branch. The value is a hashref so that <code>$messages-</code>{Wrongbranch}-&#62;{Wrongbranch}&#62; and <code>$messages-</code>{Wrongbranch}-&#62;{Rightbranch}&#62; contain the branchcode of the incorrect and correct return library, respectively.</p>

<dt><a name="ResFound"
><code>ResFound</code></a></dt>

<dd>
<p>The item was reserved. The value is a reference-to-hash whose keys are fields from the reserves table of the Koha database, and <code>biblioitemnumber</code>. It also has the key <code>ResFound</code>, whose value is either <code>Waiting</code>, <code>Reserved</code>, or 0.</p>

<dt><a name="WasReturned"
><code>WasReturned</code></a></dt>

<dd>
<p>Value 1 if return is successful.</p>

<dt><a name="NeedsTransfer"
><code>NeedsTransfer</code></a></dt>

<dd>
<p>If AutomaticItemReturn is disabled, return branch is given as value of NeedsTransfer.</p>

<dt><a name="RecallFound"
><code>RecallFound</code></a></dt>

<dd>
<p>This item can fill a recall. The recall object is returned. If the recall pickup branch differs from the branch this item is being returned at, <code>RecallNeedsTransfer</code> is also returned which contains this branchcode.</p>

<dt><a name="TransferredRecall"
><code>TransferredRecall</code></a></dt>

<dd>
<p>This item has been transferred to this branch to fill a recall. The recall object is returned.</p>
</dd>
</dl>

<p><code>$iteminformation</code> is a reference-to-hash, giving information about the returned item from the issues table.</p>

<p><code>$borrower</code> is a reference-to-hash, giving information about the patron who last borrowed the book.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="MarkIssueReturned"
>MarkIssueReturned</a></h2>

<pre>  MarkIssueReturned($borrowernumber, $itemnumber, $returndate, $privacy, [$params] );</pre>

<p>Unconditionally marks an issue as being returned by moving the <code>issues</code> row to <code>old_issues</code> and setting <code>returndate</code> to the current date.</p>

<p>if <code>$returndate</code> is specified (in iso format), it is used as the date of the return.</p>

<p><code>$privacy</code> contains the privacy parameter. If the patron has set privacy to 2, the old_issue is immediately anonymised</p>

<p>Ideally, this function would be internal to <code>C4::Circulation</code>, not exported, but it is currently used in misc/cronjobs/longoverdue.pl and offline_circ/process_koc.pl.</p>

<p>The last optional parameter allos passing skip_record_index to the item store call.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_debar_user_on_return"
>_debar_user_on_return</a></h2>

<pre>    _debar_user_on_return($patron, $item, $datedue, $returndate);</pre>

<p><code>$patron</code> patron object</p>

<p><code>$item</code> item object</p>

<p><code>$datedue</code> date due DateTime object</p>

<p><code>$returndate</code> DateTime object representing the return time</p>

<p>Internal function, called only by AddReturn that calculates and updates the user fine days, and debars them if necessary.</p>

<p>Should only be called for overdue returns</p>

<p>Calculation of the debarment date has been moved to a separate subroutine _calculate_new_debar_dt to ease testing.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_FixOverduesOnReturn"
>_FixOverduesOnReturn</a></h2>

<pre>   &#38;_FixOverduesOnReturn($borrowernumber, $itemnumber, $exemptfine, $status);</pre>

<p><code>$borrowernumber</code> borrowernumber</p>

<p><code>$itemnumber</code> itemnumber</p>

<p><code>$exemptfine</code> BOOL -- remove overdue charge associated with this issue.</p>

<p><code>$status</code> ENUM -- reason for fix [ RETURNED, RENEWED, LOST, FORGIVEN ]</p>

<p>Internal function</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_GetCircControlBranch"
>_GetCircControlBranch</a></h2>

<pre>   my $circ_control_branch = _GetCircControlBranch($item, $patron);</pre>

<p>Internal function :</p>

<p>Return the library code to be used to determine which circulation policy applies to a transaction. Looks up the CircControl and HomeOrHoldingBranch system preferences.</p>

<p><code>$item</code> is an item object.</p>

<p><code>$patron</code> is a patron object.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetUpcomingDueIssues"
>GetUpcomingDueIssues</a></h2>

<pre>  my $upcoming_dues = GetUpcomingDueIssues( { days_in_advance =&#62; 4 } );</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CanBookBeRenewed"
>CanBookBeRenewed</a></h2>

<pre>  ($ok,$error,$info) = &#38;CanBookBeRenewed($patron, $issue, $override_limit, $cron);</pre>

<p>Find out whether a borrowed item may be renewed.</p>

<p><code>$patron</code> is the patron who currently has the issue.</p>

<p><code>$issue</code> is the checkout to renew.</p>

<p><code>$cron</code> true or false, specifies if this check is being made by the automatic_renewals.pl cronscript</p>

<p><code>$override_limit</code>, if supplied with a true value, causes the limit on the number of times that the loan can be renewed (as controlled by the item type) to be ignored. Overriding also allows to renew sooner than &#34;No renewal before&#34; and to manually renew loans that are automatically renewed.</p>

<p><code>$CanBookBeRenewed</code> returns a true value if the item may be renewed. The item must currently be on loan to the specified borrower; renewals must be allowed for the item&#39;s type; and the borrower must not have already renewed the loan. $error will contain the reason the renewal can not proceed $info will contain a hash of additional info currently &#39;soonest_renew_date&#39; if error is &#39;too soon&#39;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="AddRenewal"
>AddRenewal</a></h2>

<pre>  $new_date_due = AddRenewal({
      borrowernumber   =&#62; $borrowernumber,
      itemnumber       =&#62; $itemnumber,
      branch           =&#62; $branch,
      [datedue         =&#62; $datedue],
      [lastreneweddate =&#62; $lastreneweddate],
      [skipfinecalc    =&#62; $skipfinecalc],
      [seen            =&#62; $seen],
      [automatic       =&#62; $automatic],
      [skip_record_index =&#62; $skip_record_index]
  });</pre>

<p>Renews a loan, returns the updated due date upon success.</p>

<p><code>$borrowernumber</code> is the borrower number of the patron who currently has the item.</p>

<p><code>$itemnumber</code> is the number of the item to renew.</p>

<p><code>$branch</code> is the library where the renewal took place (if any). The library that controls the circ policies for the renewal is retrieved from the issues record.</p>

<p><code>$datedue</code> can be a DateTime object used to set the due date.</p>

<p><code>$lastreneweddate</code> is an optional ISO-formatted date used to set issues.lastreneweddate. If this parameter is not supplied, lastreneweddate is set to the current date.</p>

<p><code>$skipfinecalc</code> is an optional boolean. There may be circumstances where, even if the CalculateFinesOnReturn syspref is enabled, we don&#39;t want to calculate fines upon renew, for example, when we&#39;re renewing as a result of a fine being paid (see RenewAccruingItemWhenPaid syspref)</p>

<p>If <code>$datedue</code> is the empty string, <code>&#38;AddRenewal</code> will calculate the due date automatically from the book&#39;s item type.</p>

<p><code>$seen</code> is a boolean flag indicating if the item was seen or not during the renewal. This informs the incrementing of the unseen_renewals column. If this flag is not supplied, we fallback to a true value</p>

<p><code>$automatic</code> is a boolean flag indicating the renewal was triggered automatically and not by a person ( librarian or patron )</p>

<p><code>$skip_record_index</code> is an optional boolean flag to indicate whether queuing the search indexing should be skipped for this renewal.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetSoonestRenewDate"
>GetSoonestRenewDate</a></h2>

<pre>  $NoRenewalBeforeThisDate = &#38;GetSoonestRenewDate($patron, $issue);</pre>

<p>Find out the soonest possible renew date of a borrowed item.</p>

<p><code>$patron</code> is the patron who currently has the item on loan.</p>

<p><code>$issue</code> is the the item issue.</p>

<p><code>$is_auto</code> is this soonest renew date for an auto renewal?</p>

<p><code>$GetSoonestRenewDate</code> returns the DateTime of the soonest possible renew date, based on the value &#34;No renewal before&#34; of the applicable issuing rule. Returns the current date if the item can already be renewed, and returns undefined if the patron, item, or checkout cannot be found.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetLatestAutoRenewDate"
>GetLatestAutoRenewDate</a></h2>

<pre>  $NoAutoRenewalAfterThisDate = &#38;GetLatestAutoRenewDate($patron, $issue);</pre>

<p>Find out the latest possible auto renew date of a borrowed item.</p>

<p><code>$patron</code> is the patron who currently has the item on loan.</p>

<p><code>$issue</code> is the item issue.</p>

<p><code>$GetLatestAutoRenewDate</code> returns the DateTime of the latest possible auto renew date, based on the value &#34;No auto renewal after&#34; and the &#34;No auto renewal after (hard limit) of the applicable issuing rule. Returns undef if there is no date specify in the circ rules or if the patron, loan, or item cannot be found.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetIssuingCharges"
>GetIssuingCharges</a></h2>

<pre>  ($charge, $item_type) = &#38;GetIssuingCharges($itemnumber, $borrowernumber);</pre>

<p>Calculate how much it would cost for a given patron to borrow a given item, including any applicable discounts.</p>

<p><code>$itemnumber</code> is the item number of item the patron wishes to borrow.</p>

<p><code>$borrowernumber</code> is the patron&#39;s borrower number.</p>

<p><code>&#38;GetIssuingCharges</code> returns two values: <code>$charge</code> is the rental charge, and <code>$item_type</code> is the code for the item&#39;s item type (e.g., <code>VID</code> if it&#39;s a video).</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="AddIssuingCharge"
>AddIssuingCharge</a></h2>

<pre>  &#38;AddIssuingCharge( $checkout, $charge, $type )</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetTransfersFromTo"
>GetTransfersFromTo</a></h2>

<pre>  @results = GetTransfersFromTo($frombranch,$tobranch);</pre>

<p>Returns the list of pending transfers between $from and $to branch</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="SendCirculationAlert"
>SendCirculationAlert</a></h2>

<p>Send out a <code>check-in</code> or <code>checkout</code> alert using the messaging system.</p>

<p><b>Parameters</b>:</p>

<dl>
<dt><a name="type"
>type</a></dt>

<dd>
<p>Valid values for this parameter are: <code>CHECKIN</code> and <code>CHECKOUT</code>.</p>

<dt><a name="item"
>item</a></dt>

<dd>
<p>Hashref of information about the item being checked in or out.</p>

<dt><a name="borrower"
>borrower</a></dt>

<dd>
<p>Hashref of information about the borrower of the item.</p>

<dt><a name="branch"
>branch</a></dt>

<dd>
<p>The branchcode from where the checkout or check-in took place.</p>
</dd>
</dl>

<p><b>Example</b>:</p>

<pre>    SendCirculationAlert({
        type     =&#62; &#39;CHECKOUT&#39;,
        item     =&#62; $item,
        borrower =&#62; $borrower,
        branch   =&#62; $branch,
    });</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="updateWrongTransfer"
>updateWrongTransfer</a></h2>

<pre>  $items = updateWrongTransfer($itemNumber,$borrowernumber,$waitingAtLibrary,$FromLibrary);</pre>

<p>This function validate the line of brachtransfer but with the wrong destination (mistake from a librarian ...), and create a new line in branchtransfer from the actual library to the original library of reservation</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CalcDateDue"
>CalcDateDue</a></h2>

<p>$newdatedue = CalcDateDue($startdate,$itemtype,$branchcode,$borrower);</p>

<p>this function calculates the due date given the start date and configured circulation rules, checking against the holidays calendar as per the daysmode circulation rule. <code>$startdate</code> = DateTime object representing start date of loan period (assumed to be today) <code>$itemtype</code> = itemtype code of item in question <code>$branch</code> = location whose calendar to use <code>$patron</code> = Patron object <code>$isrenewal</code> = Boolean: is true if we want to calculate the date due for a renewal. Else is false.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="IsBranchTransferAllowed"
>IsBranchTransferAllowed</a></h2>

<pre>  $allowed = IsBranchTransferAllowed( $toBranch, $fromBranch, $code );</pre>

<p>Code is either an itemtype or collection doe depending on the pref BranchTransferLimitsType</p>

<p>Deprecated in favor of Koha::Item::Transfer::Limits-&#62;find/search and Koha::Item-&#62;can_be_transferred.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CreateBranchTransferLimit"
>CreateBranchTransferLimit</a></h2>

<pre>  CreateBranchTransferLimit( $toBranch, $fromBranch, $code );</pre>

<p>$code is either itemtype or collection code depending on what the pref BranchTransferLimitsType is set to.</p>

<p>Deprecated in favor of Koha::Item::Transfer::Limit-&#62;new.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="DeleteBranchTransferLimits"
>DeleteBranchTransferLimits</a></h2>

<pre>    my $result = DeleteBranchTransferLimits($frombranch);</pre>

<p>Deletes all the library transfer limits for one library. Returns the number of limits deleted, 0e0 if no limits were deleted, or undef if no arguments are supplied.</p>

<p>Deprecated in favor of Koha::Item::Transfer::Limits-&#62;search({ fromBranch =&#62; $fromBranch })-&#62;delete.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="LostItem"
>LostItem</a></h2>

<pre>  LostItem( $itemnumber, $mark_lost_from, $force_mark_returned, [$params] );</pre>

<p>The final optional parameter, <code>$params</code>, expected to contain &#39;skip_record_index&#39; key, which relayed down to Koha::Item/store, there it prevents calling of ModZebra index_records, which takes most of the time in batch adds/deletes: index_records better to be called later in <code>additem.pl</code> after the whole loop.</p>

<p>$params: skip_record_index =&#62; 1|0</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="TransferSlip"
>TransferSlip</a></h2>

<pre>  TransferSlip($user_branch, $itemnumber, $barcode, $to_branch)

  Returns letter hash ( see C4::Letters::GetPreparedLetter ) or undef</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CheckIfIssuedToPatron"
>CheckIfIssuedToPatron</a></h2>

<pre>  CheckIfIssuedToPatron($borrowernumber, $biblionumber)

  Return 1 if any record item is issued to patron, otherwise return 0</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="IsItemIssued"
>IsItemIssued</a></h2>

<pre>  IsItemIssued( $itemnumber )

  Return 1 if the item is on loan, otherwise return 0</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetAgeRestriction"
>GetAgeRestriction</a></h2>

<pre>  my ($ageRestriction, $daysToAgeRestriction) = GetAgeRestriction($record_restrictions, $borrower);
  my ($ageRestriction, $daysToAgeRestriction) = GetAgeRestriction($record_restrictions);

  if($daysToAgeRestriction &#60;= 0) { #Borrower is allowed to access this material, as they are older or as old as the agerestriction }
  if($daysToAgeRestriction &#62; 0) { #Borrower is this many days from meeting the agerestriction }</pre>

<p>@PARAM1 the koha.biblioitems.agerestriction value, like K18, PEGI 13, ... @PARAM2 a borrower-object with koha.borrowers.dateofbirth. (OPTIONAL) @RETURNS The age restriction age in years and the days to fulfill the age restriction for the given borrower. Negative days mean the borrower has gone past the age restriction age.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetPendingOnSiteCheckouts"
>GetPendingOnSiteCheckouts</a></h2>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Internal_methods"
>Internal methods</a></h2>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Koha Development Team &#60;http://koha-community.org/&#62;</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
