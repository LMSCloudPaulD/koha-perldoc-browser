<html><head><title>C4::Search</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Fri Apr  5 12:12:28 2024 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#FindDuplicate'>FindDuplicate</a>
    <li class='indexItem indexItem2'><a href='#SimpleSearch'>SimpleSearch</a>
    <li class='indexItem indexItem2'><a href='#getRecords'>getRecords</a>
    <li class='indexItem indexItem2'><a href='#_get_facets_data_from_record'>_get_facets_data_from_record</a>
    <li class='indexItem indexItem2'><a href='#_get_facets_from_zebra'>_get_facets_from_zebra</a>
    <li class='indexItem indexItem2'><a href='#_get_facet_from_result_set'>_get_facet_from_result_set</a>
    <li class='indexItem indexItem2'><a href='#_get_facets_info'>_get_facets_info</a>
    <li class='indexItem indexItem2'><a href='#getIndexes'>getIndexes</a>
    <li class='indexItem indexItem2'><a href='#buildQuery'>buildQuery</a>
    <li class='indexItem indexItem2'><a href='#_build_initial_query'>_build_initial_query</a>
    <li class='indexItem indexItem2'><a href='#searchResults'>searchResults</a>
    <li class='indexItem indexItem2'><a href='#enabled_staff_search_views'>enabled_staff_search_views</a>
    <li class='indexItem indexItem2'><a href='#z3950_search_args'>z3950_search_args</a>
    <li class='indexItem indexItem2'><a href='#GetDistinctValues(%24field)%3B'>GetDistinctValues($field);</a>
    <li class='indexItem indexItem2'><a href='#_ZOOM_event_loop'>_ZOOM_event_loop</a>
    <li class='indexItem indexItem2'><a href='#new_record_from_zebra'>new_record_from_zebra</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>C4::Search - Functions for searching the Koha catalog.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p>See opac/opac-search.pl or catalogue/search.pl for example of usage</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This module provides searching functions for Koha&#39;s bibliographic databases</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="FindDuplicate"
>FindDuplicate</a></h2>

<p>($biblionumber,$biblionumber,$title) = FindDuplicate($record);</p>

<p>This function attempts to find duplicate records using a hard-coded,
fairly simplistic algorithm</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="SimpleSearch"
>SimpleSearch</a></h2>

<p>( $error,
$results,
$total_hits ) = SimpleSearch( $query,
$offset,
$max_results,
[@servers],
[%options] );</p>

<p>This function provides a simple search API on the bibliographic catalog</p>

<dl>
<dt><a name="input_arg:"
><code>input arg:</code></a></dt>

<dd>
<pre>    * $query can be a simple keyword or a complete CCL query
    * @servers is optional. Defaults to biblioserver as found in koha-conf.xml
    * $offset - If present, represents the number of records at the beginning to omit. Defaults to 0
    * $max_results - if present, determines the maximum number of records to fetch. undef is All. defaults to undef.
    * %options is optional. (e.g. &#34;skip_normalize&#34; allows you to skip changing : to = )</pre>

<dt><a name="Return:"
><code>Return:</code></a></dt>

<dd>
<pre>    Returns an array consisting of three elements
    * $error is undefined unless an error is detected
    * $results is a reference to an array of records.
    * $total_hits is the number of hits that would have been returned with no limit

    If an error is returned the two other return elements are undefined. If error itself is undefined
    the other two elements are always defined</pre>

<dt><a name="usage_in_the_script:"
><code>usage in the script:</code></a></dt>
</dl>

<p>my ( $error, $marcresults, $total_hits ) = SimpleSearch($query);</p>

<p>if (defined $error) { $template-&#62;param(query_error =&#62; $error); warn &#34;error: &#34;.$error; output_html_with_http_headers $input, $cookie, $template-&#62;output; exit; }</p>

<p>my $hits = @{$marcresults}; my @results;</p>

<p>for my $r ( @{$marcresults} ) { my $marcrecord = MARC::File::USMARC::decode($r); my $biblio = TransformMarcToKoha({ record =&#62; $marcrecord });</p>

<pre>    #build the iarray of hashs for the template.
    push @results, {
        title           =&#62; $biblio-&#62;{&#39;title&#39;},
        subtitle        =&#62; $biblio-&#62;{&#39;subtitle&#39;},
        biblionumber    =&#62; $biblio-&#62;{&#39;biblionumber&#39;},
        author          =&#62; $biblio-&#62;{&#39;author&#39;},
        publishercode   =&#62; $biblio-&#62;{&#39;publishercode&#39;},
        publicationyear =&#62; $biblio-&#62;{&#39;publicationyear&#39;},
        };</pre>

<p>}</p>

<p>$template-&#62;param(result=&#62;\@results);</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="getRecords"
>getRecords</a></h2>

<p>( undef, $results_hashref, \@facets_loop ) = getRecords (</p>

<pre>        $koha_query,       $simple_query, $sort_by_ref,    $servers_ref,
        $results_per_page, $offset,       $branches,       $itemtypes,
        $query_type,       $scan,         $opac
    );</pre>

<p>The all singing, all dancing, multi-server, asynchronous, scanning, searching, record nabbing, facet-building</p>

<p>See verbose embedded documentation.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_get_facets_data_from_record"
>_get_facets_data_from_record</a></h2>

<pre>    C4::Search::_get_facets_data_from_record( $marc_record, $facets, $facets_counter );</pre>

<p>Internal function that extracts facets information from a MARC::Record object and populates $facets_counter for using in getRecords.</p>

<p>$facets is expected to be filled with C4::Koha::getFacets output (i.e. the configured facets for Zebra).</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_get_facets_from_zebra"
>_get_facets_from_zebra</a></h2>

<pre>    my $facets = _get_facets_from_zebra( $result_set )</pre>

<p>Retrieves facets for a specified result set. It loops through the facets defined in C4::Koha::getFacets and returns a hash with the following structure:</p>

<pre>   {  facet_idx =&#62; {
            facet_value =&#62; count
      },
      ...
   }</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_get_facet_from_result_set"
>_get_facet_from_result_set</a></h2>

<pre>    my $facet_values =
        C4::Search::_get_facet_from_result_set( $facet_idx, $result_set, $sep )</pre>

<p>Internal function that extracts facet information for a specific index ($facet_idx) and returns a hash containing facet values and count:</p>

<pre>    {
        $facet_value =&#62; $count ,
        ...
    }</pre>

<p>Warning: this function has the side effect of changing the elementSetName for the result set. It is a helper function for the main loop, which takes care of backing it up for restoring.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_get_facets_info"
>_get_facets_info</a></h2>

<pre>    my $facets_info = C4::Search::_get_facets_info( $facets )</pre>

<p>Internal function that extracts facets information and properly builds the data structure needed to render facet labels.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="getIndexes"
>getIndexes</a></h2>

<p>Return an array with available indexes.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="buildQuery"
>buildQuery</a></h2>

<p>( $error, $query, $simple_query, $query_cgi, $query_desc, $limit, $limit_cgi, $limit_desc, $query_type ) = buildQuery ( $operators, $operands, $indexes, $limits, $sort_by, $scan, $lang);</p>

<p>Build queries and limits in CCL, CGI, Human, handle truncation, stemming, field weighting, fuzziness, etc.</p>

<p>See verbose embedded documentation.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_build_initial_query"
>_build_initial_query</a></h2>

<pre>  ($query, $query_cgi, $query_desc, $previous_operand) = _build_initial_query($initial_query_params);

  Build a section of the initial query containing indexes, operators, and operands.</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="searchResults"
>searchResults</a></h2>

<pre>  my @search_results = searchResults($search_context, $searchdesc, $hits, 
                                     $results_per_page, $offset, $scan, 
                                     @marcresults);</pre>

<p>Format results in a form suitable for passing to the template</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="enabled_staff_search_views"
>enabled_staff_search_views</a></h2>

<p>%hash = enabled_staff_search_views()</p>

<p>This function returns a hash that contains three flags obtained from the system preferences, used to determine whether a particular staff search results view is enabled.</p>

<dl>
<dt><a name="Output_arg:"
><code>Output arg:</code></a></dt>

<dd>
<pre>    * $hash{can_view_MARC} is true only if the MARC view is enabled
    * $hash{can_view_ISBD} is true only if the ISBD view is enabled
    * $hash{can_view_labeledMARC} is true only if the Labeled MARC view is enabled</pre>

<dt><a name="usage_in_the_script:"
><code>usage in the script:</code></a></dt>
</dl>

<p>$template-&#62;param ( C4::Search::enabled_staff_search_views );</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="z3950_search_args"
>z3950_search_args</a></h2>

<p>$arrayref = z3950_search_args($matchpoints)</p>

<p>This function returns an array reference that contains the search parameters to be passed to the Z39.50 search script (z3950_search.pl). The array elements are hash refs whose keys are name and value, and whose values are the name of a search parameter, the value of that search parameter and the URL encoded value of that parameter.</p>

<p>The search parameter names are lccn, isbn, issn, title, author, dewey and subject.</p>

<p>The search parameter values are obtained from the bibliographic record whose data is in a hash reference in $matchpoints, as returned by Biblio::GetBiblioData().</p>

<p>If $matchpoints is a scalar, it is assumed to be an unnamed query descriptor, e.g. a general purpose search argument. In this case, the returned array contains only entry: the key is &#39;title&#39; and the value is derived from $matchpoints.</p>

<p>If a search parameter value is undefined or empty, it is not included in the returned array.</p>

<p>The returned array reference may be passed directly to the template parameters.</p>

<dl>
<dt><a name="Output_arg:"
><code>Output arg:</code></a></dt>

<dd>
<pre>    * $array containing hash refs as described above</pre>

<dt><a name="usage_in_the_script:"
><code>usage in the script:</code></a></dt>
</dl>

<p>$data = Biblio::GetBiblioData($bibno); $template-&#62;param ( MYLOOP =&#62; C4::Search::z3950_search_args($data) )</p>

<p>*OR*</p>

<p>$template-&#62;param ( MYLOOP =&#62; C4::Search::z3950_search_args($searchscalar) )</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetDistinctValues($field);"
>GetDistinctValues($field);</a></h2>

<p><code>$field</code> is a reference to the fields array</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_ZOOM_event_loop"
>_ZOOM_event_loop</a></h2>

<pre>    _ZOOM_event_loop(\@zconns, \@results, sub {
        my ( $i, $size ) = @_;
        ....
    } );</pre>

<p>Processes a ZOOM event loop and passes control to a closure for processing the results, and destroying the resultsets.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="new_record_from_zebra"
>new_record_from_zebra</a></h2>

<p>Given raw data from a searchengine result set, return a MARC::Record object</p>

<p>This helper function is needed to take into account all the involved system preferences and configuration variables to properly create the MARC::Record object.</p>

<p>If we are using GRS-1, then the raw data we get from Zebra should be USMARC data. If we are using DOM, then it has to be MARCXML.</p>

<p>If we are using elasticsearch, it&#39;ll already be a MARC::Record and this function needs a new name.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Koha Development Team &#60;http://koha-community.org/&#62;</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
