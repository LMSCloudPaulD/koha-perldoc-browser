<html><head><title>stockrotation.pl</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../../_whtpurk.css" media="all" >

<script type="text/javascript" src="../../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.43,
  using Pod::Simple::PullParser v3.43,
  under Perl v5.038002 at Wed Feb  5 12:07:55 2025 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#What_does_the_--execute_flag_do%3F'>What does the --execute flag do?</a>
    <li class='indexItem indexItem2'><a href='#Helpers'>Helpers</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#execute'>execute</a>
      <li class='indexItem indexItem3'><a href='#report_full'>report_full</a>
      <li class='indexItem indexItem3'><a href='#report_by_branch'>report_by_branch</a>
      <li class='indexItem indexItem3'><a href='#_report_per_branch'>_report_per_branch</a>
      <li class='indexItem indexItem3'><a href='#_print_item'>_print_item</a>
      <li class='indexItem indexItem3'><a href='#emit'>emit</a>
    </ul>
  </ul>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>stockrotation.pl</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>    --[a]dmin-email    An address to which email reports should also be sent
    --[b]ranchcode     Select branch to report on for &#39;email&#39; reports (default: all)
    --e[x]ecute        Actually perform stockrotation housekeeping
    --[r]eport         Select either &#39;full&#39; or &#39;email&#39;
    --[S]end-all       Send email reports even if the report body is empty
    --[s]end-email     Send reports by email
    --[h]elp           Display this help message</pre>

<p>Cron script implementing scheduled stockrotation functionality.</p>

<p>By default this script merely reports on the current status of the stockrotation subsystem. In order to actually place items in transit, the script must be run with the `execute` argument.</p>

<p>`report` allows you to select the type of report that will be emitted. It&#39;s set to &#39;full&#39; by default. If the `email` report is selected, you can use the `branchcode` parameter to specify which branch&#39;s report you would like to see. The default is &#39;all&#39;.</p>

<p>`admin-email` is an additional email address to which we will send all email reports in addition to sending them to branch email addresses.</p>

<p>`send-email` will cause the script to send reports by email, and `send-all` will cause even reports with an empty body to be sent.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This script is used to move items from one stockrotationstage to the next, if they are elible for processing.</p>

<p>it should be run from cron like:</p>

<pre>   stockrotation.pl --report email --send-email --execute</pre>

<p>Prior to that you can run the script from the command line without the --execute and --send-email parameters to see what reports the script would generate in &#39;production&#39; mode. This is immensely useful for testing, or for getting to understand how the stockrotation module works: you can set up different scenarios, and then &#34;query&#34; the system on what it would do.</p>

<p>Normally you would want to run this script once per day, probably around midnight-ish to move any stockrotationitems along their rotas and to generate the email reports for branch libraries.</p>

<p>Each library will receive a report with &#34;items of interest&#34; for them for today&#39;s rota checks. Each item there will be an item that should, according to Koha, be located on the shelves of that branch, and which should be picked up and checked in. The item will either: - have been placed in transit to their new stage library; - have been placed in transit to be returned to their current stage library; - have just been added to a rota and will already be at the correct library;</p>

<p>In the last case the item will be checked in and no message will pop up. In the other cases a message will pop up requesting the item be posted to their new branch.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="What_does_the_--execute_flag_do?"
>What does the --execute flag do?</a></h2>

<p>To understand this, you will need to know a little bit about the design of this script and the stockrotation modules.</p>

<p>This script operates in 3 phases: first it walks the graph of rotas, stages and items. For each active rota, it investigates the items in each stage and determines whether action is required. It does not perform any actions, it just &#34;sieves&#34; all items on active rotas into &#34;actionable&#34; and &#34;non-actionable&#34; baskets. We can use these baskets to perform actions against the items, or to generate reports.</p>

<p>During the second phase this script then loops through the actionable baskets, and performs the relevant action (initiate, repatriate, advance) on each item.</p>

<p>Finally, during the third phase we revisit the original baskets and we compile reports (for instance per branch email reports).</p>

<p>When the script is run without the &#34;--execute&#34; flag, we perform phase 1, skip phase 2 and move straight onto phase 3.</p>

<p>With the &#34;--execute&#34; flag we also perform the database operations.</p>

<p>So with or without the flag, the report will look the same (except for the &#34;No database updates have been performed.&#34;).</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Helpers"
>Helpers</a></h2>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="execute"
>execute</a></h3>

<pre>  undef = execute($report);</pre>

<p>Perform the database updates, within a transaction, that are reported as needing to be performed by $REPORT.</p>

<p>$REPORT should be the return value of an invocation of `investigate`.</p>

<p>This procedure WILL mess with your database.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="report_full"
>report_full</a></h3>

<pre>  my $full_report = report_full($report);</pre>

<p>Return an arrayref containing a string containing a detailed report about the current state of the stockrotation subsystem.</p>

<p>$REPORT should be the return value of `investigate`.</p>

<p>No data in the database is manipulated by this procedure.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="report_by_branch"
>report_by_branch</a></h3>

<pre>  my $email_report = report_by_branch($report, [$branch]);</pre>

<p>Returns an arrayref containing a header string, with basic report information, and any number of &#39;per_branch&#39; strings, containing a detailed report about the current state of the stockrotation subsystem, from the perspective of those individual branches.</p>

<dl>
<dt><a name="$report_should_be_the_return_value_of_`investigate`"
>$report should be the return value of `investigate`</a></dt>

<dd>
<dt><a name="$branch_is_optional_and_should_be_either_0_(to_indicate_&#39;all&#39;),_or_a_specific_Koha::Library_object."
>$branch is optional and should be either 0 (to indicate &#39;all&#39;), or a specific Koha::Library object.</a></dt>
</dl>

<p>No data in the database is manipulated by this procedure.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="_report_per_branch"
>_report_per_branch</a></h3>

<pre>  my $branch_string = _report_per_branch($branch_details);</pre>

<p>return a string containing details about the stockrotation items and their status for the branch identified by $BRANCHCODE.</p>

<p>This helper procedure is only used from within `report_by_branch`.</p>

<p>No data in the database is manipulated by this procedure.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="_print_item"
>_print_item</a></h3>

<pre>  my $string = _print_item($item_section);</pre>

<p>Return a string containing an overview about $ITEM_SECTION.</p>

<p>This helper procedure is only used from within `report_full`.</p>

<p>No data in the database is manipulated by this procedure.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="emit"
>emit</a></h3>

<pre>  undef = emit($params);</pre>

<p>$PARAMS should be a hashref of the following format: admin_email: the address to which a copy of all reports should be sent. execute: the flag indicating whether we performed db updates send_all: the flag indicating whether we should send even empty reports send_email: the flag indicating whether we want to emit to stdout or email report: the data structure returned from one of the report procedures</p>

<p>No data in the database is manipulated by this procedure.</p>

<p>The return value is unspecified: we simply emit a message as a side-effect or die.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Alex Sassmannshausen &#60;alex.sassmannshausen@ptfs-europe.com&#62;</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
