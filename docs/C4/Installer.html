<html><head><title>C4::Installer</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Fri Jan  3 06:07:02 2025 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#METHODS'>METHODS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#new'>new</a>
    <li class='indexItem indexItem2'><a href='#marc_framework_sql_list'>marc_framework_sql_list</a>
    <li class='indexItem indexItem2'><a href='#sample_data_sql_list'>sample_data_sql_list</a>
    <li class='indexItem indexItem2'><a href='#load_db_schema'>load_db_schema</a>
    <li class='indexItem indexItem2'><a href='#load_sql_in_order'>load_sql_in_order</a>
    <li class='indexItem indexItem2'><a href='#set_marcflavour_syspref'>set_marcflavour_syspref</a>
    <li class='indexItem indexItem2'><a href='#set_version_syspref'>set_version_syspref</a>
    <li class='indexItem indexItem2'><a href='#set_languages_syspref'>set_languages_syspref</a>
    <li class='indexItem indexItem2'><a href='#process_yml_table'>process_yml_table</a>
    <li class='indexItem indexItem2'><a href='#load_sql'>load_sql</a>
    <li class='indexItem indexItem2'><a href='#get_file_path_from_name'>get_file_path_from_name</a>
    <li class='indexItem indexItem2'><a href='#DropAllForeignKeys(%24table)'>DropAllForeignKeys($table)</a>
    <li class='indexItem indexItem2'><a href='#TransformToNum'>TransformToNum</a>
    <li class='indexItem indexItem2'><a href='#SetVersion'>SetVersion</a>
    <li class='indexItem indexItem2'><a href='#CheckVersion'>CheckVersion</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#has_non_dynamic_row_format'>has_non_dynamic_row_format</a>
    </ul>
  </ul>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>C4::Installer</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre> use C4::Installer;
 my $installer = C4::Installer-&#62;new();
 my $all_languages = getAllLanguages();
 my $error = $installer-&#62;load_db_schema();
 my $list;
 #fill $list with list of sql files
 my ($fwk_language, $error_list) = $installer-&#62;load_sql_in_order($all_languages, @$list);
 $installer-&#62;set_version_syspref();
 $installer-&#62;set_marcflavour_syspref(&#39;MARC21&#39;);</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="METHODS"
>METHODS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="new"
>new</a></h2>

<pre>  my $installer = C4::Installer-&#62;new();</pre>

<p>Creates a new installer.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="marc_framework_sql_list"
>marc_framework_sql_list</a></h2>

<pre>  my ($defaulted_to_en, $list) = 
     $installer-&#62;marc_framework_sql_list($lang, $marcflavour);</pre>

<p>Returns in <code>$list</code> a structure listing the filename, description, section, and mandatory/optional status of MARC framework scripts available for <code>$lang</code> and <code>$marcflavour</code>.</p>

<p>If the <code>$defaulted_to_en</code> return value is true, no scripts are available for language <code>$lang</code> and the &#39;en&#39; ones are returned.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="sample_data_sql_list"
>sample_data_sql_list</a></h2>

<pre>  my ($defaulted_to_en, $list) = $installer-&#62;sample_data_sql_list($lang);</pre>

<p>Returns in <code>$list</code> a structure listing the filename, description, section, and mandatory/optional status of sample data scripts available for <code>$lang</code>. If the <code>$defaulted_to_en</code> return value is true, no scripts are available for language <code>$lang</code> and the &#39;en&#39; ones are returned.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="load_db_schema"
>load_db_schema</a></h2>

<pre>  my $error = $installer-&#62;load_db_schema();</pre>

<p>Loads the SQL script that creates Koha&#39;s tables and indexes. The return value is a string containing error messages reported by the load.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="load_sql_in_order"
>load_sql_in_order</a></h2>

<pre>  my ($fwk_language, $list) = $installer-&#62;load_sql_in_order($all_languages, @sql_list);</pre>

<p>Given a list of SQL scripts supplied in <code>@sql_list</code>, loads each of them into the database and sets the FrameworksLoaded system preference to names of the scripts that were loaded.</p>

<p>The SQL files are loaded in alphabetical order by filename (not including directory path). This means that dependencies among the scripts are to be resolved by carefully naming them, keeping in mind that the directory name does *not* currently count.</p>

<p><b>FIXME:</b> this is a rather delicate way of dealing with dependencies between the install scripts.</p>

<p>The return value <code>$list</code> is an arrayref containing a hashref for each &#34;level&#34; or directory containing SQL scripts; the hashref in turns contains a list of hashrefs containing a list of each script load and any error messages associated with the loading of each script.</p>

<p><b>FIXME:</b> The <code>$fwk_language</code> code probably doesn&#39;t belong and needs to be moved to a different method.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="set_marcflavour_syspref"
>set_marcflavour_syspref</a></h2>

<pre>  $installer-&#62;set_marcflavour_syspref($marcflavour);</pre>

<p>Set the &#39;marcflavour&#39; system preference. The incoming <code>$marcflavour</code> references to a subdirectory of installer/data/$dbms/$lang/marcflavour, and is normalized to MARC21 or UNIMARC.</p>

<p>FIXME: this method assumes that the MARC flavour will be either MARC21 or UNIMARC.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="set_version_syspref"
>set_version_syspref</a></h2>

<pre>  $installer-&#62;set_version_syspref();</pre>

<p>Set or update the &#39;Version&#39; system preference to the current Koha software version.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="set_languages_syspref"
>set_languages_syspref</a></h2>

<pre>  $installer-&#62;set_languages_syspref();</pre>

<p>Add the installation language to &#39;language&#39; and &#39;OPACLanguages&#39; system preferences if different from &#39;en&#39;</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="process_yml_table"
>process_yml_table</a></h2>

<pre>  my $query_info   = $installer-&#62;process_yml_table($table);</pre>

<p>Analyzes a table loaded in YAML format. Returns the values required to build an insert statement.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="load_sql"
>load_sql</a></h2>

<pre>  my $error = $installer-&#62;load_sql($filename);</pre>

<p>Runs the specified input file using a sql loader DBIx::RunSQL, or a yaml loader Returns any strings sent to STDERR</p>

<p># FIXME This should be improved: sometimes the caller and load_sql warn the same error.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_file_path_from_name"
>get_file_path_from_name</a></h2>

<pre>  my $filename = $installer-&#62;get_file_path_from_name(&#39;script_name&#39;);</pre>

<p>searches through the set of known SQL scripts and finds the fully qualified path name for the script that mathches the input.</p>

<p>returns undef if no match was found.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="DropAllForeignKeys($table)"
>DropAllForeignKeys($table)</a></h2>

<p>Drop all foreign keys of the table $table</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="TransformToNum"
>TransformToNum</a></h2>

<p>Transform the Koha version from a 4 parts string to a number, with just 1 .</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="SetVersion"
>SetVersion</a></h2>

<p>set the DBversion in the systempreferences</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CheckVersion"
>CheckVersion</a></h2>

<p>Check whether a given update should be run when passed the proposed version number. The update will always be run if the proposed version is greater than the current database version and less than or equal to the version in kohaversion.pl. The update is also run if the version contains XXX, though this behavior will be changed following the adoption of non-linear updates as implemented in bug 7167.</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="has_non_dynamic_row_format"
>has_non_dynamic_row_format</a></h3>

<p>Return the number of tables with row_format that is not Dynamic</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>C4::Installer is a refactoring of logic originally from installer/installer.pl, which was originally written by Henri-Damien Laurant.</p>

<p>Koha Development Team &#60;http://koha-community.org/&#62;</p>

<p>Galen Charlton &#60;galen.charlton@liblime.com&#62;</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
