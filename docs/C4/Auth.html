<html><head><title>C4::Auth</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Tue Jun 18 12:07:50 2024 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#get_template_and_user'>get_template_and_user</a>
    <li class='indexItem indexItem2'><a href='#checkauth'>checkauth</a>
    <li class='indexItem indexItem2'><a href='#check_api_auth'>check_api_auth</a>
    <li class='indexItem indexItem2'><a href='#check_cookie_auth'>check_cookie_auth</a>
    <li class='indexItem indexItem2'><a href='#get_session'>get_session</a>
    <li class='indexItem indexItem2'><a href='#create_basic_session'>create_basic_session</a>
    <li class='indexItem indexItem2'><a href='#getuserflags'>getuserflags</a>
    <li class='indexItem indexItem2'><a href='#get_user_subpermissions'>get_user_subpermissions</a>
    <li class='indexItem indexItem2'><a href='#get_all_subpermissions'>get_all_subpermissions</a>
    <li class='indexItem indexItem2'><a href='#get_cataloguing_page_permissions'>get_cataloguing_page_permissions</a>
    <li class='indexItem indexItem2'><a href='#haspermission'>haspermission</a>
    <li class='indexItem indexItem2'><a href='#in_iprange'>in_iprange</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#SEE_ALSO'>SEE ALSO</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>C4::Auth - Authenticates Koha users</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>  use CGI qw ( -utf8 );
  use C4::Auth;
  use C4::Output;

  my $query = CGI-&#62;new;

  my ($template, $borrowernumber, $cookie)
    = get_template_and_user(
        {
            template_name   =&#62; &#34;opac-main.tt&#34;,
            query           =&#62; $query,
      type            =&#62; &#34;opac&#34;,
      authnotrequired =&#62; 0,
      flagsrequired   =&#62; { catalogue =&#62; &#39;*&#39;, tools =&#62; &#39;import_patrons&#39; },
  }
    );

  output_html_with_http_headers $query, $cookie, $template-&#62;output;</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>The main function of this module is to provide authentification. However the get_template_and_user function has been provided so that a users login information is passed along automatically. This gets loaded into the template.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_template_and_user"
>get_template_and_user</a></h2>

<pre> my ($template, $borrowernumber, $cookie)
     = get_template_and_user(
       {
         template_name   =&#62; &#34;opac-main.tt&#34;,
         query           =&#62; $query,
         type            =&#62; &#34;opac&#34;,
         authnotrequired =&#62; 0,
         flagsrequired   =&#62; { catalogue =&#62; &#39;*&#39;, tools =&#62; &#39;import_patrons&#39; },
       }
     );</pre>

<p>This call passes the <code>query</code>, <code>flagsrequired</code> and <code>authnotrequired</code> to <code>&#38;checkauth</code> (in this module) to perform authentification. See <code>&#38;checkauth</code> for an explanation of these parameters.</p>

<p>The <code>template_name</code> is then used to find the correct template for the page. The authenticated users details are loaded onto the template in the logged_in_user variable (which is a Koha::Patron object). Also the <code>sessionID</code> is passed to the template. This can be used in templates if cookies are disabled. It needs to be put as and input to every authenticated page.</p>

<p>More information on the <code>gettemplate</code> sub can be found in the Output.pm module.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="checkauth"
>checkauth</a></h2>

<pre>  ($userid, $cookie, $sessionID) = &#38;checkauth($query, $noauth, $flagsrequired, $type);</pre>

<p>Verifies that the user is authorized to run this script. If the user is authorized, a (userid, cookie, session-id, flags) quadruple is returned. If the user is not authorized but does not have the required privilege (see $flagsrequired below), it displays an error page and exits. Otherwise, it displays the login page and exits.</p>

<p>Note that <code>&#38;checkauth</code> will return if and only if the user is authorized, so it should be called early on, before any unfinished operations (e.g., if you&#39;ve opened a file, then <code>&#38;checkauth</code> won&#39;t close it for you).</p>

<p><code>$query</code> is the CGI object for the script calling <code>&#38;checkauth</code>.</p>

<p>The <code>$noauth</code> argument is optional. If it is set, then no authorization is required for the script.</p>

<p><code>&#38;checkauth</code> fetches user and session information from <code>$query</code> and ensures that the user is authorized to run scripts that require authorization.</p>

<p>The <code>$flagsrequired</code> argument specifies the required privileges the user must have if the username and password are correct. It should be specified as a reference-to-hash; keys in the hash should be the &#34;flags&#34; for the user, as specified in the Members intranet module. Any key specified must correspond to a &#34;flag&#34; in the userflags table. E.g., { circulate =&#62; 1 } would specify that the user must have the &#34;circulate&#34; privilege in order to proceed. To make sure that access control is correct, the <code>$flagsrequired</code> parameter must be specified correctly.</p>

<p>Koha also has a concept of sub-permissions, also known as granular permissions. This makes the value of each key in the <code>flagsrequired</code> hash take on an additional meaning, i.e.,</p>

<pre> 1</pre>

<p>The user must have access to all subfunctions of the module specified by the hash key.</p>

<pre> *</pre>

<p>The user must have access to at least one subfunction of the module specified by the hash key.</p>

<pre> specific permission, e.g., &#39;export_catalog&#39;</pre>

<p>The user must have access to the specific subfunction list, which must correspond to a row in the permissions table.</p>

<p>The <code>$type</code> argument specifies whether the template should be retrieved from the opac or intranet directory tree. &#34;opac&#34; is assumed if it is not specified; however, if <code>$type</code> is specified, &#34;intranet&#34; is assumed if it is not &#34;opac&#34;.</p>

<p>If <code>$query</code> does not have a valid session ID associated with it (i.e., the user has not logged in) or if the session has expired, <code>&#38;checkauth</code> presents the user with a login page (from the point of view of the original script, <code>&#38;checkauth</code> does not return). Once the user has authenticated, <code>&#38;checkauth</code> restarts the original script (this time, <code>&#38;checkauth</code> returns).</p>

<p>The login page is provided using a HTML::Template, which is set in the systempreferences table or at the top of this file. The variable <code>$type</code> selects which template to use, either the opac or the intranet authentification template.</p>

<p><code>&#38;checkauth</code> returns a user ID, a cookie, and a session ID. The cookie should be sent back to the browser; it verifies that the user has authenticated.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="check_api_auth"
>check_api_auth</a></h2>

<pre>  ($status, $cookie, $sessionId) = check_api_auth($query, $userflags);</pre>

<p>Given a CGI query containing the parameters &#39;userid&#39; and &#39;password&#39; and/or a session cookie, determine if the user has the privileges specified by <code>$userflags</code>.</p>

<p><code>check_api_auth</code> is is meant for authenticating users of web services, and consequently will always return and will not attempt to redirect the user agent.</p>

<p>If a valid session cookie is already present, check_api_auth will return a status of &#34;ok&#34;, the cookie, and the Koha session ID.</p>

<p>If no session cookie is present, check_api_auth will check the &#39;userid&#39; and &#39;password parameters and create a session cookie and Koha session if the supplied credentials are OK.</p>

<p>Possible return values in <code>$status</code> are:</p>

<dl>
<dt><a name="&#34;ok&#34;_--_user_authenticated;_$cookie_and_$sessionid_have_valid_values."
>&#34;ok&#34; -- user authenticated; <code>$cookie</code> and <code>$sessionid</code> have valid values.</a></dt>

<dd>
<dt><a name="&#34;failed&#34;_--_credentials_are_not_correct;_$cookie_and_$sessionid_are_undef"
>&#34;failed&#34; -- credentials are not correct; <code>$cookie</code> and <code>$sessionid</code> are undef</a></dt>

<dd>
<dt><a name="&#34;maintenance&#34;_--_DB_is_in_maintenance_mode;_no_login_possible_at_the_moment"
>&#34;maintenance&#34; -- DB is in maintenance mode; no login possible at the moment</a></dt>

<dd>
<dt><a name="&#34;expired_--_session_cookie_has_expired;_API_user_should_resubmit_userid_and_password"
>&#34;expired -- session cookie has expired; API user should resubmit userid and password</a></dt>

<dd>
<dt><a name="&#34;restricted&#34;_--_The_IP_has_changed_(if_SessionRestrictionByIP)"
>&#34;restricted&#34; -- The IP has changed (if SessionRestrictionByIP)</a></dt>

<dd>
<dt><a name="&#34;additional-auth-needed_--_User_is_in_an_authentication_process_that_is_not_finished"
>&#34;additional-auth-needed -- User is in an authentication process that is not finished</a></dt>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="check_cookie_auth"
>check_cookie_auth</a></h2>

<pre>  ($status, $sessionId) = check_cookie_auth($cookie, $userflags);</pre>

<p>Given a CGISESSID cookie set during a previous login to Koha, determine if the user has the privileges specified by <code>$userflags</code>. <code>$userflags</code> is passed unaltered into <code>haspermission</code> and as such accepts all options avaiable to that routine with the one caveat that <code>check_api_auth</code> will also allow &#39;undef&#39; to be passed and in such a case the permissions check will be skipped altogether.</p>

<p><code>check_cookie_auth</code> is meant for authenticating special services such as tools/upload-file.pl that are invoked by other pages that have been authenticated in the usual way.</p>

<p>Possible return values in <code>$status</code> are:</p>

<dl>
<dt><a name="&#34;ok&#34;_--_user_authenticated;_$sessionID_have_valid_values."
>&#34;ok&#34; -- user authenticated; <code>$sessionID</code> have valid values.</a></dt>

<dd>
<dt><a name="&#34;anon&#34;_--_user_not_authenticated_but_valid_for_anonymous_session."
>&#34;anon&#34; -- user not authenticated but valid for anonymous session.</a></dt>

<dd>
<dt><a name="&#34;failed&#34;_--_credentials_are_not_correct;_$sessionid_are_undef"
>&#34;failed&#34; -- credentials are not correct; <code>$sessionid</code> are undef</a></dt>

<dd>
<dt><a name="&#34;maintenance&#34;_--_DB_is_in_maintenance_mode;_no_login_possible_at_the_moment"
>&#34;maintenance&#34; -- DB is in maintenance mode; no login possible at the moment</a></dt>

<dd>
<dt><a name="&#34;expired_--_session_cookie_has_expired;_API_user_should_resubmit_userid_and_password"
>&#34;expired -- session cookie has expired; API user should resubmit userid and password</a></dt>

<dd>
<dt><a name="&#34;restricted&#34;_--_The_IP_has_changed_(if_SessionRestrictionByIP)"
>&#34;restricted&#34; -- The IP has changed (if SessionRestrictionByIP)</a></dt>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_session"
>get_session</a></h2>

<pre>  use CGI::Session;
  my $session = get_session($sessionID);</pre>

<p>Given a session ID, retrieve the CGI::Session object used to store the session&#39;s state. The session object can be used to store data that needs to be accessed by different scripts during a user&#39;s session.</p>

<p>If the <code>$sessionID</code> parameter is an empty string, a new session will be created.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="create_basic_session"
>create_basic_session</a></h2>

<p>my $session = create_basic_session({ patron =&#62; $patron, interface =&#62; $interface });</p>

<p>Creates a session and adds all basic parameters for a session to work</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="getuserflags"
>getuserflags</a></h2>

<pre>    my $authflags = getuserflags($flags, $userid, [$dbh]);</pre>

<p>Translates integer flags into permissions strings hash.</p>

<p><code>$flags</code> is the integer userflags value ( borrowers.userflags ) <code>$userid</code> is the members.userid, used for building subpermissions <code>$authflags</code> is a hashref of permissions</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_user_subpermissions"
>get_user_subpermissions</a></h2>

<pre>  $user_perm_hashref = get_user_subpermissions($userid);</pre>

<p>Given the userid (note, not the borrowernumber) of a staff user, return a hashref of hashrefs of the specific subpermissions accorded to the user. An example return is</p>

<pre> {
    tools =&#62; {
        export_catalog =&#62; 1,
        import_patrons =&#62; 1,
    }
 }</pre>

<p>The top-level hash-key is a module or function code from userflags.flag, while the second-level key is a code from permissions.</p>

<p>The results of this function do not give a complete picture of the functions that a staff user can access; it is also necessary to check borrowers.flags.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_all_subpermissions"
>get_all_subpermissions</a></h2>

<pre>  my $perm_hashref = get_all_subpermissions();</pre>

<p>Returns a hashref of hashrefs defining all specific permissions currently defined. The return value has the same structure as that of <code>get_user_subpermissions</code>, except that the innermost hash value is the description of the subpermission.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_cataloguing_page_permissions"
>get_cataloguing_page_permissions</a></h2>

<pre>    my $required_permissions = get_cataloguing_page_permissions();</pre>

<p>Returns the required permissions to access the main cataloguing page. Useful for building the global <i>can_see_cataloguing_module</i> template variable, and also for reusing in <i>cataloging-home.pl</i>.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="haspermission"
>haspermission</a></h2>

<pre>  $flagsrequired = &#39;*&#39;;                                 # Any permission at all
  $flagsrequired = &#39;a_flag&#39;;                            # a_flag must be satisfied (all subpermissions)
  $flagsrequired = [ &#39;a_flag&#39;, &#39;b_flag&#39; ];              # a_flag OR b_flag must be satisfied
  $flagsrequired = { &#39;a_flag =&#62; 1, &#39;b_flag&#39; =&#62; 1 };     # a_flag AND b_flag must be satisfied
  $flagsrequired = { &#39;a_flag&#39; =&#62; &#39;sub_a&#39; };             # sub_a of a_flag must be satisfied
  $flagsrequired = { &#39;a_flag&#39; =&#62; [ &#39;sub_a, &#39;sub_b&#39; ] }; # sub_a OR sub_b of a_flag must be satisfied
  $flagsrequired = { &#39;a_flag&#39; =&#62; { &#39;sub_a&#39; =&#62; 1, &#39;sub_b&#39; =&#62; 1 } };    # sub_a AND sub_b of a_flag must be satisfied

  $flags = ($userid, $flagsrequired);</pre>

<p><code>$userid</code> the userid of the member <code>$flags</code> is a query structure similar to that used by SQL::Abstract that denotes the combination of flags required. It is a required parameter.</p>

<p>The main logic of this method is that things in arrays are OR&#39;ed, and things in hashes are AND&#39;ed. The `*` character can be used, at any depth, to denote `ANY`</p>

<p>Returns member&#39;s flags or 0 if a permission is not met.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="in_iprange"
>in_iprange</a></h2>

<pre>  $flags = ($iprange);</pre>

<p><code>$iprange</code> A space separated string describing an IP range. Can include single IPs or ranges</p>

<p>Returns 1 if the remote address is in the provided iprange, or 0 otherwise.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SEE_ALSO"
>SEE ALSO</a></h1>

<p>CGI(3)</p>

<p>C4::Output(3)</p>

<p>Crypt::Eksblowfish::Bcrypt(3)</p>

<p>Digest::MD5(3)</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
