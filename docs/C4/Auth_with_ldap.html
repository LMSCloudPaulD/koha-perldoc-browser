<html><head><title>C4::Auth</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Tue Nov 14 06:10:12 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#LDAP_Configuration'>LDAP Configuration</a>
  <li class='indexItem indexItem1'><a href='#KOHA_CONF_and_field_mapping'>KOHA_CONF and field mapping</a>
  <li class='indexItem indexItem1'><a href='#CONFIGURATION'>CONFIGURATION</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#auth_by_bind'>auth_by_bind</a>
    <li class='indexItem indexItem2'><a href='#principal_name'>principal_name</a>
    <li class='indexItem indexItem2'><a href='#update_password'>update_password</a>
    <li class='indexItem indexItem2'><a href='#Active_Directory'>Active Directory</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#SEE_ALSO'>SEE ALSO</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>C4::Auth - Authenticates Koha users</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<pre>  use C4::Auth_with_ldap;</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="LDAP_Configuration"
>LDAP Configuration</a></h1>

<pre>    This module is specific to LDAP authentification. It requires Net::LDAP package and one or more
        working LDAP servers.
        To use it :
           * Modify ldapserver element in KOHA_CONF
           * Establish field mapping in &#60;mapping&#62; element.

        For example, if your user records are stored according to the inetOrgPerson schema, RFC#2798,
        the username would match the &#34;uid&#34; field, and the password should match the &#34;userpassword&#34; field.

        Make sure that ALL required fields are populated by your LDAP database (and mapped in KOHA_CONF).  
        What are the required fields?  Well, in mysql you can check the database table &#34;borrowers&#34; like this:

        mysql&#62; show COLUMNS from borrowers;
                +---------------------+--------------+------+-----+---------+----------------+
                | Field               | Type         | Null | Key | Default | Extra          |
                +---------------------+--------------+------+-----+---------+----------------+
                | borrowernumber      | int(11)      | NO   | PRI | NULL    | auto_increment |
                | cardnumber          | varchar(16)  | YES  | UNI | NULL    |                |
                | surname             | mediumtext   | NO   |     | NULL    |                |
                | firstname           | text         | YES  |     | NULL    |                |
                | title               | mediumtext   | YES  |     | NULL    |                |
                | othernames          | mediumtext   | YES  |     | NULL    |                |
                | initials            | text         | YES  |     | NULL    |                |
                | streetnumber        | varchar(10)  | YES  |     | NULL    |                |
                | streettype          | varchar(50)  | YES  |     | NULL    |                |
                | address             | mediumtext   | NO   |     | NULL    |                |
                | address2            | text         | YES  |     | NULL    |                |
                | city                | mediumtext   | NO   |     | NULL    |                |
                | state               | mediumtext   | YES  |     | NULL    |                |
                | zipcode             | varchar(25)  | YES  |     | NULL    |                |
                | country             | text         | YES  |     | NULL    |                |
                | email               | mediumtext   | YES  |     | NULL    |                |
                | phone               | text         | YES  |     | NULL    |                |
                | mobile              | varchar(50)  | YES  |     | NULL    |                |
                | fax                 | mediumtext   | YES  |     | NULL    |                |
                | emailpro            | text         | YES  |     | NULL    |                |
                | phonepro            | text         | YES  |     | NULL    |                |
                | B_streetnumber      | varchar(10)  | YES  |     | NULL    |                |
                | B_streettype        | varchar(50)  | YES  |     | NULL    |                |
                | B_address           | varchar(100) | YES  |     | NULL    |                |
                | B_address2          | text         | YES  |     | NULL    |                |
                | B_city              | mediumtext   | YES  |     | NULL    |                |
                | B_state             | mediumtext   | YES  |     | NULL    |                |
                | B_zipcode           | varchar(25)  | YES  |     | NULL    |                |
                | B_country           | text         | YES  |     | NULL    |                |
                | B_email             | text         | YES  |     | NULL    |                |
                | B_phone             | mediumtext   | YES  |     | NULL    |                |
                | dateofbirth         | date         | YES  |     | NULL    |                |
                | branchcode          | varchar(10)  | NO   | MUL |         |                |
                | categorycode        | varchar(10)  | NO   | MUL |         |                |
                | dateenrolled        | date         | YES  |     | NULL    |                |
                | dateexpiry          | date         | YES  |     | NULL    |                |
                | gonenoaddress       | tinyint(1)   | YES  |     | NULL    |                |
                | lost                | tinyint(1)   | YES  |     | NULL    |                |
                | debarred            | date         | YES  |     | NULL    |                |
                | debarredcomment     | varchar(255) | YES  |     | NULL    |                |
                | contactname         | mediumtext   | YES  |     | NULL    |                |
                | contactfirstname    | text         | YES  |     | NULL    |                |
                | contacttitle        | text         | YES  |     | NULL    |                |
                | borrowernotes       | mediumtext   | YES  |     | NULL    |                |
                | relationship        | varchar(100) | YES  |     | NULL    |                |
                | ethnicity           | varchar(50)  | YES  |     | NULL    |                |
                | ethnotes            | varchar(255) | YES  |     | NULL    |                |
                | sex                 | varchar(1)   | YES  |     | NULL    |                |
                | password            | varchar(30)  | YES  |     | NULL    |                |
                | flags               | int(11)      | YES  |     | NULL    |                |
                | userid              | varchar(30)  | YES  | MUL | NULL    |                |
                | opacnote            | mediumtext   | YES  |     | NULL    |                |
                | contactnote         | varchar(255) | YES  |     | NULL    |                |
                | sort1               | varchar(80)  | YES  |     | NULL    |                |
                | sort2               | varchar(80)  | YES  |     | NULL    |                |
                | altcontactfirstname | varchar(255) | YES  |     | NULL    |                |
                | altcontactsurname   | varchar(255) | YES  |     | NULL    |                |
                | altcontactaddress1  | varchar(255) | YES  |     | NULL    |                |
                | altcontactaddress2  | varchar(255) | YES  |     | NULL    |                |
                | altcontactaddress3  | varchar(255) | YES  |     | NULL    |                |
                | altcontactstate     | mediumtext   | YES  |     | NULL    |                |
                | altcontactzipcode   | varchar(50)  | YES  |     | NULL    |                |
                | altcontactcountry   | text         | YES  |     | NULL    |                |
                | altcontactphone     | varchar(50)  | YES  |     | NULL    |                |
                | smsalertnumber      | varchar(50)  | YES  |     | NULL    |                |
                | privacy             | int(11)      | NO   |     | 1       |                |
                +---------------------+--------------+------+-----+---------+----------------+
                66 rows in set (0.00 sec)
                Where Null=&#34;NO&#34;, the field is required.</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="KOHA_CONF_and_field_mapping"
>KOHA_CONF and field mapping</a></h1>

<p>Example XML stanza for LDAP configuration in KOHA_CONF.</p>

<pre> &#60;config&#62;
  ...
  &#60;useldapserver&#62;1&#60;/useldapserver&#62;
  &#60;!-- LDAP SERVER (optional) --&#62;
  &#60;ldapserver id=&#34;ldapserver&#34;&#62;
    &#60;hostname&#62;localhost&#60;/hostname&#62;
    &#60;base&#62;dc=metavore,dc=com&#60;/base&#62;
    &#60;user&#62;cn=Manager,dc=metavore,dc=com&#60;/user&#62;             &#60;!-- DN, if not anonymous --&#62;
    &#60;pass&#62;metavore&#60;/pass&#62;          &#60;!-- password, if not anonymous --&#62;
    &#60;replicate&#62;1&#60;/replicate&#62;       &#60;!-- add new users from LDAP to Koha database --&#62;
    &#60;welcome&#62;1&#60;/welcome&#62;           &#60;!-- send new users the welcome email when added via replicate --&#62;
    &#60;update&#62;1&#60;/update&#62;             &#60;!-- update existing users in Koha database --&#62;
    &#60;auth_by_bind&#62;0&#60;/auth_by_bind&#62; &#60;!-- set to 1 to authenticate by binding instead of
                                        password comparison, e.g., to use Active Directory --&#62;
    &#60;anonymous_bind&#62;0&#60;/anonymous_bind&#62; &#60;!-- set to 1 if users should be searched using
                                            an anonymous bind, even when auth_by_bind is on --&#62;
    &#60;principal_name&#62;%s@my_domain.com&#60;/principal_name&#62;
                                   &#60;!-- optional, for auth_by_bind: a printf format to make userPrincipalName from koha userid.
                                        Not used with anonymous_bind. --&#62;
    &#60;update_password&#62;1&#60;/update_password&#62; &#60;!-- set to 0 if you don&#39;t want LDAP passwords
                                              synced to the local database --&#62;
    &#60;mapping&#62;                  &#60;!-- match koha SQL field names to your LDAP record field names --&#62;
      &#60;firstname    is=&#34;givenname&#34;      &#62;&#60;/firstname&#62;
      &#60;surname      is=&#34;sn&#34;             &#62;&#60;/surname&#62;
      &#60;address      is=&#34;postaladdress&#34;  &#62;&#60;/address&#62;
      &#60;city         is=&#34;l&#34;              &#62;Athens, OH&#60;/city&#62;
      &#60;zipcode      is=&#34;postalcode&#34;     &#62;&#60;/zipcode&#62;
      &#60;branchcode   is=&#34;branch&#34;         &#62;MAIN&#60;/branchcode&#62;
      &#60;userid       is=&#34;uid&#34;            &#62;&#60;/userid&#62;
      &#60;password     is=&#34;userpassword&#34;   &#62;&#60;/password&#62;
      &#60;email        is=&#34;mail&#34;           &#62;&#60;/email&#62;
      &#60;categorycode is=&#34;employeetype&#34;   &#62;PT&#60;/categorycode&#62;
      &#60;phone        is=&#34;telephonenumber&#34;&#62;&#60;/phone&#62;
    &#60;/mapping&#62; 
  &#60;/ldapserver&#62; 
 &#60;/config&#62;</pre>

<p>The &#60;mapping&#62; subelements establish the relationship between mysql fields and LDAP attributes. The element name is the column in mysql, with the &#34;is&#34; characteristic set to the LDAP attribute name. Optionally, any content between the element tags is taken as the default value. In this example, the default categorycode is &#34;PT&#34; (for patron).</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="CONFIGURATION"
>CONFIGURATION</a></h1>

<p>Once a user has been accepted by the LDAP server, there are several possibilities for how Koha will behave, depending on your configuration and the presence of a matching Koha user in your local DB:</p>

<pre>                         LOCAL_USER
 OPTION UPDATE REPLICATE  EXISTS?  RESULT
   A1      1       1        1      OK : We&#39;re updating them anyway.
   A2      1       1        0      OK : We&#39;re adding them anyway.
   B1      1       0        1      OK : We update them.
   B2      1       0        0     FAIL: We cannot add new user.
   C1      0       1        1      OK : We do nothing.  (maybe should update password?)
   C2      0       1        0      OK : We add the new user.
   D1      0       0        1      OK : We do nothing.  (maybe should update password?)
   D2      0       0        0     FAIL: We cannot add new user.</pre>

<p>Note: failure here just means that Koha will fallback to checking the local DB. That is, a given user could login with their LDAP password OR their local one. If this is a problem, then you should enable update and supply a mapping for password. Then the local value will be updated at successful LDAP login and the passwords will be synced.</p>

<p>If you choose NOT to update local users, the borrowers table will not be affected at all. Note that this means that patron passwords may appear to change if LDAP is ever disabled, because the local table never contained the LDAP values.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="auth_by_bind"
>auth_by_bind</a></h2>

<p>Binds as the user instead of retrieving their record. Recommended if update disabled.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="principal_name"
>principal_name</a></h2>

<p>Provides an optional sprintf-style format for manipulating the userid before the bind. Even though the userPrincipalName is one intended target, any uniquely identifying attribute that the server allows to be used for binding could be used.</p>

<p>Currently, principal_name only operates when auth_by_bind is enabled.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="update_password"
>update_password</a></h2>

<p>If this tag is left out or set to a true value, then the user&#39;s LDAP password will be stored (hashed) in the local Koha database. If you don&#39;t want this to happen, then set the value of this to &#39;0&#39;. Note that if passwords are not stored locally, and the connection to the LDAP system fails, then the users will not be able to log in at all.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Active_Directory"
>Active Directory</a></h2>

<p>The auth_by_bind and principal_name settings are recommended for Active Directory.</p>

<p>Under default Active Directory rules, we cannot determine the distinguishedName attribute from the Koha userid as reliably as we would typically under openldap. Instead of:</p>

<pre>    distinguishedName: CN=barnes.7,DC=my_company,DC=com</pre>

<p>We might get:</p>

<pre>    distinguishedName: CN=Barnes\, Jim,OU=Test Accounts,OU=User Accounts,DC=my_company,DC=com</pre>

<p>Matching that would require us to know more info about the account (firstname, surname) and to include punctuation and whitespace in Koha userids. But the userPrincipalName should be consistent, something like:</p>

<pre>    userPrincipalName: barnes.7@my_company.com</pre>

<p>Therefore it is often easier to bind to Active Directory with userPrincipalName, effectively the canonical email address for that user, or what it would be if email were enabled for them. If Koha userid values will match the username portion of the userPrincipalName, and the domain suffix is the same for all users, then use principal_name like this: &#60;principal_name&#62;%s@core.my_company.com&#60;/principal_name&#62;</p>

<p>The user of the previous example, barnes.7, would then attempt to bind as: barnes.7@core.my_company.com</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SEE_ALSO"
>SEE ALSO</a></h1>

<p>CGI(3)</p>

<p>Net::LDAP()</p>

<p>XML::Simple()</p>

<p>Digest::MD5(3)</p>

<p>sprintf()</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
