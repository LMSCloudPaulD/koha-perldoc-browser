<html><head><title>Koha::MarcOrder</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Tue Jan  7 18:06:44 2025 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#API'>API</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#Class_methods'>Class methods</a>
    <ul   class='indexList indexList3'>
      <li class='indexItem indexItem3'><a href='#create_order_lines_from_file'>create_order_lines_from_file</a>
      <li class='indexItem indexItem3'><a href='#import_record_and_create_order_lines'>import_record_and_create_order_lines</a>
      <li class='indexItem indexItem3'><a href='#_create_basket_for_file'>_create_basket_for_file</a>
      <li class='indexItem indexItem3'><a href='#_stage_file'>_stage_file</a>
      <li class='indexItem indexItem3'><a href='#_get_syspref_mappings'>_get_syspref_mappings</a>
      <li class='indexItem indexItem3'><a href='#_verify_number_of_fields'>_verify_number_of_fields</a>
      <li class='indexItem indexItem3'><a href='#add_biblio_from_import_record'>add_biblio_from_import_record</a>
      <li class='indexItem indexItem3'><a href='#add_items_from_import_record'>add_items_from_import_record</a>
      <li class='indexItem indexItem3'><a href='#match_file_to_account'>match_file_to_account</a>
      <li class='indexItem indexItem3'><a href='#import_batches_list'>import_batches_list</a>
      <li class='indexItem indexItem3'><a href='#import_biblios_list'>import_biblios_list</a>
      <li class='indexItem indexItem3'><a href='#parse_input_into_order_line_fields'>parse_input_into_order_line_fields</a>
      <li class='indexItem indexItem3'><a href='#create_items_and_generate_order_hash'>create_items_and_generate_order_hash</a>
      <li class='indexItem indexItem3'><a href='#_format_price_to_CurrencyFormat_syspref'>_format_price_to_CurrencyFormat_syspref</a>
      <li class='indexItem indexItem3'><a href='#_create_item_fields_from_syspref'>_create_item_fields_from_syspref</a>
    </ul>
  </ul>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>Koha::MarcOrder - Koha Marc Order Object class</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="API"
>API</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="Class_methods"
>Class methods</a></h2>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="create_order_lines_from_file"
>create_order_lines_from_file</a></h3>

<pre>    my $result = Koha::MarcOrder-&#62;create_order_lines_from_file($args);

    Controller for file staging, basket creation and order line creation when using the cronjob in marc_ordering_process.pl</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="import_record_and_create_order_lines"
>import_record_and_create_order_lines</a></h3>

<pre>    my $result = Koha::MarcOrder-&#62;import_record_and_create_order_lines($args);

    Controller for record import and order line creation when using the interface in addorderiso2709.pl</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="_create_basket_for_file"
>_create_basket_for_file</a></h3>

<pre>    my $basket_id = _create_basket_for_file({
        filename  =&#62; $filename,
        vendor_id =&#62; $vendor_id
    });

    Creates a basket ready to receive order lines based on the imported file</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="_stage_file"
>_stage_file</a></h3>

<pre>    $file-&#62;_stage_file($params)

    Stages a file directly using parameters from a MARC ordering account</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="_get_syspref_mappings"
>_get_syspref_mappings</a></h3>

<pre>    my $syspref_info = _get_syspref_mappings( $marcrecord, $syspref_name );

    Fetches data from a MARC record based on the mappings in the syspref MarcFieldsToOrder or MarcItemFieldsToOrder using the fields selected in $fields (array).</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="_verify_number_of_fields"
>_verify_number_of_fields</a></h3>

<pre>    my $tags_count = _verify_number_of_fields(\@tags_list, $record);

    Verifies that the number of fields in the record is consistent for each field</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="add_biblio_from_import_record"
>add_biblio_from_import_record</a></h3>

<pre>    my ($record_results, $duplicates_in_batch) = add_biblio_from_import_record({
        import_record             =&#62; $import_record,
        matcher_id                =&#62; $matcher_id,
        overlay_action            =&#62; $overlay_action,
        import_record_id_selected =&#62; $import_record_id_selected,
        agent                     =&#62; $agent,
        import_batch_id           =&#62; $import_batch_id
    });

    Takes a set of import records and adds biblio records based on the file content.
    Params matcher_id and overlay_action are taken from the MARC ordering account.
    Returns the new or matched biblionumber and the MARC record for each import record.</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="add_items_from_import_record"
>add_items_from_import_record</a></h3>

<pre>    my $order_line_details = add_items_from_import_record({
        record_result      =&#62; $record_result,
        basket_id          =&#62; $basket_id,
        vendor             =&#62; $vendor,
        budget_id          =&#62; $budget_id,
        agent              =&#62; $agent,
        client_item_fields =&#62; $client_item_fields
    });

    Adds items to biblio records based on mappings in MarcItemFieldsToOrder.
    Returns an array of order line details based on newly added items.
    If being called from addorderiso2709.pl then client_item_fields is a hash of all the UI form inputs needed by the script.</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="match_file_to_account"
>match_file_to_account</a></h3>

<pre>    my $file_match = Koha::MarcOrder-&#62;match_file_to_account({
        filename =&#62; $filename,
        filepath =&#62; $filepath,
        profile  =&#62; $profile
    });

    Used by the cronjob to detect whether a file matches the account and should be processed
    This method only checks the first record in the file.</pre>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="import_batches_list"
>import_batches_list</a></h3>

<p>Fetches import batches matching the batch to be added to the basket and returns these to the template</p>

<p>Koha::MarcOrder-&#62;import_batches_list();</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="import_biblios_list"
>import_biblios_list</a></h3>

<p>For an import batch, this function reads the files and creates all the relevant data pertaining to that file It then returns this to the template to be shown in the UI</p>

<p>Koha::MarcOrder-&#62;import_biblios_list( $cgiparams-&#62;{&#39;import_batch_id&#39;} );</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="parse_input_into_order_line_fields"
>parse_input_into_order_line_fields</a></h3>

<p>This function takes inputs from either the cronjob or UI and then parses that into a single set of order line fields that can be used to create items and order lines</p>

<p>my $order_line_fields = parse_input_into_order_line_fields( { agent =&#62; $agent, biblionumber =&#62; $biblionumber, budget_id =&#62; $budget_id, basket_id =&#62; $basket_id, fields =&#62; $item_fields, marcrecord =&#62; $marcrecord, } );</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="create_items_and_generate_order_hash"
>create_items_and_generate_order_hash</a></h3>

<p>This method is used from both the cronjob and the UI to create items and generate order line details for those new items</p>

<p>my $order_line_details = create_items_and_generate_order_hash( { fields =&#62; $order_line_fields, vendor =&#62; $vendor, agent =&#62; $agent, active_currency =&#62; $active_currency, } );</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="_format_price_to_CurrencyFormat_syspref"
>_format_price_to_CurrencyFormat_syspref</a></h3>

<p>In France, the cents separator is the &#39;,&#39; but sometimes a &#39;.&#39; is used In this case, the price will be x100 when unformatted The &#39;.&#39; needs replacing by a &#39;,&#39; to get a proper price calculation</p>

<h3><a class='u' href='#___top' title='click to go to top of document'
name="_create_item_fields_from_syspref"
>_create_item_fields_from_syspref</a></h3>

<p>Takes the two sysprefs and returns the item fields required to process and create orderlines</p>

<p>my $item_fields = _create_item_fields_from_syspref( { marc_fields_to_order =&#62; $marc_fields_to_order, marc_item_fields_to_order =&#62; $marc_item_fields_to_order } );</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
