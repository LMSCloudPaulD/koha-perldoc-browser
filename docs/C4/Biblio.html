<html><head><title>C4::Biblio</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Wed Dec 28 18:18:13 2022 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#EXPORTED_FUNCTIONS'>EXPORTED FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#AddBiblio'>AddBiblio</a>
    <li class='indexItem indexItem2'><a href='#ModBiblio'>ModBiblio</a>
    <li class='indexItem indexItem2'><a href='#_strip_item_fields'>_strip_item_fields</a>
    <li class='indexItem indexItem2'><a href='#DelBiblio'>DelBiblio</a>
    <li class='indexItem indexItem2'><a href='#BiblioAutoLink'>BiblioAutoLink</a>
    <li class='indexItem indexItem2'><a href='#LinkBibHeadingsToAuthorities'>LinkBibHeadingsToAuthorities</a>
    <li class='indexItem indexItem2'><a href='#_check_valid_auth_link'>_check_valid_auth_link</a>
    <li class='indexItem indexItem2'><a href='#GetBiblioData'>GetBiblioData</a>
    <li class='indexItem indexItem2'><a href='#GetISBDView'>GetISBDView</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS_FOR_HANDLING_MARC_MANAGEMENT'>FUNCTIONS FOR HANDLING MARC MANAGEMENT</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#IsMarcStructureInternal'>IsMarcStructureInternal</a>
    <li class='indexItem indexItem2'><a href='#GetMarcStructure'>GetMarcStructure</a>
    <li class='indexItem indexItem2'><a href='#GetUsedMarcStructure'>GetUsedMarcStructure</a>
    <li class='indexItem indexItem2'><a href='#GetMarcSubfieldStructure'>GetMarcSubfieldStructure</a>
    <li class='indexItem indexItem2'><a href='#GetMarcFromKohaField'>GetMarcFromKohaField</a>
    <li class='indexItem indexItem2'><a href='#GetMarcSubfieldStructureFromKohaField'>GetMarcSubfieldStructureFromKohaField</a>
    <li class='indexItem indexItem2'><a href='#GetXmlBiblio'>GetXmlBiblio</a>
    <li class='indexItem indexItem2'><a href='#GetMarcPrice'>GetMarcPrice</a>
    <li class='indexItem indexItem2'><a href='#MungeMarcPrice'>MungeMarcPrice</a>
    <li class='indexItem indexItem2'><a href='#GetMarcQuantity'>GetMarcQuantity</a>
    <li class='indexItem indexItem2'><a href='#GetAuthorisedValueDesc'>GetAuthorisedValueDesc</a>
    <li class='indexItem indexItem2'><a href='#GetMarcControlnumber'>GetMarcControlnumber</a>
    <li class='indexItem indexItem2'><a href='#GetMarcISBN'>GetMarcISBN</a>
    <li class='indexItem indexItem2'><a href='#GetMarcISSN'>GetMarcISSN</a>
    <li class='indexItem indexItem2'><a href='#GetMarcSubjects'>GetMarcSubjects</a>
    <li class='indexItem indexItem2'><a href='#GetMarcUrls'>GetMarcUrls</a>
    <li class='indexItem indexItem2'><a href='#GetMarcSeries'>GetMarcSeries</a>
    <li class='indexItem indexItem2'><a href='#UpsertMarcSubfield'>UpsertMarcSubfield</a>
    <li class='indexItem indexItem2'><a href='#UpsertMarcControlField'>UpsertMarcControlField</a>
    <li class='indexItem indexItem2'><a href='#GetFrameworkCode'>GetFrameworkCode</a>
    <li class='indexItem indexItem2'><a href='#TransformKohaToMarc'>TransformKohaToMarc</a>
    <li class='indexItem indexItem2'><a href='#PrepHostMarcField'>PrepHostMarcField</a>
    <li class='indexItem indexItem2'><a href='#TransformHtmlToXml'>TransformHtmlToXml</a>
    <li class='indexItem indexItem2'><a href='#_default_ind_to_space'>_default_ind_to_space</a>
    <li class='indexItem indexItem2'><a href='#TransformHtmlToMarc'>TransformHtmlToMarc</a>
    <li class='indexItem indexItem2'><a href='#TransformMarcToKoha'>TransformMarcToKoha</a>
    <li class='indexItem indexItem2'><a href='#_disambiguate'>_disambiguate</a>
    <li class='indexItem indexItem2'><a href='#_adjust_pubyear'>_adjust_pubyear</a>
    <li class='indexItem indexItem2'><a href='#CountItemsIssued'>CountItemsIssued</a>
    <li class='indexItem indexItem2'><a href='#ModZebra'>ModZebra</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#INTERNAL_FUNCTIONS'>INTERNAL FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#_koha_marc_update_bib_ids'>_koha_marc_update_bib_ids</a>
    <li class='indexItem indexItem2'><a href='#_koha_marc_update_biblioitem_cn_sort'>_koha_marc_update_biblioitem_cn_sort</a>
    <li class='indexItem indexItem2'><a href='#_koha_modify_biblio'>_koha_modify_biblio</a>
    <li class='indexItem indexItem2'><a href='#_koha_modify_biblioitem_nonmarc'>_koha_modify_biblioitem_nonmarc</a>
    <li class='indexItem indexItem2'><a href='#_koha_delete_biblio'>_koha_delete_biblio</a>
    <li class='indexItem indexItem2'><a href='#_koha_delete_biblioitems'>_koha_delete_biblioitems</a>
    <li class='indexItem indexItem2'><a href='#_koha_delete_biblio_metadata'>_koha_delete_biblio_metadata</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#UNEXPORTED_FUNCTIONS'>UNEXPORTED FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#ModBiblioMarc'>ModBiblioMarc</a>
    <li class='indexItem indexItem2'><a href='#prepare_host_field'>prepare_host_field</a>
    <li class='indexItem indexItem2'><a href='#UpdateTotalIssues'>UpdateTotalIssues</a>
    <li class='indexItem indexItem2'><a href='#RemoveAllNsb'>RemoveAllNsb</a>
    <li class='indexItem indexItem2'><a href='#ApplyMarcOverlayRules'>ApplyMarcOverlayRules</a>
    <li class='indexItem indexItem2'><a href='#_after_biblio_action_hooks'>_after_biblio_action_hooks</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#AUTHOR'>AUTHOR</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>C4::Biblio - cataloging management functions</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>Biblio.pm contains functions for managing storage and editing of bibliographic data within Koha.
Most of the functions in this module are used for cataloging records: adding,
editing,
or removing biblios,
biblioitems,
or items.
Koha&#39;s stores bibliographic information in three places:</p>

<dl>
<dt><a name="1._in_the_biblio,biblioitems,items,_etc_tables,_which_are_limited_to_a_one-to-one_mapping_to_underlying_MARC_data"
>1.
in the biblio,biblioitems,items,
etc tables,
which are limited to a one-to-one mapping to underlying MARC data</a></dt>

<dd>
<dt><a name="2._as_raw_MARC_in_the_Zebra_index_and_storage_engine"
>2.
as raw MARC in the Zebra index and storage engine</a></dt>

<dd>
<dt><a name="3._as_MARC_XML_in_biblio_metadata.metadata"
>3.
as MARC XML in biblio_metadata.metadata</a></dt>
</dl>

<p>In the 3.0 version of Koha,
the authoritative record-level information is in biblio_metadata.metadata</p>

<p>Because the data isn&#39;t completely normalized there&#39;s a chance for information to get out of sync.
The design choice to go with a un-normalized schema was driven by performance and stability concerns.
However,
if this occur,
it can be considered as a bug : The API is (or should be) complete &#38; the only entry point for all biblio/items managements.</p>

<dl>
<dt><a 
>1.
Compared with MySQL,
Zebra is slow to update an index for small data changes -- especially for proc-intensive operations like circulation</a></dt>

<dd>
<dt><a name="2._Zebra&#39;s_index_has_been_known_to_crash_and_a_backup_of_the_data_is_necessary_to_rebuild_it_in_such_cases"
>2.
Zebra&#39;s index has been known to crash and a backup of the data is necessary to rebuild it in such cases</a></dt>
</dl>

<p>Because of this design choice,
the process of managing storage and editing is a bit convoluted.
Historically,
Biblio.pm&#39;s grown to an unmanagable size and as a result we have several types of functions currently:</p>

<dl>
<dt><a 
>1.
Add*/Mod*/Del*/ - high-level external functions suitable for being called from external scripts to manage the collection</a></dt>

<dd>
<dt><a name="2.__koha_*_-_low-level_internal_functions_for_managing_the_koha_tables"
>2.
_koha_* - low-level internal functions for managing the koha tables</a></dt>

<dd>
<dt><a 
>3.
Marc management function : as the MARC record is stored in biblio_metadata.metadata,
some subs dedicated to it&#39;s management are in this package.
They should be used only internally by Biblio.pm,
the only official entry points being AddBiblio,
AddItem,
ModBiblio,
ModItem.</a></dt>

<dd>
<dt><a name="4._Zebra_functions_used_to_update_the_Zebra_index"
>4.
Zebra functions used to update the Zebra index</a></dt>

<dd>
<dt><a name="5._internal_helper_functions_such_as_char_decode,_checkitems,_etc._Some_of_these_probably_belong_in_Koha.pm"
>5.
internal helper functions such as char_decode,
checkitems,
etc.
Some of these probably belong in Koha.pm</a></dt>
</dl>

<p>The MARC record (in biblio_metadata.metadata) contains the complete marc record,
including items.
It also contains the biblionumber.
That is the reason why it is not stored directly by AddBiblio,
with all other fields .
To save a biblio,
we need to :</p>

<dl>
<dt><a name="1._save_datas_in_biblio_and_biblioitems_table,_that_gives_us_a_biblionumber_and_a_biblioitemnumber"
>1.
save datas in biblio and biblioitems table,
that gives us a biblionumber and a biblioitemnumber</a></dt>

<dd>
<dt><a name="2._add_the_biblionumber_and_biblioitemnumber_into_the_MARC_records"
>2.
add the biblionumber and biblioitemnumber into the MARC records</a></dt>

<dd>
<dt><a name="3._save_the_marc_record"
>3.
save the marc record</a></dt>
</dl>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="EXPORTED_FUNCTIONS"
>EXPORTED FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="AddBiblio"
>AddBiblio</a></h2>

<pre>  ($biblionumber,$biblioitemnumber) = AddBiblio($record,$frameworkcode);</pre>

<p>Exported function (core API) for adding a new biblio to koha.</p>

<p>The first argument is a <code>MARC::Record</code> object containing the bib to add, while the second argument is the desired MARC framework code.</p>

<p>The <code>$options</code> argument is a hashref with additional parameters:</p>

<dl>
<dt><a name="defer_marc_save:_used_when_ModBiblioMarc_is_handled_by_the_caller"
><b>defer_marc_save</b>: used when ModBiblioMarc is handled by the caller</a></dt>

<dd>
<dt><a name="skip_record_index:_used_when_the_indexing_schedulling_will_be_handled_by_the_caller"
><b>skip_record_index</b>: used when the indexing schedulling will be handled by the caller</a></dt>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ModBiblio"
>ModBiblio</a></h2>

<pre>  ModBiblio($record, $biblionumber, $frameworkcode, $options);</pre>

<p>Replace an existing bib record identified by <code>$biblionumber</code> with one supplied by the MARC::Record object <code>$record</code>. The embedded item, biblioitem, and biblionumber fields from the previous version of the bib record replace any such fields of those tags that are present in <code>$record</code>. Consequently, ModBiblio() is not to be used to try to modify item records.</p>

<p><code>$frameworkcode</code> specifies the MARC framework to use when storing the modified bib record; among other things, this controls how MARC fields get mapped to display columns in the <code>biblio</code> and <code>biblioitems</code> tables, as well as which fields are used to store embedded item, biblioitem, and biblionumber data for indexing.</p>

<p>The <code>$options</code> argument is a hashref with additional parameters:</p>

<dl>
<dt><a name="overlay_context"
><code>overlay_context</code></a></dt>

<dd>
<p>This parameter is forwarded to <a href="#ApplyMarcOverlayRules" class="podlinkpod"
>&#34;ApplyMarcOverlayRules&#34;</a> where it is used for selecting the current rule set if MARCOverlayRules is enabled. See <a href="#ApplyMarcOverlayRules" class="podlinkpod"
>&#34;ApplyMarcOverlayRules&#34;</a> for more details.</p>

<dt><a name="disable_autolink"
><code>disable_autolink</code></a></dt>

<dd>
<p>Unless <code>disable_autolink</code> is passed ModBiblio will relink record headings to authorities based on settings in the system preferences. This flag allows us to not relink records when the authority linker is saving modifications.</p>

<dt><a name="skip_holds_queue"
><code>skip_holds_queue</code></a></dt>

<dd>
<p>Unless <code>skip_holds_queue</code> is passed, ModBiblio will trigger the BatchUpdateBiblioHoldsQueue task to rebuild the holds queue for the biblio if <i>RealTimeHoldsQueue</i> is enabled.</p>
</dd>
</dl>

<p>Returns 1 on success 0 on failure</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_strip_item_fields"
>_strip_item_fields</a></h2>

<pre>  _strip_item_fields($record, $frameworkcode)</pre>

<p>Utility routine to remove item tags from a MARC bib.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="DelBiblio"
>DelBiblio</a></h2>

<pre>  my $error = &#38;DelBiblio($biblionumber, $params);</pre>

<p>Exported function (core API) for deleting a biblio in koha. Deletes biblio record from Zebra and Koha tables (biblio &#38; biblioitems) Also backs it up to deleted* tables. Checks to make sure that the biblio has no items attached. return: <code>$error</code> : undef unless an error occurs</p>

<p><i>$params</i> is a hashref containing extra parameters. Valid keys are:</p>

<dl>
<dt><a name="skip_holds_queue:_used_when_the_holds_queue_update_will_be_handled_by_the_caller"
><b>skip_holds_queue</b>: used when the holds queue update will be handled by the caller</a></dt>

<dd>
<dt><a name="skip_record_index:_used_when_the_indexing_schedulling_will_be_handled_by_the_caller"
><b>skip_record_index</b>: used when the indexing schedulling will be handled by the caller</a></dt>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="BiblioAutoLink"
>BiblioAutoLink</a></h2>

<pre>  my $headings_linked = BiblioAutoLink($record, $frameworkcode)</pre>

<p>Automatically links headings in a bib record to authorities.</p>

<p>Returns the number of headings changed</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="LinkBibHeadingsToAuthorities"
>LinkBibHeadingsToAuthorities</a></h2>

<pre>  my $num_headings_changed, %results = LinkBibHeadingsToAuthorities($linker, $marc, $frameworkcode, [$allowrelink, $tagtolink,  $verbose]);</pre>

<p>Links bib headings to authority records by checking each authority-controlled field in the <code>MARC::Record</code> object <code>$marc</code>, looking for a matching authority record, and setting the linking subfield $9 to the ID of that authority record.</p>

<p>If $allowrelink is false, existing authids will never be replaced, regardless of the values of LinkerKeepStale and LinkerRelink.</p>

<p>Returns the number of heading links changed in the MARC record.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_check_valid_auth_link"
>_check_valid_auth_link</a></h2>

<pre>    if ( _check_valid_auth_link($authid, $field) ) {
        ...
    }</pre>

<p>Check whether the specified heading-auth link is valid without reference to Zebra. Ideally this code would be in C4::Heading, but that won&#39;t be possible until we have de-cycled C4::AuthoritiesMarc, so this is the safest place.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetBiblioData"
>GetBiblioData</a></h2>

<pre>  $data = &#38;GetBiblioData($biblionumber);</pre>

<p>Returns information about the book with the given biblionumber. <code>&#38;GetBiblioData</code> returns a reference-to-hash. The keys are the fields in the <code>biblio</code> and <code>biblioitems</code> tables in the Koha database.</p>

<p>In addition, <code>$data-&#62;{subject}</code> is the list of the book&#39;s subjects, separated by <code>&#34; , &#34;</code> (space, comma, space). If there are multiple biblioitems with the given biblionumber, only the first one is considered.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetISBDView"
>GetISBDView</a></h2>

<pre>  $isbd = &#38;GetISBDView({
      &#39;record&#39;    =&#62; $marc_record,
      &#39;template&#39;  =&#62; $interface, # opac/intranet
      &#39;framework&#39; =&#62; $framework,
  });</pre>

<p>Return the ISBD view which can be included in opac and intranet</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS_FOR_HANDLING_MARC_MANAGEMENT"
>FUNCTIONS FOR HANDLING MARC MANAGEMENT</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="IsMarcStructureInternal"
>IsMarcStructureInternal</a></h2>

<pre>    my $tagslib = C4::Biblio::GetMarcStructure();
    for my $tag ( sort keys %$tagslib ) {
        next unless $tag;
        for my $subfield ( sort keys %{ $tagslib-&#62;{$tag} } ) {
            next if IsMarcStructureInternal($tagslib-&#62;{$tag}{$subfield});
        }
        # Process subfield
    }</pre>

<p>GetMarcStructure creates keys (lib, tab, mandatory, repeatable, important) for a display purpose. These different values should not be processed as valid subfields.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMarcStructure"
>GetMarcStructure</a></h2>

<pre>  $res = GetMarcStructure($forlibrarian, $frameworkcode, [ $params ]);</pre>

<p>Returns a reference to a big hash of hash, with the Marc structure for the given frameworkcode $forlibrarian :if set to 1, the MARC descriptions are the librarians ones, otherwise it&#39;s the public (OPAC) ones $frameworkcode : the framework code to read $params allows you to pass { unsafe =&#62; 1 } for better performance.</p>

<p>Note: If you call GetMarcStructure with unsafe =&#62; 1, do not modify or even autovivify its contents. It is a cached/shared data structure. Your changes c/would be passed around in subsequent calls.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetUsedMarcStructure"
>GetUsedMarcStructure</a></h2>

<p>The same function as GetMarcStructure except it just takes field in tab 0-9. (used field)</p>

<pre>  my $results = GetUsedMarcStructure($frameworkcode);</pre>

<p><code>$results</code> is a ref to an array which each case contains a ref to a hash which each keys is the columns from marc_subfield_structure</p>

<p><code>$frameworkcode</code> is the framework code.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMarcSubfieldStructure"
>GetMarcSubfieldStructure</a></h2>

<pre>  my $structure = GetMarcSubfieldStructure($frameworkcode, [$params]);</pre>

<p>Returns a reference to hash representing MARC subfield structure for framework with framework code <code>$frameworkcode</code>, <code>$params</code> is optional and may contain additional options.</p>

<dl>
<dt><a name="$frameworkcode"
><code>$frameworkcode</code></a></dt>

<dd>
<p>The framework code.</p>

<dt><a name="$params"
><code>$params</code></a></dt>

<dd>
<p>An optional hash reference with additional options. The following options are supported:</p>

<dl>
<dt><a name="unsafe"
>unsafe</a></dt>

<dd>
<p>Pass { unsafe =&#62; 1 } do disable cached object cloning, and instead get a shared reference, resulting in better performance (but care must be taken so that retured object is never modified).</p>

<p>Note: If you call GetMarcSubfieldStructure with unsafe =&#62; 1, do not modify or even autovivify its contents. It is a cached/shared data structure. Your changes would be passed around in subsequent calls.</p>
</dd>
</dl>
</dd>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMarcFromKohaField"
>GetMarcFromKohaField</a></h2>

<pre>    ( $field,$subfield ) = GetMarcFromKohaField( $kohafield );
    @fields = GetMarcFromKohaField( $kohafield );
    $field = GetMarcFromKohaField( $kohafield );

    Returns the MARC fields &#38; subfields mapped to $kohafield.
    Since the Default framework is considered as authoritative for such
    mappings, the former frameworkcode parameter is obsoleted.

    In list context all mappings are returned; there can be multiple
    mappings. Note that in the above example you could miss a second
    mappings in the first call.
    In scalar context only the field tag of the first mapping is returned.</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMarcSubfieldStructureFromKohaField"
>GetMarcSubfieldStructureFromKohaField</a></h2>

<pre>    my $str = GetMarcSubfieldStructureFromKohaField( $kohafield );

    Returns marc subfield structure information for $kohafield.
    The Default framework is used, since it is authoritative for kohafield
    mappings.
    In list context returns a list of all hashrefs, since there may be
    multiple mappings. In scalar context the first hashref is returned.</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetXmlBiblio"
>GetXmlBiblio</a></h2>

<pre>  my $marcxml = GetXmlBiblio($biblionumber);</pre>

<p>Returns biblio_metadata.metadata/marcxml of the biblionumber passed in parameter. The XML should only contain biblio information (item information is no longer stored in marcxml field)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMarcPrice"
>GetMarcPrice</a></h2>

<p>return the prices in accordance with the Marc format.</p>

<p>returns 0 if no price found returns undef if called without a marc record or with an unrecognized marc format</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="MungeMarcPrice"
>MungeMarcPrice</a></h2>

<p>Return the best guess at what the actual price is from a price field.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMarcQuantity"
>GetMarcQuantity</a></h2>

<p>return the quantity of a book. Used in acquisition only, when importing a file an iso2709 from a bookseller Warning : this is not really in the marc standard. In Unimarc, Electre (the most widely used bookseller) use the 969$a</p>

<p>returns 0 if no quantity found returns undef if called without a marc record or with an unrecognized marc format</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetAuthorisedValueDesc"
>GetAuthorisedValueDesc</a></h2>

<pre>  my $subfieldvalue =get_authorised_value_desc(
    $tag, $subf[$i][0],$subf[$i][1], &#39;&#39;, $taglib, $category, $opac);</pre>

<p>Retrieve the complete description for a given authorised value.</p>

<p>Now takes $category and $value pair too.</p>

<pre>  my $auth_value_desc =GetAuthorisedValueDesc(
    &#39;&#39;,&#39;&#39;, &#39;DVD&#39; ,&#39;&#39;,&#39;&#39;,&#39;CCODE&#39;);</pre>

<p>If the optional $opac parameter is set to a true value, displays OPAC descriptions rather than normal ones when they exist.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMarcControlnumber"
>GetMarcControlnumber</a></h2>

<pre>  $marccontrolnumber = GetMarcControlnumber($record,$marcflavour);</pre>

<p>Get the control number / record Identifier from the MARC record and return it.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMarcISBN"
>GetMarcISBN</a></h2>

<pre>  $marcisbnsarray = GetMarcISBN( $record, $marcflavour );</pre>

<p>Get all ISBNs from the MARC record and returns them in an array. ISBNs stored in different fields depending on MARC flavour</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMarcISSN"
>GetMarcISSN</a></h2>

<pre>  $marcissnsarray = GetMarcISSN( $record, $marcflavour );</pre>

<p>Get all valid ISSNs from the MARC record and returns them in an array. ISSNs are stored in different fields depending on MARC flavour</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMarcSubjects"
>GetMarcSubjects</a></h2>

<pre>  $marcsubjcts = GetMarcSubjects($record,$marcflavour);</pre>

<p>Get all subjects from the MARC record and returns them in an array. The subjects are stored in different fields depending on MARC flavour</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMarcUrls"
>GetMarcUrls</a></h2>

<pre>  $marcurls = GetMarcUrls($record,$marcflavour);</pre>

<p>Returns arrayref of URLs from MARC data, suitable to pass to tmpl loop. Assumes web resources (not uncommon in MARC21 to omit resource type ind)</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetMarcSeries"
>GetMarcSeries</a></h2>

<pre>  $marcseriesarray = GetMarcSeries($record,$marcflavour);</pre>

<p>Get all series from the MARC record and returns them in an array. The series are stored in different fields depending on MARC flavour</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="UpsertMarcSubfield"
>UpsertMarcSubfield</a></h2>

<pre>    my $record = C4::Biblio::UpsertMarcSubfield($MARC::Record, $fieldTag, $subfieldCode, $subfieldContent);</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="UpsertMarcControlField"
>UpsertMarcControlField</a></h2>

<pre>    my $record = C4::Biblio::UpsertMarcControlField($MARC::Record, $fieldTag, $content);</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="GetFrameworkCode"
>GetFrameworkCode</a></h2>

<pre>  $frameworkcode = GetFrameworkCode( $biblionumber )</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="TransformKohaToMarc"
>TransformKohaToMarc</a></h2>

<pre>    $record = TransformKohaToMarc( $hash [, $params ]  )</pre>

<p>This function builds a (partial) MARC::Record from a hash. Hash entries can be from biblio, biblioitems or items. The params hash includes the parameter no_split used in C4::Items.</p>

<p>This function is called in acquisition module, to create a basic catalogue entry from user entry.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="PrepHostMarcField"
>PrepHostMarcField</a></h2>

<pre>    $hostfield = PrepHostMarcField ( $hostbiblionumber,$hostitemnumber,$marcflavour )</pre>

<p>This function returns a host field populated with data from the host record, the field can then be added to an analytical record</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="TransformHtmlToXml"
>TransformHtmlToXml</a></h2>

<pre>  $xml = TransformHtmlToXml( $tags, $subfields, $values, $indicator, 
                             $ind_tag, $auth_type )</pre>

<p>$auth_type contains :</p>

<dl>
<dt><a name="-_nothing_:_rebuild_a_biblio._In_UNIMARC_the_encoding_is_in_100$a_pos_26/27"
>- nothing : rebuild a biblio. In UNIMARC the encoding is in 100$a pos 26/27</a></dt>

<dd>
<dt><a name="-_UNIMARCAUTH_:_rebuild_an_authority._In_UNIMARC,_the_encoding_is_in_100$a_pos_13/14"
>- UNIMARCAUTH : rebuild an authority. In UNIMARC, the encoding is in 100$a pos 13/14</a></dt>

<dd>
<dt><a name="-_ITEM_:_rebuild_an_item_:_in_UNIMARC,_100$a,_it&#39;s_in_the_biblio_!_(otherwise,_we_would_get_2_100_fields_!)"
>- ITEM : rebuild an item : in UNIMARC, 100$a, it&#39;s in the biblio ! (otherwise, we would get 2 100 fields !)</a></dt>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_default_ind_to_space"
>_default_ind_to_space</a></h2>

<p>Passed what should be an indicator returns a space if its undefined or zero length</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="TransformHtmlToMarc"
>TransformHtmlToMarc</a></h2>

<pre>    L&#60;$record&#62; = TransformHtmlToMarc(L&#60;$cgi&#62;)
    L&#60;$cgi&#62; is the CGI object which contains the values for subfields
    {
        &#39;tag_010_indicator1_531951&#39; ,
        &#39;tag_010_indicator2_531951&#39; ,
        &#39;tag_010_code_a_531951_145735&#39; ,
        &#39;tag_010_subfield_a_531951_145735&#39; ,
        &#39;tag_200_indicator1_873510&#39; ,
        &#39;tag_200_indicator2_873510&#39; ,
        &#39;tag_200_code_a_873510_673465&#39; ,
        &#39;tag_200_subfield_a_873510_673465&#39; ,
        &#39;tag_200_code_b_873510_704318&#39; ,
        &#39;tag_200_subfield_b_873510_704318&#39; ,
        &#39;tag_200_code_e_873510_280822&#39; ,
        &#39;tag_200_subfield_e_873510_280822&#39; ,
        &#39;tag_200_code_f_873510_110730&#39; ,
        &#39;tag_200_subfield_f_873510_110730&#39; ,
    }
    L&#60;$record&#62; is the MARC::Record object.</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="TransformMarcToKoha"
>TransformMarcToKoha</a></h2>

<pre>    $result = TransformMarcToKoha({ record =&#62; $record, limit_table =&#62; $limit })</pre>

<p>Extract data from a MARC bib record into a hashref representing Koha biblio, biblioitems, and items fields.</p>

<p>If passed an undefined record will log the error and return an empty hash_ref.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_disambiguate"
>_disambiguate</a></h2>

<pre>  $newkey = _disambiguate($table, $field);</pre>

<p>This is a temporary hack to distinguish between the following sets of columns when using TransformMarcToKoha.</p>

<pre>  items.cn_source &#38; biblioitems.cn_source
  items.cn_sort &#38; biblioitems.cn_sort</pre>

<p>Columns that are currently NOT distinguished (FIXME due to lack of time to fully test) are:</p>

<pre>  biblio.notes and biblioitems.notes
  biblionumber
  timestamp
  biblioitemnumber</pre>

<p>FIXME - this is necessary because prefixing each column name with the table name would require changing lots of code and templates, and exposing more of the DB structure than is good to the UI templates, particularly since biblio and bibloitems may well merge in a future version. In the future, it would also be good to separate DB access and UI presentation field names more.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_adjust_pubyear"
>_adjust_pubyear</a></h2>

<pre>    Helper routine for TransformMarcToKoha</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="CountItemsIssued"
>CountItemsIssued</a></h2>

<pre>    my $count = CountItemsIssued( $biblionumber );</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ModZebra"
>ModZebra</a></h2>

<pre>    ModZebra( $record_number, $op, $server );</pre>

<p>$record_number is the authid or biblionumber we want to index</p>

<p>$op is the operation: specialUpdate or recordDelete</p>

<p>$server is authorityserver or biblioserver</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="INTERNAL_FUNCTIONS"
>INTERNAL FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_koha_marc_update_bib_ids"
>_koha_marc_update_bib_ids</a></h2>

<pre>  _koha_marc_update_bib_ids($record, $frameworkcode, $biblionumber, $biblioitemnumber);</pre>

<p>Internal function to add or update biblionumber and biblioitemnumber to the MARC XML.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_koha_marc_update_biblioitem_cn_sort"
>_koha_marc_update_biblioitem_cn_sort</a></h2>

<pre>  _koha_marc_update_biblioitem_cn_sort($marc, $biblioitem, $frameworkcode);</pre>

<p>Given a MARC bib record and the biblioitem hash, update the subfield that contains a copy of the value of biblioitems.cn_sort.</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_koha_modify_biblio"
>_koha_modify_biblio</a></h2>

<pre>  my ($biblionumber,$error) == _koha_modify_biblio($dbh,$biblio,$frameworkcode);</pre>

<p>Internal function for updating the biblio table</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_koha_modify_biblioitem_nonmarc"
>_koha_modify_biblioitem_nonmarc</a></h2>

<pre>  my ($biblioitemnumber,$error) = _koha_modify_biblioitem_nonmarc( $dbh, $biblioitem );</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_koha_delete_biblio"
>_koha_delete_biblio</a></h2>

<pre>  $error = _koha_delete_biblio($dbh,$biblionumber);</pre>

<p>Internal sub for deleting from biblio table -- also saves to deletedbiblio</p>

<p><code>$dbh</code> - the database handle</p>

<p><code>$biblionumber</code> - the biblionumber of the biblio to be deleted</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_koha_delete_biblioitems"
>_koha_delete_biblioitems</a></h2>

<pre>  $error = _koha_delete_biblioitems($dbh,$biblioitemnumber);</pre>

<p>Internal sub for deleting from biblioitems table -- also saves to deletedbiblioitems</p>

<p><code>$dbh</code> - the database handle <code>$biblionumber</code> - the biblioitemnumber of the biblioitem to be deleted</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_koha_delete_biblio_metadata"
>_koha_delete_biblio_metadata</a></h2>

<pre>  $error = _koha_delete_biblio_metadata($biblionumber);</pre>

<p><code>$biblionumber</code> - the biblionumber of the biblio metadata to be deleted</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="UNEXPORTED_FUNCTIONS"
>UNEXPORTED FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ModBiblioMarc"
>ModBiblioMarc</a></h2>

<pre>  ModBiblioMarc($newrec,$biblionumber);</pre>

<p>Add MARC XML data for a biblio to koha</p>

<p>Function exported, but should NOT be used, unless you really know what you&#39;re doing</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="prepare_host_field"
>prepare_host_field</a></h2>

<p>$marcfield = prepare_host_field( $hostbiblioitem, $marcflavour ); Generate the host item entry for an analytic child entry</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="UpdateTotalIssues"
>UpdateTotalIssues</a></h2>

<pre>  UpdateTotalIssues($biblionumber, $increase, [$value])</pre>

<p>Update the total issue count for a particular bib record.</p>

<dl>
<dt><a name="$biblionumber_is_the_biblionumber_of_the_bib_to_update"
><code>$biblionumber</code> is the biblionumber of the bib to update</a></dt>

<dd>
<dt><a name="$increase_is_the_amount_to_increase_(or_decrease)_the_total_issues_count_by"
><code>$increase</code> is the amount to increase (or decrease) the total issues count by</a></dt>

<dd>
<dt><a name="$value_is_the_absolute_value_that_total_issues_count_should_be_set_to._If_provided,_$increase_is_ignored."
><code>$value</code> is the absolute value that total issues count should be set to. If provided, <code>$increase</code> is ignored.</a></dt>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="RemoveAllNsb"
>RemoveAllNsb</a></h2>

<pre>    &#38;RemoveAllNsb($record);</pre>

<p>Removes all nsb/nse chars from a record</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="ApplyMarcOverlayRules"
>ApplyMarcOverlayRules</a></h2>

<pre>    my $record = ApplyMarcOverlayRules($params)</pre>

<p>Applies marc merge rules to a record.</p>

<p><code>$params</code> is expected to be a hashref with below keys defined.</p>

<dl>
<dt><a name="biblionumber_biblionumber_of_old_record"
><code>biblionumber</code> biblionumber of old record</a></dt>

<dd>
<dt><a name="record_Incoming_record_that_will_be_merged_with_old_record"
><code>record</code> Incoming record that will be merged with old record</a></dt>

<dd>
<dt><a name="overlay_context_hashref_containing_at_least_one_context_module_and_filter_value_on_the_form_{module_=&#62;_filter,_...}."
><code>overlay_context</code> hashref containing at least one context module and filter value on the form {module =&#62; filter, ...}.</a></dt>
</dl>

<p>Returns:</p>

<dl>
<dt><a name="$record"
><code>$record</code></a></dt>

<dd>
<p>Merged MARC record based with merge rules for <code>context</code> applied. If no old record for <code>biblionumber</code> can be found, <code>record</code> is returned unchanged. Default action when no matching context is found to return <code>record</code> unchanged. If no rules are found for a certain field tag the default is to overwrite with fields with this field tag from <code>record</code>.</p>
</dd>
</dl>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_after_biblio_action_hooks"
>_after_biblio_action_hooks</a></h2>

<p>Helper method that takes care of calling all plugin hooks</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="AUTHOR"
>AUTHOR</a></h1>

<p>Koha Development Team &#60;http://koha-community.org/&#62;</p>

<p>Paul POULAIN paul.poulain@free.fr</p>

<p>Joshua Ferraro jmf@liblime.com</p>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
