<html><head><title>C4::Auth_with_shibboleth</title>

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçÉ</text></svg>" />

<link rel="stylesheet" href="../sub.css">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" title="blkbluw" type="text/css" href="../_blkbluw.css" media="all" >
<link rel="alternate stylesheet" title="blkmagw" type="text/css" href="../_blkmagw.css" media="all" >
<link rel="alternate stylesheet" title="blkcynw" type="text/css" href="../_blkcynw.css" media="all" >
<link rel="alternate stylesheet" title="whtprpk" type="text/css" href="../_whtprpk.css" media="all" >
<link rel="alternate stylesheet" title="whtnavk" type="text/css" href="../_whtnavk.css" media="all" >
<link rel="alternate stylesheet" title="grygrnk" type="text/css" href="../_grygrnk.css" media="all" >
<link rel="alternate stylesheet" title="whtgrng" type="text/css" href="../_whtgrng.css" media="all" >
<link rel="alternate stylesheet" title="blkgrng" type="text/css" href="../_blkgrng.css" media="all" >
<link rel="alternate stylesheet" title="grygrnw" type="text/css" href="../_grygrnw.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../_whtpurk.css" media="all" >
<link rel="alternate stylesheet" title="whtpurk" type="text/css" href="../_whtpurk.css" media="all" >

<script type="text/javascript" src="../_podly.js"></script>

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.42,
  using Pod::Simple::PullParser v3.42,
  under Perl v5.034000 at Fri Aug 11 00:22:02 2023 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<p class="backlinktop"><b><a name="___top" href="../index.html" accesskey="1" title="All Documents">&lt;&lt;</a></b></p>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#SYNOPSIS'>SYNOPSIS</a>
  <li class='indexItem indexItem1'><a href='#DESCRIPTION'>DESCRIPTION</a>
  <li class='indexItem indexItem1'><a href='#CONFIGURATION'>CONFIGURATION</a>
  <li class='indexItem indexItem1'><a href='#FUNCTIONS'>FUNCTIONS</a>
  <ul   class='indexList indexList2'>
    <li class='indexItem indexItem2'><a href='#logout_shib'>logout_shib</a>
    <li class='indexItem indexItem2'><a href='#login_shib_url'>login_shib_url</a>
    <li class='indexItem indexItem2'><a href='#get_login_shib'>get_login_shib</a>
    <li class='indexItem indexItem2'><a href='#checkpw_shib'>checkpw_shib</a>
    <li class='indexItem indexItem2'><a href='#_get_uri'>_get_uri</a>
    <li class='indexItem indexItem2'><a href='#_get_shib_config'>_get_shib_config</a>
    <li class='indexItem indexItem2'><a href='#_autocreate'>_autocreate</a>
  </ul>
  <li class='indexItem indexItem1'><a href='#SEE_ALSO'>SEE ALSO</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>C4::Auth_with_shibboleth</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SYNOPSIS"
>SYNOPSIS</a></h1>

<p>use C4::Auth_with_shibboleth;</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="DESCRIPTION"
>DESCRIPTION</a></h1>

<p>This module is specific to Shibboleth authentication in koha and relies heavily upon the native shibboleth service provider package in your operating system.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="CONFIGURATION"
>CONFIGURATION</a></h1>

<p>To use this type of authentication these additional packages are required:</p>

<ul>
<li>libapache2-mod-shib2</li>

<li>libshibsp5:amd64</li>

<li>shibboleth-sp2-schemas</li>
</ul>

<p>We let the native shibboleth service provider packages handle all the complexities of shibboleth negotiation for us,
and configuring this is beyond the scope of this documentation.</p>

<p>But to sum up,
to get shibboleth working in koha,
as a minimum you will need to:</p>

<ol>
<li>Create some metadata for your koha instance (if you&#39;re in a single instance setup then the default metadata available at https://youraddress.com/Shibboleth.sso/Metadata should be adequate)</li>

<li>Swap metadata with your Identidy Provider (IdP)</li>

<li>Map their attributes to what you want to see in koha</li>

<li>Tell apache that we wish to allow koha to authenticate via shibboleth.
<p>This is as simple as adding the below to your virtualhost config (for CGI running):</p>

<pre> &#60;Location /&#62;
   AuthType shibboleth
   Require shibboleth
 &#60;/Location&#62;</pre>

<p>Or (for Plack running):</p>

<pre> &#60;Location /&#62;
   AuthType shibboleth
   Require shibboleth
   ShibUseEnvironment Off
   ShibUseHeaders On
 &#60;/Location&#62;</pre>

<p>IMPORTANT: Please note, if you are running in the plack configuration you should consult https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPSpoofChecking for security advice regarding header spoof checking settings. (See also bug 17776 on Bugzilla about enabling ShibUseHeaders.)</p>
</li>

<li>Configure koha to listen for shibboleth environment variables.
<p>This is as simple as enabling <b>useshibboleth</b> in koha-conf.xml:</p>

<pre> &#60;useshibboleth&#62;1&#60;/useshibboleth&#62;</pre>
</li>

<li>Map shibboleth attributes to koha fields, and configure authentication match point in koha-conf.xml.
<pre> &#60;shibboleth&#62;
   &#60;matchpoint&#62;userid&#60;/matchpoint&#62; &#60;!-- koha borrower field to match upon --&#62;
   &#60;mapping&#62;
     &#60;userid is=&#34;eduPersonID&#34;&#62;&#60;/userid&#62; &#60;!-- koha borrower field to shibboleth attribute mapping --&#62;
   &#60;/mapping&#62;
 &#60;/shibboleth&#62;</pre>

<p>Note: The minimum you need here is a &#60;matchpoint&#62; block, containing a valid column name from the koha borrowers table, and a &#60;mapping&#62; block containing a relation between the chosen matchpoint and the shibboleth attribute name.</p>
</li>
</ol>

<p>It should be as simple as that; you should now be able to login via shibboleth in the opac.</p>

<p>If you need more help configuring your <b>S</b>ervice <b>P</b>rovider to authenticate against a chosen <b>Id</b>entity <b>P</b>rovider then it might be worth taking a look at the community wiki <a href="http://wiki.koha-community.org/wiki/Shibboleth_Configuration" class="podlinkurl"
>page</a></p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="FUNCTIONS"
>FUNCTIONS</a></h1>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="logout_shib"
>logout_shib</a></h2>

<p>Sends a logout signal to the native shibboleth service provider and then logs out of koha. Depending upon the native service provider configuration and identity provider capabilities this may or may not perform a single sign out action.</p>

<pre>  logout_shib($query);</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="login_shib_url"
>login_shib_url</a></h2>

<p>Given a query, this will return a shibboleth login url with return code to page with given given query.</p>

<pre>  my $shibLoginURL = login_shib_url($query);</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="get_login_shib"
>get_login_shib</a></h2>

<p>Returns the shibboleth login attribute should it be found present in the http session</p>

<pre>  my $shib_login = get_login_shib();</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="checkpw_shib"
>checkpw_shib</a></h2>

<p>Given a shib_login attribute, this routine checks for a matching local user and if found returns true, their cardnumber and their userid. If a match is not found, then this returns false.</p>

<pre>  my ( $retval, $retcard, $retuserid ) = C4::Auth_with_shibboleth::checkpw_shib( $shib_login );</pre>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_get_uri"
>_get_uri</a></h2>

<pre>  _get_uri();</pre>

<p>A sugar function to that simply returns the current page URI with appropriate protocol attached</p>

<p>This routine is NOT exported</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_get_shib_config"
>_get_shib_config</a></h2>

<pre>  my $config = _get_shib_config();</pre>

<p>A sugar function that checks for a valid shibboleth configuration, and if found returns a hashref of it&#39;s contents</p>

<p>This routine is NOT exported</p>

<h2><a class='u' href='#___top' title='click to go to top of document'
name="_autocreate"
>_autocreate</a></h2>

<pre>  my ( $retval, $retcard, $retuserid ) = _autocreate( $config, $match );</pre>

<p>Given a shibboleth attribute reference and a userid this internal routine will add the given user to Koha and return their user credentials.</p>

<p>This routine is NOT exported</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SEE_ALSO"
>SEE ALSO</a></h1>
<p class="backlinkbottom"><b><a name="___bottom" href="../index.html" title="All Documents">&lt;&lt;</a></b></p>

<!-- end doc -->

</body></html>
